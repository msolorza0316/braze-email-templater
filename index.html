
<style>
  .be-wrap{max-width:980px;margin:0 auto;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .be-header{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#0f172a;color:#fff;border-radius:0 0 12px 12px;box-shadow:0 4px 12px rgba(0,0,0,.15)}
  .be-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .be-btn{appearance:none;border:1px solid #334155;background:#111827;color:#fff;padding:8px 12px;border-radius:8px;font-size:14px;cursor:pointer;white-space:nowrap}
  .be-btn.secondary{background:#fff;color:#111827;border-color:#cbd5e1}
  .be-badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1d4ed8}
  .be-info{font-size:12px;color:#475569;margin:10px 4px 18px}
  .be-clip{border-top:1px dashed #e2e8f0;margin:16px 0;padding-top:8px;color:#64748b;font-size:12px}

  #preview{border:1px solid #e5e7eb;border-radius:12px;min-height:60vh;background:#fff;padding:8px}
  .be-block{position:relative;padding-top:18px;margin:6px 0}
  .be-label{position:absolute;left:8px;top:0;display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:2px 8px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px}
  .dot{width:6px;height:6px;background:#1d4ed8;border-radius:999px}
  .be-block-toolbar{position:absolute;right:6px;top:-6px;display:flex;gap:6px;z-index:10}
  .be-ico{background:#0b1220;color:#fff;border:1px solid #1f2a44;border-radius:8px;padding:4px 8px;font-size:12px;cursor:pointer}
  .be-ico[disabled]{opacity:.4;cursor:not-allowed}
  .be-handle{cursor:grab}
  .dragging{opacity:.6;outline:2px dashed #93c5fd}

  .be-placeholder{height:18px;margin:6px 0;border:2px dashed #93c5fd;border-radius:10px;background:#eff6ff}

  /* Floating ghost while sorting */
  .be-ghost{position:fixed;left:0;top:0;pointer-events:none;opacity:.9;box-shadow:0 12px 24px rgba(0,0,0,.15);z-index:9998;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
  .be-ghost-inner{transform:scale(.98); transform-origin:top left}
  .be-label, .be-block-toolbar, .be-block-toolbar *{contenteditable:false !important;}
</style>
<div class="be-wrap">
<div class="main-header" style="position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:8px;display:flex;gap:12px;align-items:center;z-index:80;">
<div><strong>Braze Email Editor</strong></div>
<div class="be-actions">
<span class="be-badge" id="be-count">0 blocks</span>
<span class="be-addmenu">
        Add:
        <button class="be-btn secondary" id="add-partner" style="background:#005bfb;border:1px solid #005bfb;color:#fff;">Partner</button>
<button class="be-btn secondary" id="add-primary" style="background:#005bfb;border:1px solid #005bfb;color:#fff;">Primary</button>
<button class="be-btn secondary" id="add-secondary" style="background:#005bfb;border:1px solid #005bfb;color:#fff;">Secondary</button>
</span>
<label class="be-toggle"><input checked="" id="be-clean-paste" type="checkbox"/> Clean paste</label>
<button class="be-btn secondary" id="be-reset" style="background:#005bfb;border:1px solid #005bfb;color:#fff;" type="button">Reset</button>
</div>
</div>
<div class="be-info">Drag by ⋮⋮ (pure mouse-based). Spacers ride with blocks. Header (Rows 1–4) grouped &amp; locked. Edit inline; clean paste strips fonts only.</div>
<div class="be-header" style="background:#fff;border-bottom:1px solid #eee;padding:8px;display:flex;gap:12px;align-items:center;z-index:80;position:relative;"><div style="font:600 14px/1.2 system-ui,Segoe UI,Arial,sans-serif;">Braze Email Editor</div><div class="be-header" id="editor-actions" style="background:#fff;border-bottom:1px solid #eee;padding:8px;display:flex;gap:8px;align-items:center;z-index:50;position:relative;"><button class="be-btn" id="import-docx" style="padding:8px 12px;border-radius:8px;cursor:pointer;background:#005bfb;border:1px solid #005bfb;color:#fff;">Import DOCX</button><input accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document,.html,text/html,.htm,.txt,text/plain" id="docx-file" style="display:none" type="file"/><button class="be-btn" id="be-export" style="padding:8px 12px;border-radius:8px;cursor:pointer;background:#005bfb;border:1px solid #005bfb;color:#fff;">Export HTML</button></div></div><div id="preview"><!DOCTYPE html>

<html lang="en" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:v="urn:schemas-microsoft-com:vml">
<head>
<title></title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><meta content="width=device-width,initial-scale=1" name="viewport"/>
<style type="text/css">/* ===== Base resets ===== */
    html, body { margin:0; padding:0; height:100%; background:#fff; }
    * { box-sizing: border-box; }
    img { border:0; line-height:100%; outline:none; text-decoration:none; }
    table { mso-table-lspace:0; mso-table-rspace:0; }
    p { margin:0; }
    a[x-apple-data-detectors] { color:inherit !important; text-decoration:inherit !important; }
    #MessageViewBody a { color:inherit; text-decoration:none; }
    sub, sup { font-size:75%; line-height:0; }
    .desktop_hide, .desktop_hide table { mso-hide:all; display:none; max-height:0; overflow:hidden; }

    /* Handle Gmail/Outlook emoji-as-image substitutions */
    img[data-emoji],
    img.emoji,
    img[class*="emoji"],
    img[src*="emoji"],
    img[src*="twemoji"],
    img[src*="noto"] {
      display:inline !important;
      height:1em !important;
      width:1em !important;
      margin:0 .15em 0 0 !important;
      vertical-align:middle !important;
    }

    img[data-emoji] {
      display:inline !important;
      height:1em !important;
      width:1em !important;
      margin:0 .1em 0 .1em !important;
      vertical-align: middle !important;
    }

    /* ===== Layout ===== */
    .nl-container { width:100%; background:#fff; }
    .row { width:100%; }
    .container { width:685px; margin:0 auto; }
    .bg-white { background:#fff; }
    .bg-black { background:#000; }
    .bg-cream { background:#f7f6ec; }
    .text-dark { color:#232021; }
    .text-white { color:#fff; }
    .text-center { text-align:center; }
    .text-left { text-align:left; }
    .fw-400 { font-weight:400; }
    .fs-12 { font-size:12px; }
    .fs-14 { font-size:14px; }
    .fs-16 { font-size:16px; }
    .fs-18 { font-size:18px; }
    .fs-20 { font-size:20px; }
    .fs-24 { font-size:24px; }
    .link-blue { color:#1d53ff; text-decoration:underline; }
    .rounded-22 { border-radius:22px; }
    .rounded-20b { border-radius:0 0 20px 20px; }
    .card { border:2px; border-color:#232021; border-style:solid; border-radius:22px; }
    .w-100 { width:100%; }
    .fullWidth { max-width:685px; }
    .m-auto { margin:0 auto; }
		.block { display:block; }

    /* ===== Spacing utilities ===== */
    .p-0 { padding:0; }
    .px-25 { padding-left:25px; padding-right:25px; }
    .py-5  { padding-top:5px; padding-bottom:5px; }
    .py-20 { padding-top:20px; padding-bottom:20px; }
    .pt-5 { padding-top:5px; }
    .pt-20 { padding-top:20px; }
    .pb-20 { padding-bottom:20px; }
    .pb-5 { padding-bottom:5px; }
    .px-10 { padding-left:10px; padding-right:10px; }

    .spacer-0 { line-height:0; font-size:1px; height:0; }
    .spacer-20 { line-height:20px; font-size:1px; height:20px; }

    /* ===== Email-friendly typography ===== */
    .font-sans { font-family: Helvetica, Arial, Sans-serif; }
    .font-roboto { font-family: Roboto, Helvetica, Arial, Sans-serif; }

    /* === Line-height rules === */
    p, li, a { line-height:1.2 !important; }
    .lh-100 { line-height:1 !important; }

    /* ===== Lists ===== */
    .list { margin:0; padding-left:20px; }
    .list li { margin:0 0 10px 0; }

    /* Mobile */
    @media (max-width:705px){
      .container { width:100% !important; }
      .mobile_hide { display:none !important; }
      .desktop_hide, .desktop_hide table { display:table !important; max-height:none !important; }
      .fullWidth { max-width:100% !important; }
    }

    /* Outlook line-height for sup/sub */
    
	</style>
<script>
window.ensureMammoth = function(){
  if (window.mammoth) return Promise.resolve();
  return new Promise(function(resolve, reject){
    var s=document.createElement('script');
    s.src='https://unpkg.com/mammoth/mammoth.browser.min.js';
    s.async=true;
    s.onload=function(){ resolve(); };
    s.onerror=function(){ reject(new Error('Failed to load Mammoth.js')); };
    document.head.appendChild(s);
  });
};
</script><style>.be-target-body:focus{ outline:1px dashed #999 }</style><style>.be-target-body[contenteditable="true"]{display:block;}
.be-target-body[contenteditable="true"]:focus{outline:1px dashed #999}</style>
<style id="card-font-fix">
/* Ensure all editor cards use the same font as intended (partner card already OK) */
.be-target-body,
.be-target-body * {
  font-family: system-ui, Segoe UI, Helvetica, Arial, sans-serif !important;
}
</style>

<style id="hoverguard-css">
/* While interacting with the header, disable pointer events on the preview.
   This prevents click-through without any JS. Adjust the selector if your
   preview container has a different id than #preview. */
.be-header:hover ~ #preview,
.be-header:focus-within ~ #preview {
  pointer-events: none !important;
}
/* Keep header controls from selecting text */
.be-header, .be-header * {
  user-select: none; -webkit-user-select: none;
}
</style>
</head>
<body class="font-roboto text-dark">
<table cellpadding="0" cellspacing="0" class="nl-container card" contenteditable="false" role="presentation" width="100%">
<tbody>
<tr>
<td><!-- Row 1: Hero banner -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-white" role="presentation" width="685">
<tbody>
<tr>
<td class="p-0"><a href="https://www.finder.com/?lid=iah99qj81fjx" target="_blank"><img alt="Investing newsletter banner" class="w-100 block" src="https://braze-images.com/appboy/communication/assets/image_assets/images/67fff87efa2b5f0062e20276/original.png?1744828542" title="Investing newsletter banner" width="685"/> </a>
<div class="spacer-0"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Row 2: Date bar -->
<table align="center" border="0" cellpadding="0" cellspacing="0" class="row row-2" role="presentation" style="mso-table-lspace:0;mso-table-rspace:0" width="100%">
<tbody>
<tr>
<td>
<table align="center" border="0" cellpadding="0" cellspacing="0" class="row-content" role="presentation" style="mso-table-lspace:0;mso-table-rspace:0;background-color:#000;color:#000;width:685px;margin:0 auto" width="685">
<tbody>
<tr>
<td class="column column-1" style="mso-table-lspace:0;mso-table-rspace:0;font-weight:400;text-align:left;padding-bottom:5px;vertical-align:top" width="100%">
<table border="0" cellpadding="0" cellspacing="0" class="text_block block-1" role="presentation" style="mso-table-lspace:0;mso-table-rspace:0;word-break:break-word" width="100%">
<tbody>
<tr>
<td class="pad" style="padding-left:25px;padding-right:25px">
<div style="font-family:sans-serif">
<div style="font-size:12px;font-family:Helvetica,Arial,Sans-serif;mso-line-height-alt:14.4px;color:#fff;line-height:1.2">
<p class="lh-100" style="margin:0;font-size:18px;text-align:center;mso-line-height-alt:21.6px"><span style="word-break: break-word; font-size: 14px;"><em><strong>{{ 'now' | date: '%B %d, %Y' }}</strong></em> </span></p>
</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="spacer_block block-2" style="height:0;line-height:0;font-size:1px"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Row 3: Author banner -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-white" role="presentation" width="685">
<tbody>
<tr>
<td class="p-0"><a href="https://www.finder.com/author/matthewmiczulski?lid=9kb449cv3awi" target="_blank"><img alt="Matt Miczulski author bio" class="w-100" src="https://braze-images.com/appboy/communication/assets/image_assets/images/67ffc9185073dd006594b6c3/original.png?1744816408" title="Matt Miczulski author bio" width="685"/> </a>
<div class="spacer-0"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Row 4: Rounded footer spacer under author banner (visual cap) -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-white rounded-20b" role="presentation" width="685">
<tbody>
<tr>
<td class="p-0">
<div class="spacer-0"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Spacer -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table class="container" role="presentation" width="685">
<tbody>
<tr>
<td>
<div class="spacer-20"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Row 8: Intro blurb card -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-white card" contenteditable="false" role="presentation" width="685"><tbody><tr><td class="px-25 py-20"><div class="be-target-body" contenteditable="true" data-editable="card">
<p class="font-sans fs-16">A big BLS jobs revision could reveal a cooler labor market than headlines suggest, small business optimism is creeping higher, and gold just notched a fresh record on Fed cut bets. Here’s what to watch before the bell.</p>
</div></td></tr></tbody></table>
</td>
</tr>
</tbody>
</table>
<!-- Spacer -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table class="container" role="presentation" width="685">
<tbody>
<tr>
<td>
<div class="spacer-20"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Row 10: Today's stories card -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-cream card" contenteditable="false" role="presentation" width="685"><tbody><tr><td class="px-25 py-20"><div class="be-target-body" contenteditable="true" data-editable="card">
<p class="font-sans fs-16 text-dark lh-100"><strong>Today's stories:</strong></p><br/>
<ul class="font-sans list fs-16 text-dark">
<li>US jobs revision could reveal weaker labor market</li>
<li>Small business optimism ticks up in August</li>
<li>Gold hits a record on Fed rate cut expectations</li>
</ul>
<p class="font-sans fs-16 text-dark lh-100"><strong>Plus:</strong></p><br/>
<ul class="font-sans list fs-16 text-dark">
<li>Earnings roundup</li>
<li>Key movers</li>
</ul>
</div></td></tr></tbody></table>
</td>
</tr>
</tbody>
</table>
<!-- Spacer -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table class="container" role="presentation" width="685">
<tbody>
<tr>
<td>
<div class="spacer-20"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Row 12: Story 1 card -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-white card" contenteditable="false" role="presentation" width="685"><tbody><tr><td class="px-25 pb-20 py-20"><div class="be-target-body" contenteditable="true" data-editable="card">
<p class="font-sans fs-20 text-dark lh-100" style="word-break: break-word"><strong>📉 US jobs revision could reveal weaker labor market</strong></p><p class="font-sans fs-20 text-dark lh-100"><strong><br/></strong></p>
<p class="font-sans fs-16 text-dark"><strong>What happened: </strong>The BLS is set to release a <a class="link-blue" href="https://www.reuters.com/world/us/us-job-growth-through-march-expected-be-revised-down-sharply-2025-09-09/?lid=xkjjjf564kw4">preliminary benchmark revision</a> that could cut US job growth for the 12 months through March 2025 by <strong>400,000–1,000,000</strong> jobs. The revision follows a soft August print and comes as tariffs and AI adoption reshape labor demand. Last year’s revision cut 818,000 jobs.</p>
<p class="font-sans fs-16 text-dark lh-100"><strong>Key takeaways:</strong></p><br/>
<ul class="font-sans list fs-16 text-dark">
<li>Revision could lower monthly 2024 job growth toward ~100,000 from 165,000.</li>
<li>Tariffs and AI adoption are curbing labor demand as immigration tightens supply.</li>
<li>Signals a cooler labor market heading into year-end.</li>
</ul>
									 

									<p class="font-sans fs-16 text-dark"><strong>Why it matters:</strong> A weaker labor market can pressure consumer stocks and stoke slowdown fears. Expect more focus on Fed policy and potential shifts toward defensive sectors like utilities or health.</p>
</div></td></tr></tbody></table>
</td>
</tr>
</tbody>
</table>
<!-- Spacer -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table class="container" role="presentation" width="685">
<tbody>
<tr>
<td>
<div class="spacer-20"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Row 14: Story 2 card -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-white card" contenteditable="false" role="presentation" width="685"><tbody><tr><td class="px-25 pb-20 py-20"><div class="be-target-body" contenteditable="true" data-editable="card">
<p class="font-sans fs-20 text-dark lh-100"><strong>🏪 Small business optimism rises slightly in August</strong></p><p class="font-sans fs-20 text-dark lh-100"><strong><br/></strong></p>
<p class="font-sans fs-16 text-dark"><strong>What happened:</strong> The <a class="link-blue" href="https://www.nfib.com/news/press-release/new-nfib-survey-small-business-optimism-improves-again/?lid=4nuudkkcne1z">NFIB Small Business Optimism Index</a> edged up <strong>0.5</strong> to <strong>100.8</strong>, beating expectations and topping the 52-year average of 98. Owners citing labor quality as their top problem held at <strong>21%</strong>, with <strong>32%</strong> reporting unfilled openings. Borrowing costs eased as short-term loan rates dipped to <strong>8.1%</strong>, the lowest since May 2023.</p>
<p class="font-sans fs-16 text-dark lh-100"><strong>Key takeaways:</strong></p><br/>
<ul class="font-sans list fs-16 text-dark">
<li>Sales expectations improved — net <strong>+12%</strong> now expect higher real sales.</li>
<li>Labor quality remains the top headache for owners.</li>
<li>Easier borrowing helps, but hiring frictions persist.</li>
</ul>
									 

									<p class="font-sans fs-16 text-dark"><strong>Why it matters:</strong> Small business resilience supports Main Street spending and small-cap sentiment, but hiring and wage pressures can cap margins. Watch labor and credit trends for read-throughs to local economies.</p>
</div></td></tr></tbody></table>
</td>
</tr>
</tbody>
</table>
<!-- Spacer -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table class="container" role="presentation" width="685">
<tbody>
<tr>
<td>
<div class="spacer-20"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Row 16: Story 3 card -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-white card" contenteditable="false" role="presentation" width="685"><tbody><tr><td class="px-25 pb-20 py-20"><div class="be-target-body" contenteditable="true" data-editable="card">
<p class="font-sans fs-20 text-dark lh-100"><strong>🥇 Gold hits a record on Fed rate cut expectations</strong></p><p class="font-sans fs-20 text-dark lh-100"><strong><br/></strong></p>
<p class="font-sans fs-16 text-dark"><strong>What happened:</strong> <a class="link-blue" href="https://www.reuters.com/world/india/gold-marches-fresh-record-high-propelled-by-fed-rate-cut-bets-2025-09-09/?lid=udsctr3u77q3">Spot gold</a> pushed to a new high near <strong>$3,659/oz</strong> as the dollar softened and yields fell with markets pricing an <strong>~88%</strong> chance of a 25 bp Fed cut next week. Some on Wall Street argue compromised Fed independence could turbo-charge flows into gold.</p>
<p class="font-sans fs-16 text-dark lh-100"><strong>Key takeaways:</strong></p><br/>
<ul class="font-sans list fs-16 text-dark">
<li>Gold is up ~39% in 2025 after a 27% gain in 2024.</li>
<li>A 1% shift out of Treasurys could push gold toward <strong>$5,000</strong>.</li>
<li>Flows into gold futures and value stocks show a safety tilt.</li>
</ul>
									 

									<p class="font-sans fs-16 text-dark"><strong>Why it matters:</strong> The rally flags policy and inflation jitters. For diversification, some look to gold ETFs like GLD or IAU — with the usual volatility caveats.</p>
</div></td></tr></tbody></table>
</td>
</tr>
</tbody>
</table>
<!-- Spacer -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table class="container" role="presentation" width="685">
<tbody>
<tr>
<td>
<div class="spacer-20"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Row 18: Earnings Roundup card -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-white card" contenteditable="false" role="presentation" width="685"><tbody><tr><td class="px-25 pb-20 py-20"><div class="be-target-body" contenteditable="true" data-editable="card">
<p class="font-sans fs-20 text-dark lh-100"><strong>Earnings roundup</strong></p><p class="font-sans fs-20 text-dark lh-100"><strong><br/></strong></p>
<p class="font-sans fs-16 text-dark">Today’s reports from Oracle, Synopsys, and GameStop will test cloud momentum, chip-design demand, and meme-stock vibes.</p><br/>
<ul class="font-sans list fs-16 text-dark">
<li><a class="link-blue" href="https://finance.yahoo.com/quote/ORCL/?lid=c7tppp869j7k"><strong>Oracle (ORCL)</strong></a>: Expected EPS <strong>$1.48</strong>, revenue <strong>$15.04B</strong> — a read on enterprise cloud and database demand.</li>
<li><a class="link-blue" href="https://finance.yahoo.com/quote/SNPS/?lid=x8rqy6o71ama"><strong>Synopsys (SNPS)</strong></a>: Expected EPS <strong>$3.75</strong>, revenue <strong>$1.77B</strong> — EDA software tied to semi design cycles.</li>
<li><a class="link-blue" href="https://finance.yahoo.com/quote/GME/?lid=t224xduzuekp"><strong>GameStop (GME)</strong></a>: Expected EPS <strong>$0.16</strong>, revenue <strong>$823.25M</strong> — retail enthusiasm meets physical gaming sales.</li>
</ul>
</div></td></tr></tbody></table>
</td>
</tr>
</tbody>
</table>
<!-- Spacer -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table class="container" role="presentation" width="685">
<tbody>
<tr>
<td>
<div class="spacer-20"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Row 20: Key Movers card -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-white card" contenteditable="false" role="presentation" width="685"><tbody><tr><td class="px-25 pb-20 py-20"><div class="be-target-body" contenteditable="true" data-editable="card">
<p class="font-sans fs-20 text-dark lh-100"><strong>Key movers</strong></p><p class="font-sans fs-20 text-dark lh-100"><br/></p>
<ul class="font-sans list fs-16 text-dark">
<li><strong>Wolfspeed (WOLF).</strong> Up <strong>63.41%</strong> at 8:45 a.m. ET after court approval of its Plan of Reorganization — the company expects to emerge from Chapter 11 in the coming weeks.</li>
<li><strong>Brighthouse Financial (BHF).</strong> Up <strong>13.67%</strong> at 8:45 a.m. ET on reports Aquarian is in late-stage talks with investors to finance its takeover bid.</li>
<li><strong>Atlassian (TEAM).</strong> Up <strong>6.67%</strong> at 8:45 a.m. ET as it sunsets Data Center deployments in favor of its Cloud platform.</li>
</ul>
</div></td></tr></tbody></table>
</td>
</tr>
</tbody>
</table>
<!-- Spacer -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table class="container" role="presentation" width="685">
<tbody>
<tr>
<td>
<div class="spacer-20"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Row 22: Meme of the Day card (left as-is per earlier layout) -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-white card" contenteditable="false" role="presentation" width="685"><tbody><tr><td class="px-25 pt-20 pb-20 py-20"><div class="be-target-body" contenteditable="true" data-editable="card">
<p class="font-sans fs-24 text-dark lh-100"><strong>Meme of the Day</strong></p>
<a class="m-auto" href="https://x.com/TrungTPhan/status/1960800893315768386?lid=x58kjvbhxk5c" target="_blank"><img alt="Meme of the Day" class="m-aut" src="https://braze-images.com/appboy/communication/assets/image_assets/images/68b1a46ccd76dd00958cc515/original.png?1756472427" style="width:100%; max-width:582px" title="Meme of the Day" width="100%"/> </a></div></td></tr></tbody></table>
</td>
</tr>
</tbody>
</table>
<!-- Spacer -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table class="container" role="presentation" width="685">
<tbody>
<tr>
<td>
<div class="spacer-20"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- ===== From Our Partners: SoFi (header) ===== -->
<table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace:0;mso-table-rspace:0;" width="100%">
<tbody>
<tr>
<td align="center"><div class="be-target-body" contenteditable="true" data-editable="card">
<table border="0" cellpadding="0" cellspacing="0" role="presentation" style="width:685px;max-width:100%;background-color:#1d53ff;border:2px solid #232021;border-radius:22px 22px 0 0;" width="685">
<tbody>
<tr>
<td style="padding:20px 25px 10px 25px;">
<p style="margin:0;font-family:Helvetica,Arial,sans-serif;font-size:20px;line-height:1.2;color:#ffffff;"><strong>👋 From Our Partners: SoFi<sup>®</sup></strong></p>
</td>
</tr>
</tbody>
</table>
</div></td>
</tr>
</tbody>
</table>
<!-- ===== From Our Partners: SoFi (card) ===== -->
<table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace:0;mso-table-rspace:0;" width="100%">
<tbody>
<tr>
<td align="center">
<table border="0" cellpadding="0" cellspacing="0" role="presentation" style="width:685px;max-width:100%;background-color:#ffffff;border:2px solid #232021;border-top:0;border-radius:0 0 22px 22px;" width="685">
<tbody>
<tr>
<td align="left" class="px-25 pb-20 py-20"><div class="be-target-body" contenteditable="true" data-editable="card">
<table border="0" cellpadding="0" cellspacing="0" role="presentation" width="100%">
<tbody>
<tr>
<td align="center" style="padding:0 0 20px 0;"><a href="https://www.finder.com/redirect/us/share-trading/sofi-invest-us-secure.html?nb=1&amp;silent=1&amp;lid=b8ctwnd2jncp" target="_blank"><img alt="SoFi logo" height="auto" src="https://braze-images.com/appboy/communication/assets/image_assets/images/6643b8b3490b30005ad78353/original.png?1715714226" style="display: block; border: 0px; height: auto; width: 103px; max-width: 100%; float: center;" width="103px"/> </a></td>
</tr>
<tr>
<td style="font-family:Helvetica,Arial,sans-serif;color:#232021;font-size:16px;line-height:1.4;">
<p style="margin:0 0 16px 0;"><a href="https://www.finder.com/redirect/us/share-trading/sofi-invest-us-secure.html?nb=1&amp;silent=1&amp;lid=oveqcf69bqko" rel="noopener" style="color:#1d53ff;text-decoration:underline;" target="_blank">SoFi Active Invest</a> gives investors access to stocks, ETFs and fractional shares — all inside an easy-to-use app that doubles as a financial hub.</p>
<p style="margin:0 0 8px 0;"><strong>Key takeaways:</strong></p><br/>
<ul style="margin:0 0 0 20px;padding:0;">
<li style="margin:0 0 10px 0;">Pay zero commission on stocks &amp; ETFs.<span style="font-size:12px;"><sup>1</sup></span></li>
<li style="margin:0 0 10px 0;">Buy a piece of your favorite company for as little as $5. Restrictions apply.<span style="font-size:12px;"><sup>2</sup></span></li>
<li style="margin:0;">Invest in alternatives including real estate, pre-IPO unicorns, commodities and private credit<span style="font-size:12px;"><sup>3</sup></span></li>
</ul>
<p style="margin:16px 0 0 0;"><strong>Why it matters: </strong>SoFi<sup>®</sup> is ideal for individuals who want to invest, bank and borrow from a single platform. Plus, <a href="https://www.finder.com/redirect/us/share-trading/sofi-invest-us-secure.html?nb=1&amp;silent=1&amp;lid=4ynjlriznveo" rel="noopener" style="color:#1d53ff;text-decoration:underline;" target="_blank">get up to $3,000 in stock</a> when you open &amp; fund a new Active Invest account. Valid until September 30, 2025.<span style="font-size:12px;"><sup>4</sup></span></p><br/>
</td>
</tr>
</tbody>
</table>
</div></td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Spacer -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table class="container" role="presentation" width="685">
<tbody>
<tr>
<td>
<div class="spacer-20"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Row 23: Subscribe CTA line -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-white" role="presentation" width="685">
<tbody>
<tr>
<td class="px-25">
<p class="font-sans fs-16 text-center"><em>Were you forwarded this email? <a class="link-blue" href="https://www.finder.com/market-briefing-subscribe?lid=ee01krp6ey1l" rel="noopener" target="_blank">Subscribe here</a>.</em></p>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- Spacer -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table class="container" role="presentation" width="685">
<tbody>
<tr>
<td>
<div class="spacer-20"> </div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace:0;mso-table-rspace:0;" width="100%">
<tr>
<td align="center">
<div class="be-block" data-label="Disclaimer" data-type="disclaimer"><div class="be-label"><span><span class="dot"></span> Disclaimer</span></div><div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico be-copy">Copy</button><button class="be-ico be-delete">Delete</button></div><table border="0" cellpadding="0" cellspacing="0" class="be-target-disclaimer" role="presentation" style="width:685px;max-width:100%;background-color:#f7f6ec;border-radius:12px;margin-top:12px;" width="685">
<tr>
<td style="padding:12px 10px;">
<div style="font-family:Helvetica,Arial,Sans-serif;font-size:12px;color:#232021;line-height:1.4;">
<p style="margin:0 0 8px 0;">Disclaimer: Finder is not an adviser or brokerage service. Information on this page is for educational purposes only and not a recommendation to invest with any one company, trade specific stocks or fund specific investments. <a href="https://www.finder.com/editorial-guidelines?lid=f6hapruky89z" style="color:#1d53ff;text-decoration:underline;">All editorial opinions are our own.</a></p>
<p style="margin:0 0 8px 0;">Finder receives compensation for the promotion of SoFi.</p>
<p style="margin:0 0 8px 0;">SoFi Disclaimers:</p>
<p style="margin:0 0 8px 0;"><strong>INVESTMENTS ARE NOT FDIC INSURED • ARE NOT BANK GUARANTEED • MAY LOSE VALUE</strong></p>
<p style="margin:0 0 8px 0;">Brokerage and Active investing products offered through SoFi Securities LLC, member FINRA(www.finra.org)/SIPC(www.sipc.org).</p>
<p style="margin:0 0 8px 0;"><sup>1</sup> Exchange Traded Funds (ETFs) may have their own management fees paid directly by the fund. Please consider these fees and objectives in the fund’s prospectus before investing.</p>
<p style="margin:0 0 8px 0;"><sup>2</sup> There are limitations with fractional shares to consider before investing. During market hours fractional share orders are transmitted immediately in the order received. There may be system delays from receipt of your order until execution and market conditions may adversely impact execution prices. Outside of market hours orders are received on a not held basis and will be aggregated for each security then executed in the morning trade window of the next business day at market open. Share will be delivered at an average price received for executing the securities through a single batched order. Fractional shares may not be transferred to another firm. Fractional shares will be sold when a transfer or closure request is initiated. Please consider that selling securities is a taxable event.</p>
<p style="margin:0 0 8px 0;"><sup>3</sup> Investing in alternative investments and/or strategies may not be suitable for all investors and involves unique risks, including the risk of loss. An investor should consider their individual circumstances and any investment information, such as a prospectus, prior to investing. Interval Funds are illiquid instruments, the ability to trade on your timeline may be restricted. Brokerage and Active investing products offered through SoFi Securities LLC, member FINRA(www.finra.org)/SIPC(www.sipc.org).</p>
<p style="margin:0;"><sup>4</sup> Offer valid from 9/15/25 through 9/30/25. Customer must fund their Active Invest account with at least $50 within 45 days of opening the account. Receive a minimum of $15. Probability of member receiving $3,000 is a probability of 0.026% If you don’t make a selection in 45 days, you’ll no longer qualify for the promo. Percentages for the $3,000 are subject to decrease. See <a href="https://www.sofi.com/invest/clawpromotion/rules?lid=y57ir6bf14tx" rel="noopener" style="color:#1d53ff;text-decoration:underline;" target="_blank">full terms and conditions</a>.</p>
</div>
</td>
</tr>
</table></div>
</td>
</tr>
</table>
<!-- Row 26: Dynamic content block -->
<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">
<tbody>
<tr>
<td>
<table cellpadding="0" cellspacing="0" class="container bg-white" role="presentation" width="685">
<tbody>
<tr>
<td class="pt-20 pb-5">
<div class="text-center font-roboto">{{content_blocks.${1US_disclaimer_market_briefing} | id: 'cb5'}}</div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<!-- End -->
<script>
(function(){
  // Run after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupFix, { once: true });
  } else {
    setupFix();
  }

  function setupFix(){
    const preview = document.getElementById('preview');
    if (!preview) return;

    // Replace buttons with clean clones to drop any older listeners
    function resetButton(id){
      const btn = document.getElementById(id);
      if (!btn) return null;
      const clone = btn.cloneNode(true);
      btn.replaceWith(clone);
      return clone;
    }

    const addPrimary   = resetButton('add-primary');
    const addSecondary = resetButton('add-secondary');
    const addPartner   = resetButton('add-partner');

    const badge = document.getElementById('be-count');
    function updateBadge(){
      if (badge) badge.textContent = (preview.querySelectorAll('.be-block').length) + ' blocks';
    }
    updateBadge();

    const isLocked = b => (b?.dataset?.type === 'locked');

    function area(el){
      const r = el.getBoundingClientRect();
      return (r.width || 1) * (r.height || 1);
    }

    function tableCount(el){
      // prefer a direct table (common for unit blocks)
      const direct = el.querySelectorAll(':scope > table').length;
      return direct || el.querySelectorAll('table').length;
    }

    function pickTemplate(type){
      const all = Array.from(preview.querySelectorAll('.be-block')).filter(Boolean);
      const candidates = all.filter(b => b.dataset && b.dataset.type === type && !isLocked(b));
      if (!candidates.length) return null;

      const scored = candidates.map(el => ({
        el, tables: tableCount(el), area: area(el)
      }));

      const singles = scored.filter(s => s.tables === 1);
      const pool = singles.length ? singles : scored;
      const chosen = pool.sort((a,b) => a.area - b.area)[0].el;

      // Deep clone + sanitize duplicate IDs
      const clone = chosen.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));

      // Optional: relabel copy for clarity
      const labelSpan = clone.querySelector('.be-label span');
      const nice = (chosen.dataset && chosen.dataset.label) ? chosen.dataset.label
                 : (type.charAt(0).toUpperCase() + type.slice(1));
      if (labelSpan) labelSpan.textContent = nice + ' (copy)';

      return clone;
    }

    function appendClone(type){
      const node = pickTemplate(type);
      if (!node) {
        // Fallback: take the smallest non-locked block if type not found
        const pool = Array.from(preview.querySelectorAll('.be-block')).filter(b => !isLocked(b));
        if (!pool.length) return;
        const chosen = pool.sort((a,b) => area(a) - area(b))[0];
        const fallback = chosen.cloneNode(true);
        fallback.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));
        preview.appendChild(fallback);
      } else {
        preview.appendChild(node);
      }
      updateBadge();
    }

    if (addPrimary)   addPrimary.addEventListener('click', function(e){ e.preventDefault(); appendClone('primary'); }, { passive:false });
    if (addSecondary) addSecondary.addEventListener('click', function(e){ e.preventDefault(); appendClone('secondary'); }, { passive:false });
    if (addPartner)   addPartner.addEventListener('click', function(e){
      e.preventDefault();
      const header = pickTemplate('partner-header');
      const card   = pickTemplate('partner-card');
      if (header) preview.appendChild(header);
      if (card)   preview.appendChild(card);
      updateBadge();
    }, { passive:false });
  }
})();
</script>
<script>
(function(){
  // Enhance the safe-clone behavior: Primary must insert a white card like "Story 1 card"
  function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once: true }); else fn(); }
  ready(function(){
    const preview = document.getElementById('preview');
    const addPrimary = document.getElementById('add-primary');
    if (!preview || !addPrimary) return;

    // Overwrite any existing listener by replacing the node
    const btn = addPrimary.cloneNode(true);
    addPrimary.replaceWith(btn);

    function isLocked(b){ return b?.dataset?.type === 'locked'; }

    function area(el){
      const r = el.getBoundingClientRect();
      return (r.width || 1) * (r.height || 1);
    }

    function tableCount(el){
      const direct = el.querySelectorAll(':scope > table').length;
      return direct || el.querySelectorAll('table').length;
    }

    function hasWhiteBg(el){
      // Look for inline styles or attributes indicating white background
      const w = /(#fff(fff)?\\b|\\bwhite\\b)/i;
      if (el.getAttribute('bgcolor') && w.test(el.getAttribute('bgcolor'))) return true;
      if (el.hasAttribute('style') && w.test(el.getAttribute('style'))) return true;
      // Check tables within
      const t = el.querySelector('table');
      if (t){
        if (t.getAttribute('bgcolor') && w.test(t.getAttribute('bgcolor'))) return true;
        if (t.hasAttribute('style') && w.test(t.getAttribute('style'))) return true;
      }
      return false;
    }

    function textIncludes(el, s){
      return (el.textContent || '').toLowerCase().includes(s.toLowerCase());
    }

    function findStory1Primary(){
      const primaries = Array.from(preview.querySelectorAll('.be-block')).filter(b => b.dataset?.type === 'primary' && !isLocked(b));
      if (!primaries.length) return null;

      // 1) Exact label match in data-label or visible label
      let exact = primaries.find(b => /story\\s*1/i.test(b.dataset?.label || ''));
      if (!exact){
        exact = primaries.find(b => /story\\s*1/i.test((b.querySelector('.be-label')?.textContent)||''));
      }
      if (exact) return exact;

      // 2) Prefer white background + single table
      const scored = primaries.map(el => ({
        el,
        white: hasWhiteBg(el) ? 1 : 0,
        tables: tableCount(el),
        area: area(el),
        storyHint: (/(story|card)/i.test(el.dataset?.label || '') || /(story|card)/i.test((el.querySelector('.be-label')?.textContent)||'')) ? 1 : 0,
      }));

      scored.sort((a,b)=>{
        // Prefer white, then story hint, then single-table, then smallest area
        return (b.white - a.white) || (b.storyHint - a.storyHint) || ((a.tables===1)-(b.tables===1)) || (a.area - b.area);
      });

      return scored[0]?.el || null;
    }

    function cloneSanitized(node){
      const clone = node.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));
      const labelSpan = clone.querySelector('.be-label span');
      const nice = (node.dataset && node.dataset.label) ? node.dataset.label : 'Primary';
      if (labelSpan) labelSpan.textContent = nice + ' (copy)';
      return clone;
    }

    btn.addEventListener('click', function(e){
      e.preventDefault();
      let chosen = findStory1Primary();
      if (!chosen){
        // Fallback: smallest non-locked primary; then any smallest non-locked block
        const primaries = Array.from(preview.querySelectorAll('.be-block')).filter(b => b.dataset?.type === 'primary' && !isLocked(b));
        if (primaries.length){
          primaries.sort((a,b)=> area(a) - area(b));
          chosen = primaries[0];
        } else {
          const pool = Array.from(preview.querySelectorAll('.be-block')).filter(b => !isLocked(b));
          if (!pool.length) return;
          pool.sort((a,b)=> area(a) - area(b));
          chosen = pool[0];
        }
      }
      const copy = cloneSanitized(chosen);
      preview.appendChild(copy);
      const badge = document.getElementById('be-count');
      if (badge) badge.textContent = (preview.querySelectorAll('.be-block').length) + ' blocks';
    }, { passive:false });
  });
})();
</script>
<script>
(function(){
  function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once:true }); else fn(); }
  ready(function(){
    const preview = document.getElementById('preview');
    if (!preview) return;

    // Replace buttons to drop previous listeners
    function reset(id){
      const el = document.getElementById(id);
      if (!el) return null;
      const clone = el.cloneNode(true);
      el.replaceWith(clone);
      return clone;
    }
    const addPrimary   = reset('add-primary');
    const addSecondary = reset('add-secondary');
    const addPartner   = reset('add-partner');
    const badge        = document.getElementById('be-count');

    function updateBadge(){
      if (badge) badge.textContent = (preview.querySelectorAll('.be-block').length) + ' blocks';
    }

    function blocks(){ return Array.from(preview.querySelectorAll('.be-block')); }
    function isLocked(b){ return b?.dataset?.type === 'locked'; }
    function area(el){ const r=el.getBoundingClientRect(); return (r.width||1)*(r.height||1); }
    function tableCount(el){ const direct = el.querySelectorAll(':scope > table').length; return direct || el.querySelectorAll('table').length; }
    function hasWhiteBg(el){
      const w=/(#fff(fff)?\b|\bwhite\b)/i;
      if (el.getAttribute('bgcolor') && w.test(el.getAttribute('bgcolor'))) return true;
      if (el.hasAttribute('style') && w.test(el.getAttribute('style'))) return true;
      const t=el.querySelector('table');
      if (t){
        if (t.getAttribute('bgcolor') && w.test(t.getAttribute('bgcolor'))) return true;
        if (t.hasAttribute('style') && w.test(t.getAttribute('style'))) return true;
      }
      return false;
    }

    function pickPrimary(){
      const primaries = blocks().filter(b => b.dataset?.type === 'primary' && !isLocked(b));
      if (!primaries.length) return null;
      let exact = primaries.find(b => /story\s*1/i.test(b.dataset?.label||''))
             ||  primaries.find(b => /story\s*1/i.test((b.querySelector('.be-label')?.textContent)||''));
      if (exact) return exact;
      const scored = primaries.map(el => ({
        el, white: hasWhiteBg(el) ? 1 : 0, tables: tableCount(el), area: area(el),
        hint: (/(story|card)/i.test(el.dataset?.label||'') || /(story|card)/i.test((el.querySelector('.be-label')?.textContent)||'')) ? 1 : 0
      }));
      scored.sort((a,b) => (b.white-a.white) || (b.hint-a.hint) || ((a.tables===1)-(b.tables===1)) || (a.area-b.area));
      return scored[0]?.el || null;
    }

    function pickByType(type){
      // Generic picker for non-primary
      const list = blocks().filter(b => b.dataset?.type === type && !isLocked(b));
      if (!list.length) return null;
      // Prefer single table, then smallest
      const scored = list.map(el => ({ el, tables: tableCount(el), area: area(el) }));
      scored.sort((a,b) => ((a.tables===1)-(b.tables===1)) || (a.area - b.area));
      return scored[0].el;
    }

    function cloneSanitized(node, labelFallback){
      const clone = node.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));
      const labelSpan = clone.querySelector('.be-label span');
      const nice = (node.dataset && node.dataset.label) ? node.dataset.label : labelFallback;
      if (labelSpan && nice) labelSpan.textContent = nice + ' (copy)';
      return clone;
    }

    function insertSecondToLast(node){
      const list = blocks();
      if (!list.length){
        preview.appendChild(node);
        return;
      }
      // second-to-last means index length-1
      const idx = Math.max(0, list.length - 1);
      const ref = list[idx];
      ref.before(node);
    }

    // Wire buttons
    if (addPrimary) addPrimary.addEventListener('click', function(e){
      e.preventDefault();
      let chosen = pickPrimary();
      if (!chosen){
        // fallback: smallest non-locked block
        const pool = blocks().filter(b => !isLocked(b));
        if (!pool.length) return;
        pool.sort((a,b)=> area(a) - area(b));
        chosen = pool[0];
      }
      const copy = cloneSanitized(chosen, 'Primary');
      insertSecondToLast(copy);
      updateBadge();
    }, { passive:false });

    if (addSecondary) addSecondary.addEventListener('click', function(e){
      e.preventDefault();
      let chosen = pickByType('secondary');
      if (!chosen){
        const pool = blocks().filter(b => !isLocked(b));
        if (!pool.length) return;
        pool.sort((a,b)=> area(a) - area(b));
        chosen = pool[0];
      }
      const copy = cloneSanitized(chosen, 'Secondary');
      insertSecondToLast(copy);
      updateBadge();
    }, { passive:false });

    if (addPartner) addPartner.addEventListener('click', function(e){
      e.preventDefault();
      const header = pickByType('partner-header');
      const card   = pickByType('partner-card');
      if (header){ insertSecondToLast(cloneSanitized(header, 'Partner header')); }
      if (card){   insertSecondToLast(cloneSanitized(card, 'Partner card')); }
      updateBadge();
    }, { passive:false });

    updateBadge();
  });
})();
</script>
<script>
(function(){
  function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once:true }); else fn(); }
  ready(function(){
    const preview = document.getElementById('preview');
    if (!preview) return;

    function blocks(){ return Array.from(preview.querySelectorAll('.be-block')); }

    function insertThirdToLast(node){
      const list = blocks();
      if (!list.length){
        preview.appendChild(node);
        return;
      }
      const idx = Math.max(0, list.length - 2);
      const ref = list[idx];
      ref.before(node);
    }

    // Helpers
    function isLocked(b){ return b?.dataset?.type === 'locked'; }
    function area(el){ const r=el.getBoundingClientRect(); return (r.width||1)*(r.height||1); }
    function tableCount(el){ const direct=el.querySelectorAll(':scope > table').length; return direct || el.querySelectorAll('table').length; }
    function hasWhiteBg(el){ const w=/(#fff(fff)?\b|\bwhite\b)/i;
      if(el.getAttribute('bgcolor')&&w.test(el.getAttribute('bgcolor'))) return true;
      if(el.hasAttribute('style')&&w.test(el.getAttribute('style'))) return true;
      const t=el.querySelector('table');
      if(t){ if(t.getAttribute('bgcolor')&&w.test(t.getAttribute('bgcolor'))) return true;
        if(t.hasAttribute('style')&&w.test(t.getAttribute('style'))) return true; }
      return false; }

    function pickPrimary(){
      const primaries=blocks().filter(b=>b.dataset?.type==='primary' && !isLocked(b));
      if(!primaries.length) return null;
      let exact=primaries.find(b=>/story\s*1/i.test(b.dataset?.label||''))
              ||primaries.find(b=>/story\s*1/i.test((b.querySelector('.be-label')?.textContent)||''));
      if(exact) return exact;
      const scored=primaries.map(el=>({
        el,white:hasWhiteBg(el)?1:0,tables:tableCount(el),area:area(el),
        hint:(/(story|card)/i.test(el.dataset?.label||'')||/(story|card)/i.test((el.querySelector('.be-label')?.textContent)||''))?1:0
      }));
      scored.sort((a,b)=>(b.white-a.white)||(b.hint-a.hint)||((a.tables===1)-(b.tables===1))||(a.area-b.area));
      return scored[0]?.el||null;
    }

    function pickByType(type){
      const list=blocks().filter(b=>b.dataset?.type===type && !isLocked(b));
      if(!list.length) return null;
      const scored=list.map(el=>({el,tables:tableCount(el),area:area(el)}));
      scored.sort((a,b)=>((a.tables===1)-(b.tables===1))||(a.area-b.area));
      return scored[0].el;
    }

    function cloneSanitized(node,labelFallback){
      const clone=node.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(n=>n.removeAttribute('id'));
      const labelSpan=clone.querySelector('.be-label span');
      const nice=(node.dataset&&node.dataset.label)?node.dataset.label:labelFallback;
      if(labelSpan&&nice) labelSpan.textContent=nice+' (copy)';
      return clone;
    }

    function reset(id){
      const el=document.getElementById(id);
      if(!el) return null;
      const clone=el.cloneNode(true);
      el.replaceWith(clone);
      return clone;
    }

    const addPrimary=reset('add-primary');
    const addSecondary=reset('add-secondary');
    const addPartner=reset('add-partner');
    const badge=document.getElementById('be-count');
    function updateBadge(){ if(badge) badge.textContent=blocks().length+' blocks'; }

    if(addPrimary) addPrimary.addEventListener('click', function(e){
      e.preventDefault();
      let chosen=pickPrimary();
      if(!chosen){
        const pool=blocks().filter(b=>!isLocked(b));
        if(!pool.length) return;
        pool.sort((a,b)=>area(a)-area(b));
        chosen=pool[0];
      }
      const copy=cloneSanitized(chosen,'Primary');
      insertThirdToLast(copy);
      updateBadge();
    });

    if(addSecondary) addSecondary.addEventListener('click', function(e){
      e.preventDefault();
      let chosen=pickByType('secondary');
      if(!chosen){
        const pool=blocks().filter(b=>!isLocked(b));
        if(!pool.length) return;
        pool.sort((a,b)=>area(a)-area(b));
        chosen=pool[0];
      }
      const copy=cloneSanitized(chosen,'Secondary');
      insertThirdToLast(copy);
      updateBadge();
    });

    if(addPartner) addPartner.addEventListener('click', function(e){
      e.preventDefault();
      const header=pickByType('partner-header');
      const card=pickByType('partner-card');
      if(header) insertThirdToLast(cloneSanitized(header,'Partner header'));
      if(card) insertThirdToLast(cloneSanitized(card,'Partner card'));
      updateBadge();
    });

    updateBadge();
  });
})();
</script>
<script>
(function(){
  function onReady(fn){
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once:true });
    else fn();
  }
  function afterLoad(fn){
    if (document.readyState === 'complete') fn();
    else window.addEventListener('load', fn, { once:true });
  }

  function mergePartnerBlocks(){
    const preview = document.getElementById('preview') || document.body;
    const header = preview.querySelector('.be-block[data-type="partner-header"]');
    if (!header) return;
    let card = header.nextElementSibling;
    if (!card || !(card.classList && card.classList.contains('be-block')) || card.dataset.type !== 'partner-card'){
      // try to find the nearest following partner-card
      card = preview.querySelector('.be-block[data-type="partner-card"]');
      if (!card) return;
    }

    // Move ALL children of card into header, preserve order (content first)
    const marker = document.createComment('moved-partner-card-start');
    header.appendChild(marker);
    while (card.firstChild){
      header.appendChild(card.firstChild);
    }
    card.remove();

    // Remove any nested labels/toolbars created inside the moved content (but keep header's own direct ones)
    header.querySelectorAll(':scope .be-label, :scope .be-block-toolbar').forEach(function(el){
      if (el.parentElement !== header){
        el.remove();
      }
    });

    // Zero the gap between header piece and moved card content
    header.style.margin = '0';
    header.style.borderRadius = '22px';
    header.style.overflow = 'hidden'; /* let editor clip inner blue bar correctly */
    const tds = header.querySelectorAll('td');
    tds.forEach(function(td){
      const s = td.getAttribute('style') || '';
      let ns = s.replace(/padding-top\s*:\s*[^;]+;?/gi,'').replace(/padding-bottom\s*:\s*[^;]+;?/gi,'');
      td.setAttribute('style', (ns ? ns + ';' : '') + '');
    });
  }

  // Optional: lightweight de-duper only for partner-header copies
  function installCopyDeduper(){
    const preview = document.getElementById('preview') || document.body;
    preview.addEventListener('click', function(ev){
      const copyBtn = ev.target.closest && ev.target.closest('.be-ico.be-copy');
      if (!copyBtn) return;
      const blk = copyBtn.closest('.be-block');
      if (!blk) return;
      if (blk.dataset.type !== 'partner-header') return; // only dedupe our merged header

      const before = Array.from(preview.querySelectorAll('.be-block[data-type="partner-header"]'));
      setTimeout(function(){
        const after = Array.from(preview.querySelectorAll('.be-block[data-type="partner-header"]'));
        if (after.length <= before.length) return;
        const idx = after.indexOf(blk);
        const tail = after.slice(idx + 1);
        if (tail.length > 1){
          tail.slice(1).forEach(n => n.remove());
        }
      }, 160);
    }, true); // capture but do not stop propagation
  }

  function main(){
    afterLoad(function(){
      mergePartnerBlocks();
      installCopyDeduper();
    });
  }
  main();
})();
</script>
<script>
(function(){
  function onReady(fn){
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once:true });
    else fn();
  }
  function afterLoad(fn){
    if (document.readyState === 'complete') fn();
    else window.addEventListener('load', fn, { once:true });
  }

  function text(el){
    return (el?.innerText || '').trim().toLowerCase();
  }

  function findBlockByLabelContains(blocks, needle){
    needle = needle.toLowerCase();
    for (const b of blocks){
      const lab = b.querySelector(':scope > .be-label');
      if (lab && text(lab).includes(needle)) return b;
    }
    return null;
  }

  function mergeIntroGroup(){
    const preview = document.getElementById('preview') || document.body;
    const blocks = Array.from(preview.querySelectorAll('.be-block'));

    const hero   = findBlockByLabelContains(blocks, 'hero banner');
    const date   = findBlockByLabelContains(blocks, 'date bar');
    const author = findBlockByLabelContains(blocks, 'author banner');

    if (!hero || !date || !author) return;

    // Ensure they are in order; if not, sort by document position
    const trio = [hero, date, author].sort((a,b)=> a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING ? -1 : 1);

    // Move DATE + AUTHOR content *into* HERO (keep hero instrumented)
    for (let i=1;i<trio.length;i++){
      const src = trio[i];
      // Remove nested top-level labels/toolbars from src
      src.querySelectorAll(':scope > .be-label, :scope > .be-block-toolbar').forEach(n => n.remove());
      // Move all children into hero (content only)
      while (src.firstChild){
        hero.appendChild(src.firstChild);
      }
      src.remove();
    }

    // Clean labels/toolbars nested inside hero content (keep only hero's direct label)
    hero.querySelectorAll('.be-label, .be-block-toolbar').forEach(n => {
      if (n.parentElement !== hero) n.remove();
    });

    // Rename the remaining label to "Header section"
    let label = hero.querySelector(':scope > .be-label');
    if (label){
      const span = label.querySelector('span');
      if (span){
        span.innerHTML = '<span class="dot"></span> Header section';
      } else {
        label.innerHTML = '<span><span class="dot"></span> Header section</span>';
      }
    } else {
      // If no label, create one
      label = document.createElement('div');
      label.className = 'be-label';
      label.innerHTML = '<span><span class="dot"></span> Header section</span>';
      hero.insertBefore(label, hero.firstChild);
    }

    // Mark as intro-locked for styling/observation
    hero.dataset.type = 'intro-locked';
    hero.dataset.label = 'Header section';

    // Remove the top toolbar entirely for this block
    hero.querySelectorAll(':scope > .be-block-toolbar').forEach(n => n.remove());

    // Tighten internal spacing a bit
    hero.style.margin = '0';
    // Rounded wrapper: we won't force overflow hidden to avoid clipping any editor controls
    hero.style.borderRadius = '22px';

    // Also remove any toolbar/labels that appear later (editor mutations)
    const mo = new MutationObserver(function(muts){
      muts.forEach(m => {
        (m.addedNodes || []).forEach(node => {
          if (!(node instanceof HTMLElement)) return;
          const host = node.closest && node.closest('.be-block');
          if (host === hero){
            // strip any toolbars/labels added within the hero
            hero.querySelectorAll(':scope > .be-block-toolbar').forEach(n => n.remove());
            hero.querySelectorAll('.be-label, .be-block-toolbar').forEach(n => {
              if (n.parentElement !== hero) n.remove();
            });
          }
        });
      });
    });
    mo.observe(hero, { childList:true, subtree:true });
  }

  function installGlobalCSS(){
    const css = document.createElement('style');
    css.textContent = `
      .be-block[data-type="intro-locked"] > .be-block-toolbar{ display:none !important; }
      .be-block[data-type="intro-locked"] .be-block .be-block-toolbar{ display:none !important; }
      .be-block[data-type="intro-locked"] .be-block .be-label{ display:none !important; }
      /* keep the block editable – we're not disabling content editing, only the move/copy/delete UI */
    `;
    document.head.appendChild(css);
  }

  function main(){
    onReady(installGlobalCSS);
    afterLoad(mergeIntroGroup);
  }
  main();
})();
</script>
<style>
/* --- Global toolbar positioning + hover/active visibility --- */
.be-block{ position: relative; }
.be-block > .be-block-toolbar{
  position: absolute !important;
  top: 0 !important;
  right: 0 !important;
  z-index: 9999 !important;
  display: inline-flex;
  gap: 6px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 120ms ease-in-out;
}
/* Show toolbar when hovering the block, or when it's the active/editing block */
.be-block:hover > .be-block-toolbar,
.be-block.is-active > .be-block-toolbar{
  opacity: 1;
  pointer-events: auto;
}

/* Keep toolbars hidden for locked intro section */
.be-block[data-type="intro-locked"] > .be-block-toolbar{ display:none !important; }

/* Partner/others: ensure no clipping of the toolbar */
.be-block{ overflow: visible; }
</style><script>
(function(){
  var root = document.getElementById('preview') || document.body;

  function findBlock(el){
    return el && el.closest ? el.closest('.be-block') : null;
  }
  function clearActive(except){
    root.querySelectorAll('.be-block.is-active').forEach(function(n){
      if (n !== except) n.classList.remove('is-active');
    });
  }

  // Mark block active on focus/click inside
  root.addEventListener('focusin', function(e){
    var blk = findBlock(e.target);
    if (!blk) return;
    blk.classList.add('is-active');
    clearActive(blk);
  });
  root.addEventListener('mousedown', function(e){
    var blk = findBlock(e.target);
    if (!blk) return;
    blk.classList.add('is-active');
    clearActive(blk);
  });

  // Remove active when focus leaves the block (with a small delay to allow focus to move within)
  root.addEventListener('focusout', function(e){
    var blk = findBlock(e.target);
    if (!blk) return;
    setTimeout(function(){
      if (!blk.contains(document.activeElement)){
        blk.classList.remove('is-active');
      }
    }, 50);
  });

  // If user clicks outside any block, clear active
  document.addEventListener('click', function(e){
    if (!findBlock(e.target)){
      clearActive(null);
    }
  });
})();
</script><style>
/* Floating formatting toolbar that follows the active block */
#be-toolbar {
  position: fixed;
  left: 0;
  top: 0;
  transform: translate(-50%, -100%);
  z-index: 10050;
  opacity: 0;
  pointer-events: auto;
  transition: opacity 120ms ease;
}
#be-toolbar.is-visible { opacity: 1; }

/* Ensure per-block toolbars stay at top-right of their block */
.be-block { position: relative; overflow: visible; }
.be-block > .be-block-toolbar{
  position: absolute !important;
  top: 0 !important;
  right: 0 !important;
  z-index: 9990;
  display: inline-flex;
  gap: 6px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 120ms ease-in-out;
}
.be-block:hover > .be-block-toolbar,
.be-block.is-active > .be-block-toolbar{
  opacity: 1;
  pointer-events: auto;
}
</style><script>
(function(){
  const toolbar = document.getElementById('be-toolbar');
  if (!toolbar) return;

  const root = document.getElementById('preview') || document.body;
  let activeBlock = null, rafId = 0;
  const MARGIN = 8;

  function setVisible(v){ toolbar.classList.toggle('is-visible', v); }
  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function updatePos(){
    rafId = 0;
    if (!activeBlock){
      setVisible(false);
      return;
    }
    const rect = activeBlock.getBoundingClientRect();
    if (!rect || rect.width === 0 || rect.height === 0){
      setVisible(false);
      return;
    }
    const vw = Math.max(document.documentElement.clientWidth,  window.innerWidth  || 0);
    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

    let x = rect.left + rect.width / 2;
    x = clamp(x, MARGIN, vw - MARGIN);

    let top = rect.top - MARGIN;
    if (top < MARGIN){
      top = rect.bottom + MARGIN;
      toolbar.style.transform = 'translate(-50%, 0)';
    } else {
      toolbar.style.transform = 'translate(-50%, -100%)';
    }

    toolbar.style.left = x + 'px';
    toolbar.style.top  = top + 'px';
    setVisible(true);
  }
  function reqUpdate(){ if (!rafId) rafId = requestAnimationFrame(updatePos); }

  function findBlock(el){ return el && el.closest ? el.closest('.be-block') : null; }
  function clearActive(except){
    root.querySelectorAll('.be-block.is-active').forEach(n => { if (n !== except) n.classList.remove('is-active'); });
  }

  // Keep track of the active block
  root.addEventListener('focusin', (e) => { const b = findBlock(e.target); if (b){ activeBlock = b; b.classList.add('is-active'); clearActive(b); reqUpdate(); }});
  root.addEventListener('click',   (e) => { const b = findBlock(e.target); if (b){ activeBlock = b; b.classList.add('is-active'); clearActive(b); reqUpdate(); } else { activeBlock = null; clearActive(null); setVisible(false); }});

  document.addEventListener('selectionchange', reqUpdate);
  window.addEventListener('scroll',  reqUpdate, true);
  window.addEventListener('resize',  reqUpdate);

  // Expose for programmatic repositioning
  window.repositionBeToolbar = reqUpdate;
})();
</script><style>
/* Ensure the style editor toolbar exists and is always visible */
#be-toolbar{
  position: fixed !important;
  z-index: 10050 !important;
  opacity: 1 !important;
  pointer-events: auto !important;
}
</style><script>
(function(){
  // Ensure toolbar exists with default content if editor didn't inject it
  var tb = document.getElementById('be-toolbar');
  if (!tb){
    tb = document.createElement('div');
    tb.id = 'be-toolbar';
    tb.className = 'be-toolbar';
    tb.setAttribute('role', 'toolbar');
    tb.setAttribute('aria-label', 'Formatting');
    tb.innerHTML = ''
      + '<button data-cmd="bold"><strong>B</strong></button>'
      + '<button data-cmd="italic"><em>I</em></button>'
      + '<button data-cmd="underline"><u>U</u></button>'
      + '<span class="be-sep"></span>'
      + '<button data-cmd="insertUnorderedList">• List</button>'
      + '<button data-cmd="insertOrderedList">1. List</button>'
      + '<span class="be-sep"></span>'
      + '<button data-cmd="formatBlock" data-value="H2">H2</button>'
      + '<button data-cmd="formatBlock" data-value="H3">H3</button>'
      + '<span class="be-sep"></span>'
      + '<button id="be-link">Link</button>'
      + '<button id="be-clear">Clear</button>';
    (document.body || document.documentElement).appendChild(tb);
  }

  // Make it float over current .be-block (above by default, below if near viewport top)
  var root = document.getElementById('preview') || document.body;
  var activeBlock = null, raf = 0, MARGIN = 8;

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
  function findBlock(el){ return el && el.closest ? el.closest('.be-block') : null; }

  function positionToolbar(){
    raf = 0;
    var rect = activeBlock && activeBlock.getBoundingClientRect();
    if (!rect || !rect.width || !rect.height) return;
    var vw = Math.max(document.documentElement.clientWidth,  window.innerWidth  || 0);
    var vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

    var x = clamp(rect.left + rect.width/2, MARGIN, vw - MARGIN);
    var aboveTop = rect.top - MARGIN;
    var belowTop = rect.bottom + MARGIN;

    if (aboveTop < MARGIN){
      tb.style.transform = 'translate(-50%, 0)';
      tb.style.top = belowTop + 'px';
    } else {
      tb.style.transform = 'translate(-50%, -100%)';
      tb.style.top = aboveTop + 'px';
    }
    tb.style.left = x + 'px';
  }
  function req(){ if (!raf) raf = requestAnimationFrame(positionToolbar); }

  function activate(b){
    if (!b) return;
    if (activeBlock === b) { req(); return; }
    activeBlock = b;
    // highlight active for per-block toolbar CSS if present
    try {
      root.querySelectorAll('.be-block.is-active').forEach(function(n){ if(n!==b) n.classList.remove('is-active'); });
      b.classList.add('is-active');
    } catch(e){}
    req();
  }

  root.addEventListener('focusin', function(e){ var b=findBlock(e.target); if (b) activate(b); });
  root.addEventListener('click',   function(e){ var b=findBlock(e.target); if (b) activate(b); });

  document.addEventListener('selectionchange', req);
  window.addEventListener('scroll', req, true);
  window.addEventListener('resize', req);

  // If nothing is active on load, use the first editable block
  window.addEventListener('load', function(){
    var first = root.querySelector('.be-block:not([data-type="intro-locked"])');
    if (first) activate(first);
  });
})();
</script><style>
/* High-contrast styling for the floating formatting toolbar buttons */
#be-toolbar {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  padding: 6px 8px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
#be-toolbar button {
  font: 500 13px/1 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  border: 1px solid #d1d5db;
  background: #fff;
  border-radius: 8px;
  min-width: 28px;
  height: 28px;
  padding: 0 10px;
  cursor: pointer;
  transition: border-color 120ms ease, background 120ms ease, transform 80ms ease;
}
#be-toolbar button strong,
#be-toolbar button em,
#be-toolbar button u { font-weight: 700; font-style: normal; text-decoration: none; }
#be-toolbar button:hover { border-color: #9ca3af; background: #f9fafb; }
#be-toolbar button:active { transform: translateY(1px); }
#be-toolbar .be-sep { width: 1px; height: 20px; background: #e5e7eb; margin: 0 6px; }

/* Per-block toolbars pinned to top-right; show on hover/active */
.be-block { position: relative; overflow: visible; }
.be-block > .be-block-toolbar {
  position: absolute !important;
  top: 0 !important;
  right: 0 !important;
  z-index: 10000;
  display: inline-flex;
  gap: 6px;
  opacity: 0;
  pointer-events: none;
  padding: 2px;
  background: rgba(255,255,255,0.9);
  border-radius: 8px;
  border: 1px solid rgba(0,0,0,0.06);
  transition: opacity 120ms ease-in-out;
}
.be-block:hover > .be-block-toolbar,
.be-block.is-active > .be-block-toolbar {
  opacity: 1;
  pointer-events: auto;
}

/* Keep intro section locked (no move/copy/delete) */
.be-block[data-type="intro-locked"] > .be-block-toolbar { display: none !important; }
</style><style>
/* Hide any duplicate toolbars beyond the first within a block */
.be-block > .be-block-toolbar ~ .be-block-toolbar { display: none !important; }
/* Within the toolbar, hide duplicate buttons beyond the first occurrence */
.be-block > .be-block-toolbar .be-ico.be-copy ~ .be-ico.be-copy { display: none !important; }
.be-block > .be-block-toolbar .be-ico.be-delete ~ .be-ico.be-delete { display: none !important; }
.be-block > .be-block-toolbar .be-ico.be-handle ~ .be-ico.be-handle { display: none !important; }

/* Keep per-block toolbar at top-right and styled */
.be-block { position: relative; overflow: visible; }
.be-block > .be-block-toolbar {
  position: absolute !important;
  top: 0 !important;
  right: 0 !important;
  z-index: 10000;
  display: inline-flex;
  gap: 6px;
  padding: 2px;
  background: rgba(255,255,255,0.9);
  border-radius: 8px;
  border: 1px solid rgba(0,0,0,0.06);
}

</style><script>
(function(){
  function addMissingToolbars(){
    var root = document.getElementById('preview') || document.body;
    var blocks = root.querySelectorAll('.be-block');
    for (var i=0; i<blocks.length; i++){
      var b = blocks[i];
      if (b.dataset && b.dataset.type === 'intro-locked') continue;
      // check for a direct child toolbar
      var hasBar = false;
      for (var c = b.firstElementChild; c; c = c.nextElementSibling){
        if (c.classList && c.classList.contains('be-block-toolbar')){ hasBar = true; break; }
      }
      if (!hasBar){
        var bar = document.createElement('div');
        bar.className = 'be-block-toolbar';
        // create standard buttons
        var h = document.createElement('button'); h.className='be-ico be-handle'; h.textContent='⋮⋮';
        var cp= document.createElement('button'); cp.className='be-ico be-copy';   cp.textContent='Copy';
        var dl= document.createElement('button'); dl.className='be-ico be-delete'; dl.textContent='Delete';
        bar.appendChild(h); bar.appendChild(cp); bar.appendChild(dl);
        b.insertBefore(bar, b.firstElementChild);
      }
    }
    if (window.repositionBeToolbar) window.repositionBeToolbar();
  }
  if (document.readyState === 'complete') addMissingToolbars();
  else window.addEventListener('load', addMissingToolbars, { once:true });
})();
</script><script>
(function(){
  function ensureDisclaimerStructure(){
    try{
      var blocks = document.querySelectorAll('.be-block[data-type="disclaimer"]');
      for (var i=0;i<blocks.length;i++){
        var block = blocks[i];
        // Ensure label exists
        var hasLabel = false;
        for (var c = block.firstElementChild; c; c = c.nextElementSibling){
          if (c.classList && c.classList.contains('be-label')){ hasLabel = true; break; }
        }
        if (!hasLabel){
          var label = document.createElement('div');
          label.className = 'be-label';
          label.innerHTML = '<span><span class="dot"></span> Disclaimer</span>';
          block.insertBefore(label, block.firstElementChild);
        }
        // Ensure a single direct toolbar right after label
        var labelNode = block.querySelector(':scope > .be-label');
        var directBars = block.querySelectorAll(':scope > .be-block-toolbar');
        var bar = directBars[0];
        for (var j=1;j<directBars.length;j++){ directBars[j].remove(); }
        if (!bar){
          // promote nested if any
          var nested = block.querySelector('.be-block-toolbar');
          if (nested){ bar = nested; } else { bar = document.createElement('div'); bar.className = 'be-block-toolbar'; }
          if (labelNode && labelNode.nextSibling){
            block.insertBefore(bar, labelNode.nextSibling);
          } else {
            block.insertBefore(bar, block.firstElementChild);
          }
        }else{
          if (labelNode && bar.previousElementSibling !== labelNode){
            block.insertBefore(bar, labelNode.nextSibling);
          }
        }
        // Ensure one of each button
        function need(sel, mk){
          var btn = bar.querySelector(sel);
          if (!btn){ btn = mk(); bar.appendChild(btn); }
          return btn;
        }
        var handle = need('.be-ico.be-handle', function(){ var b=document.createElement('button'); b.className='be-ico be-handle'; b.textContent='⋮⋮'; return b; });
        var copy   = need('.be-ico.be-copy',   function(){ var b=document.createElement('button'); b.className='be-ico be-copy';   b.textContent='Copy'; return b; });
        var del    = need('.be-ico.be-delete', function(){ var b=document.createElement('button'); b.className='be-ico be-delete'; b.textContent='Delete'; return b; });
        // Order by moving nodes
        bar.appendChild(handle); bar.appendChild(copy); bar.appendChild(del);
      }
    }catch(e){ try{ console.warn('ensureDisclaimerStructure error', e); }catch(_){ } }
  }

  // Delegated click handler so it works for future clones too
  function onClick(e){
    var copyBtn = e.target.closest && e.target.closest('.be-block[data-type="disclaimer"] .be-block-toolbar .be-copy');
    var delBtn  = e.target.closest && e.target.closest('.be-block[data-type="disclaimer"] .be-block-toolbar .be-delete');
    if (!copyBtn && !delBtn) return;

    e.preventDefault();
    e.stopPropagation();
    if (e.stopImmediatePropagation) e.stopImmediatePropagation();

    var block = (copyBtn || delBtn).closest('.be-block[data-type="disclaimer"]');
    if (!block) return;

    if (delBtn){
      // Remove the entire block
      if (block.parentNode) block.parentNode.removeChild(block);
      return;
    }

    if (copyBtn){
      // Clone the block and clean IDs
      var clone = block.cloneNode(true);
      var withId = clone.querySelectorAll('[id]');
      for (var i=0;i<withId.length;i++){ withId[i].removeAttribute('id'); }
      // Insert after and ensure its structure (toolbar/label placement)
      block.parentNode.insertBefore(clone, block.nextSibling);
      // No need to wire events—delegation handles future clicks
      // Ensure toolbar/label positioning on the clone
      requestAnimationFrame(ensureDisclaimerStructure);
    }
  }

  // Run once on load to ensure structure, then install delegated handler
  if (document.readyState === 'complete'){ ensureDisclaimerStructure(); }
  else window.addEventListener('load', ensureDisclaimerStructure, { once:true });

  document.addEventListener('click', onClick, true); // capture to beat editor handlers
})();
</script><script>(function(){
  // Run after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupFix, { once: true });
  } else {
    setupFix();
  }

  function setupFix(){
    const preview = document.getElementById('preview');
    if (!preview) return;

    // Replace buttons with clean clones to drop any older listeners
    function resetButton(id){
      const btn = document.getElementById(id);
      if (!btn) return null;
      const clone = btn.cloneNode(true);
      btn.replaceWith(clone);
      return clone;
    }

    const addPrimary   = resetButton('add-primary');
    const addSecondary = resetButton('add-secondary');
    const addPartner   = resetButton('add-partner');

    const badge = document.getElementById('be-count');
    function updateBadge(){
      if (badge) badge.textContent = (preview.querySelectorAll('.be-block').length) + ' blocks';
    }
    updateBadge();

    const isLocked = b => (b?.dataset?.type === 'locked');

    function area(el){
      const r = el.getBoundingClientRect();
      return (r.width || 1) * (r.height || 1);
    }

    function tableCount(el){
      // prefer a direct table (common for unit blocks)
      const direct = el.querySelectorAll(':scope > table').length;
      return direct || el.querySelectorAll('table').length;
    }

    function pickTemplate(type){
      const all = Array.from(preview.querySelectorAll('.be-block')).filter(Boolean);
      const candidates = all.filter(b => b.dataset && b.dataset.type === type && !isLocked(b));
      if (!candidates.length) return null;

      const scored = candidates.map(el => ({
        el, tables: tableCount(el), area: area(el)
      }));

      const singles = scored.filter(s => s.tables === 1);
      const pool = singles.length ? singles : scored;
      const chosen = pool.sort((a,b) => a.area - b.area)[0].el;

      // Deep clone + sanitize duplicate IDs
      const clone = chosen.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));

      // Optional: relabel copy for clarity
      const labelSpan = clone.querySelector('.be-label span');
      const nice = (chosen.dataset && chosen.dataset.label) ? chosen.dataset.label
                 : (type.charAt(0).toUpperCase() + type.slice(1));
      if (labelSpan) labelSpan.textContent = nice + ' (copy)';

      return clone;
    }

    function appendClone(type){
      const node = pickTemplate(type);
      if (!node) {
        // Fallback: take the smallest non-locked block if type not found
        const pool = Array.from(preview.querySelectorAll('.be-block')).filter(b => !isLocked(b));
        if (!pool.length) return;
        const chosen = pool.sort((a,b) => area(a) - area(b))[0];
        const fallback = chosen.cloneNode(true);
        fallback.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));
        preview.appendChild(fallback);
      } else {
        preview.appendChild(node);
      }
      updateBadge();
    }

    if (addPrimary)   addPrimary.addEventListener('click', function(e){ e.preventDefault(); appendClone('primary'); }, { passive:false });
    if (addSecondary) addSecondary.addEventListener('click', function(e){ e.preventDefault(); appendClone('secondary'); }, { passive:false });
    if (addPartner)   addPartner.addEventListener('click', function(e){
      e.preventDefault();
      const header = pickTemplate('partner-header');
      const card   = pickTemplate('partner-card');
      if (header) preview.appendChild(header);
      if (card)   preview.appendChild(card);
      updateBadge();
    }, { passive:false });
  }
})();
</script>
<script>
(function(){
  // Enhance the safe-clone behavior: Primary must insert a white card like "Story 1 card"
  function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once: true }); else fn(); }
  ready(function(){
    const preview = document.getElementById('preview');
    const addPrimary = document.getElementById('add-primary');
    if (!preview || !addPrimary) return;

    // Overwrite any existing listener by replacing the node
    const btn = addPrimary.cloneNode(true);
    addPrimary.replaceWith(btn);

    function isLocked(b){ return b?.dataset?.type === 'locked'; }

    function area(el){
      const r = el.getBoundingClientRect();
      return (r.width || 1) * (r.height || 1);
    }

    function tableCount(el){
      const direct = el.querySelectorAll(':scope > table').length;
      return direct || el.querySelectorAll('table').length;
    }

    function hasWhiteBg(el){
      // Look for inline styles or attributes indicating white background
      const w = /(#fff(fff)?\\b|\\bwhite\\b)/i;
      if (el.getAttribute('bgcolor') && w.test(el.getAttribute('bgcolor'))) return true;
      if (el.hasAttribute('style') && w.test(el.getAttribute('style'))) return true;
      // Check tables within
      const t = el.querySelector('table');
      if (t){
        if (t.getAttribute('bgcolor') && w.test(t.getAttribute('bgcolor'))) return true;
        if (t.hasAttribute('style') && w.test(t.getAttribute('style'))) return true;
      }
      return false;
    }

    function textIncludes(el, s){
      return (el.textContent || '').toLowerCase().includes(s.toLowerCase());
    }

    function findStory1Primary(){
      const primaries = Array.from(preview.querySelectorAll('.be-block')).filter(b => b.dataset?.type === 'primary' && !isLocked(b));
      if (!primaries.length) return null;

      // 1) Exact label match in data-label or visible label
      let exact = primaries.find(b => /story\\s*1/i.test(b.dataset?.label || ''));
      if (!exact){
        exact = primaries.find(b => /story\\s*1/i.test((b.querySelector('.be-label')?.textContent)||''));
      }
      if (exact) return exact;

      // 2) Prefer white background + single table
      const scored = primaries.map(el => ({
        el,
        white: hasWhiteBg(el) ? 1 : 0,
        tables: tableCount(el),
        area: area(el),
        storyHint: (/(story|card)/i.test(el.dataset?.label || '') || /(story|card)/i.test((el.querySelector('.be-label')?.textContent)||'')) ? 1 : 0,
      }));

      scored.sort((a,b)=>{
        // Prefer white, then story hint, then single-table, then smallest area
        return (b.white - a.white) || (b.storyHint - a.storyHint) || ((a.tables===1)-(b.tables===1)) || (a.area - b.area);
      });

      return scored[0]?.el || null;
    }

    function cloneSanitized(node){
      const clone = node.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));
      const labelSpan = clone.querySelector('.be-label span');
      const nice = (node.dataset && node.dataset.label) ? node.dataset.label : 'Primary';
      if (labelSpan) labelSpan.textContent = nice + ' (copy)';
      return clone;
    }

    btn.addEventListener('click', function(e){
      e.preventDefault();
      let chosen = findStory1Primary();
      if (!chosen){
        // Fallback: smallest non-locked primary; then any smallest non-locked block
        const primaries = Array.from(preview.querySelectorAll('.be-block')).filter(b => b.dataset?.type === 'primary' && !isLocked(b));
        if (primaries.length){
          primaries.sort((a,b)=> area(a) - area(b));
          chosen = primaries[0];
        } else {
          const pool = Array.from(preview.querySelectorAll('.be-block')).filter(b => !isLocked(b));
          if (!pool.length) return;
          pool.sort((a,b)=> area(a) - area(b));
          chosen = pool[0];
        }
      }
      const copy = cloneSanitized(chosen);
      preview.appendChild(copy);
      const badge = document.getElementById('be-count');
      if (badge) badge.textContent = (preview.querySelectorAll('.be-block').length) + ' blocks';
    }, { passive:false });
  });
})();
</script>
<script>
(function(){
  function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once:true }); else fn(); }
  ready(function(){
    const preview = document.getElementById('preview');
    const addPrimary = document.getElementById('add-primary');
    if (!preview || !addPrimary) return;
    const btn = addPrimary.cloneNode(true);
    addPrimary.replaceWith(btn);

    function isLocked(b){ return b?.dataset?.type === 'locked'; }
    function area(el){ const r=el.getBoundingClientRect(); return (r.width||1)*(r.height||1); }
    function tableCount(el){ const direct = el.querySelectorAll(':scope > table').length; return direct || el.querySelectorAll('table').length; }
    function hasWhiteBg(el){ const w=/(#fff(fff)?\\b|\\bwhite\\b)/i;
      if (el.getAttribute('bgcolor') && w.test(el.getAttribute('bgcolor'))) return true;
      if (el.hasAttribute('style') && w.test(el.getAttribute('style'))) return true;
      const t=el.querySelector('table'); if(t){ if(t.getAttribute('bgcolor') && w.test(t.getAttribute('bgcolor'))) return true;
        if(t.hasAttribute('style') && w.test(t.getAttribute('style'))) return true; }
      return false; }
    function findStory1Primary(){
      const primaries=[...preview.querySelectorAll('.be-block')].filter(b=>b.dataset?.type==='primary' && !isLocked(b));
      if(!primaries.length) return null;
      let exact=primaries.find(b=>/story\\s*1/i.test(b.dataset?.label||'')); if(!exact){ exact=primaries.find(b=>/story\\s*1/i.test((b.querySelector('.be-label')?.textContent)||'')); }
      if(exact) return exact;
      const scored=primaries.map(el=>({el,white:hasWhiteBg(el)?1:0,tables:tableCount(el),area:area(el),
        storyHint:(/(story|card)/i.test(el.dataset?.label||'')||/(story|card)/i.test((el.querySelector('.be-label')?.textContent)||''))?1:0 }));
      scored.sort((a,b)=>(b.white-a.white)||(b.storyHint-a.storyHint)||((a.tables===1)-(b.tables===1))||(a.area-b.area));
      return scored[0]?.el||null;
    }
    function cloneSanitized(node){ const clone=node.cloneNode(true); clone.querySelectorAll('[id]').forEach(n=>n.removeAttribute('id'));
      const labelSpan=clone.querySelector('.be-label span'); const nice=(node.dataset&&node.dataset.label)?node.dataset.label:'Primary';
      if(labelSpan) labelSpan.textContent=nice+' (copy)'; return clone; }

    btn.addEventListener('click', function(e){
      e.preventDefault();
      let chosen=findStory1Primary(); if(!chosen){ const primaries=[...preview.querySelectorAll('.be-block')].filter(b=>b.dataset?.type==='primary'&&!isLocked(b));
        if(primaries.length){ primaries.sort((a,b)=>area(a)-area(b)); chosen=primaries[0]; }
        else { const pool=[...preview.querySelectorAll('.be-block')].filter(b=>!isLocked(b)); if(!pool.length) return; pool.sort((a,b)=>area(a)-area(b)); chosen=pool[0]; } }
      const copy=cloneSanitized(chosen);

      // Insert before the Subscribe CTA line
      let target=[...preview.querySelectorAll('.be-block')].find(b=>/subscribe cta/i.test(b.dataset?.label||'')||/subscribe cta/i.test((b.textContent||'')));
      if(target) target.before(copy); else preview.appendChild(copy);

      const badge=document.getElementById('be-count');
      if(badge) badge.textContent=preview.querySelectorAll('.be-block').length+' blocks';
    }, {passive:false});
  });
})();</script><script>
// --- Hard lock placement for Primary, Secondary & Partner by intercepting preview.appendChild ---
(function(){
  var preview = document.getElementById('preview') || document.body;
  if (!preview) return;

  var origAppend = preview.appendChild.bind(preview);

  
  function findClosestBlockByText(regex){
    var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT, null);
    var matches = [];
    while (walker.nextNode()){
      var el = walker.currentNode;
      if (!el) continue;
      var txt = (el.textContent || '').trim();
      if (!txt) continue;
      if (regex.test(txt)){
        var block = el.closest && el.closest('.be-block');
        if (block) matches.push(block);
      }
    }
    return matches.length ? matches[matches.length-1] : null;
  }

  
  function findClosestBlockByText(regex){
    try{
      var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT, null);
      var matches = [];
      while (walker.nextNode()){
        var el = walker.currentNode;
        if (!el) continue;
        var txt = (el.textContent || '').trim();
        if (!txt) continue;
        if (regex.test(txt)){
          var block = el.closest && el.closest('.be-block');
          if (block) matches.push(block);
        }
      }
      return matches.length ? matches[matches.length-1] : null;
    }catch(_){ return null; }
  }

  function anchor(){
    var preview = document.getElementById('preview') || document.body;
    var a = document.querySelector('.be-block[data-type="primary"][data-label="Row 23: Subscribe CTA line"]');
    if (a) return a;
    a = document.querySelector('.be-block[data-type="disclaimer"]');
    if (!a){ a = findClosestBlockByText(/(SoFi Disclaimers|Disclaimer: Finder|INVESTMENTS ARE NOT FDIC INSURED)/i); }
    if (a) return a;
    a = Array.from(preview.querySelectorAll('.be-block')).find(function(b){
      var lbl = (b.dataset && b.dataset.label) ? b.dataset.label : '';
      return /dynamic content block/i.test(lbl) || /row\s*26:\s*dynamic/i.test(lbl);
    });
    if (!a){ a = findClosestBlockByText(/Dynamic content block/i); }
    if (a) return a;
    return null;
  }

  preview.appendChild = function(node){
    try{
      if (node && node.nodeType === 1 && node.classList && node.classList.contains('be-block')){
        var t = (node.dataset && node.dataset.type) || '';
        if (t === 'primary' || t === 'secondary' || t === 'partner-header' || t === 'partner-card'){
          var a = anchor();
          if (a && a.parentNode){
            var p = a.parentNode;
            if (node.parentNode !== p) p.appendChild(node);
            p.insertBefore(node, a); // <— force BEFORE Row 23
            return node;
          }
        }
      }
    }catch(_){}
    return origAppend(node); // default for everything else (including Primary)
  };
})();
</script><script>
// Final override: intercept ONLY when parent is inside #preview (avoids fragment/build-phase issues)
(function(){
  var preview = document.getElementById('preview') || document.body;

  function findClosestBlockByText(regex){
    try{
      var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT, null);
      var matches = [];
      while (walker.nextNode()){
        var el = walker.currentNode;
        if (!el) continue;
        var txt = (el.textContent || '').trim();
        if (!txt) continue;
        if (regex.test(txt)){
          var block = el.closest && el.closest('.be-block');
          if (block) matches.push(block);
        }
      }
      return matches.length ? matches[matches.length-1] : null;
    }catch(_){ return null; }
  }

  function anchor(){
    var a = document.querySelector('.be-block[data-type="primary"][data-label="Row 23: Subscribe CTA line"]');
    if (a) return a;

    a = document.querySelector('.be-block[data-type="disclaimer"]');
    if (!a){
      a = findClosestBlockByText(/(SoFi Disclaimers|Disclaimer: Finder|INVESTMENTS ARE NOT FDIC INSURED)/i);
    }
    if (a) return a;

    a = Array.from(preview.querySelectorAll('.be-block')).find(function(b){
      var lbl = (b.dataset && b.dataset.label) ? b.dataset.label : '';
      return /dynamic content block/i.test(lbl) || /row\s*26:\s*dynamic/i.test(lbl);
    });
    if (!a){
      a = findClosestBlockByText(/Dynamic content block/i);
    }
    if (a) return a;

    return null; // no anchors -> append to bottom
  }

  var prevAppend = Element.prototype.appendChild;
  Element.prototype.appendChild = function(node){
    var parent = this;
    var inPreview = false;
    try { inPreview = preview && preview.contains && preview.contains(parent); } catch(_) {}

    // Only take over for real .be-blocks appended into the live preview tree
    if (inPreview && node && node.nodeType === 1 && node.classList && node.classList.contains('be-block')){
      var t = (node.dataset && node.dataset.type) || '';
      if (t === 'primary' || t === 'secondary' || t === 'partner-header' || t === 'partner-card'){
        var a = anchor();
        if (a && a.parentNode){
          var p = a.parentNode;
          // ensure node is under the same parent once
          if (node.parentNode !== p) prevAppend.call(p, node);
          if (node !== a) p.insertBefore(node, a);
          return node;
        }
        // no anchor -> let it append at bottom naturally
        return prevAppend.call(parent, node);
      }
    }
    return prevAppend.call(parent, node);
  };
})();</script><script>
// Partner Add Guardian: only overrides when header/card is missing; otherwise lets native handler run.
(function(){
  var root = document.getElementById('preview') || document.body;
  var btn = document.getElementById('add-partner');
  if (!root || !btn) return;

  function exists(sel){ return !!root.querySelector(sel); }
  function build(id){
    var tpl = document.getElementById(id);
    return (tpl && tpl.content && tpl.content.firstElementChild) ? tpl.content.firstElementChild.cloneNode(true) : null;
  }

  btn.addEventListener('click', function(ev){
    var needHeader = !exists('.be-block[data-type="partner-header"]');
    var needCard   = !exists('.be-block[data-type="partner-card"]');
    if (needHeader || needCard){
      // Stop native listener (which appears to no-op after deleting the default card)
      ev.preventDefault();
      ev.stopImmediatePropagation();
      ev.stopPropagation();

      // Synthesize only the missing pieces
      if (needHeader){
        var h = build('tpl-partner-header');
        if (h) root.appendChild(h);
      }
      if (needCard){
        var c = build('tpl-partner-card');
        if (c) root.appendChild(c);
      }
      return false;
    }
    // Otherwise, do nothing here and allow native handler to proceed normally
  }, true); // capture phase
})();
</script><script>
/* Override Partner Add: always inserts fresh Partner header + card (works even after deletes) */
(function(){
  var preview = document.getElementById('preview') || document.body;
  var btn = document.getElementById('add-partner');
  if (!preview || !btn) return;

  // Ensure templates exist (idempotent)
  function ensureTemplate(id, html){
    if (!document.getElementById(id)){
      var t = document.createElement('template');
      t.id = id;
      t.innerHTML = html.trim();
      document.body.appendChild(t);
    }
  }

  ensureTemplate('tpl-partner-header', '\
    <div class="be-block" data-type="partner-header" data-label="Partner header">\
      <div class="be-label"><i class="dot"></i><span>Partner header</span></div>\
      <div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button></div>\
      <table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>\
        <table class="container" role="presentation" width="685"><tbody><tr><td>\
          <h3 class="font-sans">Partner</h3>\
        </td></tr></tbody></table>\
      </td></tr></tbody></table>\
    </div>\
  ');

  ensureTemplate('tpl-partner-card', '\
    <div class="be-block" data-type="partner-card" data-label="Partner card">\
      <div class="be-label"><i class="dot"></i><span>Partner card</span></div>\
      <div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button></div>\
      <table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>\
        <table class="container bg-white" role="presentation" width="685"><tbody><tr><td class="px-25">\
          <p class="font-sans">Partner content…</p>\
        </td></tr></tbody></table>\
      </td></tr></tbody></table>\
    </div>\
  ');

  function fromTemplate(id){
    var t = document.getElementById(id);
    return (t && t.content && t.content.firstElementChild) ? t.content.firstElementChild.cloneNode(true) : null;
  }
  function cloneExisting(sel){
    var n = preview.querySelector(sel);
    return n ? n.cloneNode(true) : null;
  }
  function minimal(type, label, inner){
    var wrap = document.createElement('div');
    wrap.innerHTML = (
      '<div class="be-block" data-type="'+type+'" data-label="'+label+'">'+
        '<div class="be-label"><i class="dot"></i><span>'+label+'</span></div>'+
        '<div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button></div>'+
        inner+
      '</div>'
    );
    return wrap.firstElementChild;
  }
  function buildHeader(){
    return fromTemplate('tpl-partner-header')
        || cloneExisting('.be-block[data-type="partner-header"]')
        || minimal('partner-header','Partner header',
           '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>'+
           '<table class="container" role="presentation" width="685"><tbody><tr><td><h3 class="font-sans">Partner</h3></td></tr></tbody></table>'+
           '</td></tr></tbody></table>');
  }
  function buildCard(){
    return fromTemplate('tpl-partner-card')
        || cloneExisting('.be-block[data-type="partner-card"]')
        || minimal('partner-card','Partner card',
           '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>'+
           '<table class="container bg-white" role="presentation" width="685"><tbody><tr><td class="px-25">'+
           '<p class="font-sans">Partner content…</p></td></tr></tbody></table>'+
           '</td></tr></tbody></table>');
  }

  // Replace the Partner button node to drop ALL existing listeners, then attach our own
  var freshBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(freshBtn, btn);

  freshBtn.addEventListener('click', function(e){
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    var header = buildHeader();
    var card   = buildCard();
    if (header) preview.appendChild(header);
    if (card)   preview.appendChild(card);

    try { if (typeof updateBadge === 'function') updateBadge(); } catch(_){}
  }, false);
})();
</script><script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script><script>
/* Global spacer helper (idempotent) */
window.addSpacersToContent = window.addSpacersToContent || function(html){
  try{
    var doc = document.implementation.createHTMLDocument('spacers');
    var c = doc.createElement('div'); c.innerHTML = html;
    var blockSelectors = ['p','ul','ol','h1','h2','h3','h4','h5','h6','table','blockquote','pre','img','figure'];
    blockSelectors.forEach(function(tag){
      Array.prototype.slice.call(c.querySelectorAll(tag)).forEach(function(el){
        // skip empty paragraphs
        if (tag==='p' && !el.textContent.trim() && !el.querySelector('img,table,ul,ol')) return;
        var next = el.nextSibling;
        var isSpacer = next && next.nodeType===1 && next.classList && next.classList.contains('spacer-20');
        if (!isSpacer){
          var d = doc.createElement('div');
          d.className = 'spacer-20';
          d.innerHTML = '&hairsp;';
          el.parentNode.insertBefore(d, next);
        }
      });
    });
    return c.innerHTML;
  }catch(e){
    return html;
  }
};

/* Import DOCX (marker-based)
  function addSpacersToContent(html){
    try{
      var doc = document.implementation.createHTMLDocument('spacers');
      var c = doc.createElement('div'); c.innerHTML = html;
      var blockSelectors = ['p','ul','ol','h1','h2','h3','h4','h5','h6','table','blockquote','pre','img','figure'];
      // Add spacer after each matching element (if not already directly followed by a spacer)
      blockSelectors.forEach(function(tag){
        Array.from(c.querySelectorAll(tag)).forEach(function(el){
          // skip empty paragraphs
          if (tag==='p' && !el.textContent.trim() && !el.querySelector('img,table,ul,ol')) return;
          var next = el.nextSibling;
          var isSpacer = next && next.nodeType===1 && next.classList && next.classList.contains('spacer-20');
          if (!isSpacer){
            var d = doc.createElement('div');
            d.className = 'spacer-20';
            d.innerHTML = '&hairsp;';
            el.parentNode.insertBefore(d, next);
          }
        });
      });
      return c.innerHTML;
    }catch(e){
      return html;
    }
  }
 → Primary/Secondary/Partner cards with Primary outline */
(function(){
  if (window.__docxImportBoundMarkers) return; window.__docxImportBoundMarkers = true;

  var preview = document.getElementById('preview') || document.body;
  var btn = document.getElementById('import-docx');
  var input = document.getElementById('docx-file');

  /* Keep anchors: header/hero/date/author, Subscribe CTA, Disclaimer, Dynamic */
  function keepBlock(block){
    var lbl  = (block && block.getAttribute && block.getAttribute('data-label')) || '';
    var type = (block && block.getAttribute && block.getAttribute('data-type')) || '';
    if (/header|hero banner|author banner|date bar/i.test(lbl)) return true;
    if (/subscribe cta line/i.test(lbl)) return true;
    if (/disclaimer/i.test(type) || /disclaimer/i.test(lbl)) return true;
    if (/dynamic content block/i.test(lbl)) return true;
    return false; // remove others (incl. partner) before import
  }
  function removeExistingCards(){
    Array.from(preview.querySelectorAll('.be-block')).forEach(function(b){
      if (!keepBlock(b)) b.remove();
    });
  }

  /* Primary-style scaffolds (outline + rounded corners + spacing) */
  function insertAtAnchor(wrap){
    var anchor = preview.querySelector('.be-block[data-label*="Subscribe CTA line"]')
        || preview.querySelector('.be-block[data-type="disclaimer"]')
        || Array.from(preview.querySelectorAll('.be-block')).find(function(b){
             var l = (b.dataset && b.dataset.label)||''; return /dynamic content block/i.test(l);
           });
    if (anchor && anchor.parentNode) anchor.parentNode.insertBefore(wrap, anchor);
    else preview.appendChild(wrap);
  }

  function primaryScaffold(innerHtml, idx){
  innerHtml = window.addSpacersToContent(innerHtml);

  innerHtml = addSpacersToContent(innerHtml);

    var wrap = document.createElement('div');
    wrap.className = 'be-block font-roboto';
    wrap.setAttribute('data-type','primary');
    wrap.setAttribute('data-label','Imported card ' + (idx+1));
    wrap.innerHTML =
      '<div class="be-label"><i class="dot"></i><span>Imported card ' + (idx+1) + '</span></div>' +
      '<div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button></div>' +
      '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>' +
      '  <table cellpadding="0" cellspacing="0" class="container bg-white" role="presentation" width="685" style="border:2px solid #232021;border-radius:22px;">' +
      '    <tbody><tr><td class="px-25" style="padding:20px 25px 20px 25px;"><div class="font-sans fs-16" contenteditable="true">' + innerHtml + '</div></td></tr></tbody>' +
      '  </table>' +
      '</td></tr></tbody></table>' +
      '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>' +
      '  <table class="container" role="presentation" width="685"><tbody><tr><td><div class="spacer-20">&hairsp;</div></td></tr></tbody></table>' +
      '</td></tr></tbody></table>';
    insertAtAnchor(wrap);
  }

  

function secondaryScaffold(innerHtml, idx){
  // Ensure internal content elements have spacers
  innerHtml = window.addSpacersToContent ? window.addSpacersToContent(innerHtml) : innerHtml;

  var wrap = document.createElement('div');
  wrap.className = 'be-block font-roboto';
  wrap.setAttribute('data-type','secondary');
  wrap.setAttribute('data-label','Imported card ' + (idx+1));
  wrap.innerHTML =
    '<div class="be-label"><i class="dot"></i><span>Imported card ' + (idx+1) + '</span></div>'+
    '<div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button></div>'+
    '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>'+
      '<table cellpadding="0" cellspacing="0" class="container bg-cream card" role="presentation" width="685">'+
        '<tbody>'+
          '<tr><td class="px-25 pt-20">'+ innerHtml +'</td></tr>'+
          '<tr><td class="px-25"><div class="spacer-20">&hairsp;</div></td></tr>'+
        '</tbody>'+
      '</table>'+
    '</td></tr></tbody></table>';

  // Insert the card at the correct anchor
  insertAtAnchor(wrap);

  // Add an external spacer row after the card, to mirror template spacing
  try {
    var spacerTable = document.createElement('table');
    spacerTable.setAttribute('cellpadding','0');
    spacerTable.setAttribute('cellspacing','0');
    spacerTable.setAttribute('role','presentation');
    spacerTable.setAttribute('width','100%');
    spacerTable.className = 'row';
    spacerTable.innerHTML =
      '<tbody><tr><td>'+
        '<table class="container" role="presentation" width="685">'+
          '<tbody><tr><td><div class="spacer-20">&hairsp;</div></td></tr></tbody>'+
        '</table>'+
      '</td></tr></tbody>';
    wrap.insertAdjacentElement('afterend', spacerTable);
  } catch(e){ /* no-op */ }
}

  function partnerScaffold(headerText, innerHtml, idx){
    var headerTable =
      '<table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace:0;mso-table-rspace:0;margin-left:auto;margin-right:auto;" width="100%">' +
      '<tbody><tr><td align="center">' +
      '<table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="width:685px;max-width:100%;background-color:#1d53ff;border:2px solid #232021;border-radius:22px 22px 0 0;margin-left:auto;margin-right:auto;" width="685">' +
      '<tbody><tr><td style="padding:20px 25px 10px 25px;">' +
      '<p style="margin:0;font-family:Helvetica,Arial,sans-serif;font-size:20px;line-height:1.2;color:#ffffff;"><strong>' + (headerText || 'From Our Partners') + '</strong></p>' +
      '</td></tr></tbody></table>' +
      '</td></tr></tbody></table>';

    var cardTable =
      '<table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace:0;mso-table-rspace:0;margin-left:auto;margin-right:auto;" width="100%">' +
      '<tbody><tr><td align="center">' +
      '<table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="width:685px;max-width:100%;background-color:#ffffff;border:2px solid #232021;border-top:0;border-radius:0 0 22px 22px;margin-left:auto;margin-right:auto;" width="685">' +
      '<tbody><tr><td align="left" style="padding:20px 25px 20px 25px;">' +
      '<div class="font-sans fs-16" contenteditable="true">' + innerHtml + '</div>' +
      '</td></tr></tbody></table>' +
      '</td></tr></tbody></table>';

    var wrap = document.createElement('div');
    wrap.className = 'be-block font-roboto';
    wrap.setAttribute('data-type','partner-card');
    wrap.setAttribute('data-label','Imported partner ' + (idx+1));
    wrap.innerHTML =
      '<div class="be-label"><i class="dot"></i><span>Imported partner ' + (idx+1) + '</span></div>' +
      '<div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button></div>' +
      headerTable + cardTable +
      '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>' +
      '  <table class="container" role="presentation" width="685"><tbody><tr><td><div class="spacer-20">&hairsp;</div></td></tr></tbody></table>' +
      '</td></tr></tbody></table>';
    insertAtAnchor(wrap);
  }

  /* Sanitize Mammoth HTML to an email-safe subset */
  var ALLOWED = new Set(['A','STRONG','EM','U','BR','P','UL','OL','LI','H2','H3','SPAN','B','I']);
  var INLINE_OK = new Set(['font-weight','font-style','text-decoration']);

  function normalizeInline(el){
    var fw=(el.style&&(el.style.fontWeight||'')+'').toLowerCase();
    var fs=(el.style&&(el.style.fontStyle||'')+'').toLowerCase();
    var td=(el.style&&(el.style.textDecoration||'')+'').toLowerCase();
    var wrap=el; function wrapWith(tag){var w=el.ownerDocument.createElement(tag);while(wrap.firstChild) w.appendChild(wrap.firstChild); if (wrap.parentNode) wrap.parentNode.replaceChild(w, wrap); wrap=w;}
    if (fw==='bold'||fw==='700'||fw==='600'||fw==='800'||fw==='900'){ wrapWith('strong'); }
    if (fs==='italic'){ wrapWith('em'); }
    if (td.indexOf('underline')!==-1){ wrapWith('u'); }
    if (wrap.removeAttribute) wrap.removeAttribute('style');
    return wrap;
  }
  function sanitizeNode(node, doc){
    if (node.nodeType===3) return doc.createTextNode(node.nodeValue);
    if (node.nodeType!==1) return doc.createDocumentFragment();
    var tag=node.tagName.toUpperCase();
    if (!ALLOWED.has(tag)){
      var frag=doc.createDocumentFragment(); node.childNodes.forEach(function(ch){ frag.appendChild(sanitizeNode(ch,doc)); }); return frag;
    }
    var out=doc.createElement(tag);
    if (tag==='A'){
      var href=node.getAttribute('href')||''; if (/^(https?:|mailto:)/i.test(href)){ out.setAttribute('href',href); out.setAttribute('target','_blank'); out.setAttribute('rel','noopener'); }
    } else if (tag==='SPAN' || tag==='B' || tag==='I'){
      var kept=[], style=node.getAttribute('style')||''; style.split(';').forEach(function(r){ var kv=r.split(':'); if (kv.length===2){ var k=kv[0].trim().toLowerCase(), v=kv[1].trim(); if (INLINE_OK.has(k)) kept.push(k+':'+v); } });
      if (kept.length) out.setAttribute('style', kept.join(';'));
    }
    node.childNodes.forEach(function(ch){ out.appendChild(sanitizeNode(ch,doc)); });
    if (out.tagName==='SPAN' && out.hasAttribute('style')) out=normalizeInline(out);
    if (out.tagName==='B'){ var s=doc.createElement('strong'); while(out.firstChild) s.appendChild(out.firstChild); out=s; }
    if (out.tagName==='I'){ var e=doc.createElement('em'); while(out.firstChild) e.appendChild(out.firstChild); out=e; }
    if (out.removeAttribute){ out.removeAttribute('id'); out.removeAttribute('class'); }
    return out;
  }
  function sanitizeHtml(html){
    var doc=document.implementation.createHTMLDocument('docx');
    var c=doc.createElement('div'); c.innerHTML=html;
    // Unwrap <p><hr></p> into standalone <hr>
    c.querySelectorAll('p').forEach(function(p){ var hr=p.querySelector('hr'); if (hr){ p.parentNode.insertBefore(hr,p); if(!p.textContent.trim()) p.remove(); } });
    // Convert paragraphs of only ---/***/___/—— into <hr>
    c.querySelectorAll('p').forEach(function(p){ var t=(p.textContent||'').trim(); if (/^(?:-{3,}|\*{3,}|_{3,}|\u2014{2,})$/.test(t)){ var hr=doc.createElement('hr'); p.parentNode.insertBefore(hr,p); p.remove(); } });

    // Sanitize into array (single chunk, we split later with markers)
    var out=[], fdoc=document.implementation.createHTMLDocument('frag'), frag=fdoc.createDocumentFragment();
    Array.from(c.childNodes).forEach(function(n){ frag.appendChild(sanitizeNode(n,fdoc)); });
    var tmp=fdoc.createElement('div'); tmp.appendChild(frag);
    out.push(tmp.innerHTML);
    return out;
  }

  /* Marker-based segmentation */
  function parseSegmentsWithMarkers(html){
    var doc=document.implementation.createHTMLDocument('docx-markers');
    var container=doc.createElement('div'); container.innerHTML=html;

    var partnerHeaderText='';
    container.querySelectorAll('*').forEach(function(el){
      if (el.innerHTML && el.innerHTML.indexOf('{{ partner-header }}')!==-1){
        partnerHeaderText = el.textContent.replace('{{ partner-header }}','').trim();
        el.innerHTML = el.innerHTML.replace('{{ partner-header }}','');
      }
    });

    ['primary','secondary','partner'].forEach(function(kind){
      var re=new RegExp('\\{\\{\\s*end-'+kind+'\\s*\\}\\}','gi');
      container.innerHTML = container.innerHTML.replace(re, '<hr data-marker="end-'+kind+'">');
    });

    var segments=[], buf=doc.createElement('div');
    function push(kind){
      var html=buf.innerHTML.trim();
      if (html.replace(/<[^>]+>/g,'').trim().length===0){ buf.innerHTML=''; return; }
      segments.push({kind:kind, html:html}); buf.innerHTML='';
    }
    Array.from(container.childNodes).forEach(function(n){
      if (n.nodeType===1 && n.tagName.toUpperCase()==='HR' && n.hasAttribute('data-marker')){
        var mk=n.getAttribute('data-marker');
        if (mk==='end-primary') push('primary');
        else if (mk==='end-secondary') push('secondary');
        else if (mk==='end-partner') push('partner');
      } else {
        buf.appendChild(n.cloneNode(true));
      }
    });
    if (buf.innerHTML.trim().length){ push('primary'); } // default trailing chunk
    return {segments:segments, partnerHeaderText:partnerHeaderText};
  }

  async function docxToHtml(file){
    if (!window.mammoth) throw new Error('Mammoth.js not loaded');
    var array = await file.arrayBuffer();
    var res = await window.mammoth.convertToHtml({arrayBuffer: array}, {
      styleMap:[ "b => strong", "i => em", "u => u", "p[style-name='Heading 2'] => h2", "p[style-name='Heading 3'] => h3" ]
    });
    return res.value || "";
  }

  async function handleFile(file){
    /* Safe partner purge (minimal) */
    (function(){
      try{
        var root = document.getElementById('preview') || document.getElementById('nl-container') || document.body;
        if (!root) return;
        root.querySelectorAll('[data-type="partner-header"], [data-type="partner-card"]').forEach(function(n){ n.remove(); });
        Array.prototype.forEach.call(root.querySelectorAll('.be-block[data-label]'), function(n){
          var lbl = (n.getAttribute('data-label')||'').toLowerCase();
          if (lbl.indexOf('partner') !== -1) n.remove();
        });
      }catch(e){ /* no-op */ }
    })();

    try{
      var raw = await docxToHtml(file);
      var parts = sanitizeHtml(raw);
      var parsed = parseSegmentsWithMarkers(parts.join("\n"));
      removeExistingCards();
      var count=0;
      parsed.segments.forEach(function(seg){
        if (seg.kind==='primary')   primaryScaffold(seg.html, count++);
        else if (seg.kind==='secondary') secondaryScaffold(seg.html, count++);
        else if (seg.kind==='partner')   partnerScaffold(parsed.partnerHeaderText, seg.html, count++);
      });
      if (typeof window.__updateBeCount==='function') window.__updateBeCount();
      if (typeof showToast==='function') showToast('Imported ' + count + ' card(s) from DOCX');
    }catch(e){
      alert('DOCX import failed: ' + (e && e.message?e.message:e));
    }
  }

  if (btn && input){
    btn.addEventListener('click', function(e){ e.preventDefault(); input.click(); });
    input.addEventListener('change', function(){
      var f = input.files && input.files[0];
      if (f) handleFile(f);
      input.value='';
    });
  }
})();
</script><div id="export-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99998;"><div style="position:absolute;left:50%;top:10%;transform:translate(-50%,-50%);background:#fff;width:min(900px,90vw);max-height:80vh;overflow:auto;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:16px;"><div style="font:600 16px/1.2 system-ui,Segoe UI,Arial,sans-serif;margin-bottom:8px;">Export HTML</div><pre id="export-code" style="background:#111;color:#fff;padding:12px;border-radius:8px;white-space:pre-wrap;word-break:break-word;max-height:12vh;overflow:auto;"></pre><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;"><button id="export-copy" style="padding:8px 12px;border:1px solid #005bfb;border-radius:8px;background:#005bfb;color:#fff;cursor:pointer;">Copy email HTML</button><button id="export-close" style="padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:#f7f7f7;cursor:pointer;">Close</button></div></div></div><div id="be-toast" style="position:fixed;z-index:99999;bottom:16px;right:16px;background:#232021;color:#fff;padding:10px 12px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.25);font:500 13px/1.3 system-ui,Segoe UI,Arial,sans-serif;opacity:0;transition:opacity .2s;">Copied to clipboard</div><script>
(function(){
  var r = document.getElementById('be-reset');
  if (!r) return;
  r.addEventListener('click', function(ev){
    ev.preventDefault();
    ev.stopPropagation();
    try { location.reload(); } catch(e){ console && console.warn('Reload failed', e); }
  }, false);
})();
</script><script>
(function(){
  // Hard reset bindings by replacing the button as well (drops legacy listeners)
  var btn = document.getElementById('import-docx');
  if (!btn) return;
  var parent = btn.parentNode;
  var cloneBtn = btn.cloneNode(true);
  // Preserve id/class/style/text
  parent.replaceChild(cloneBtn, btn);
  btn = cloneBtn;

  var inp = document.getElementById('docx-file');
  if (!inp) return;

  // Guard to ensure we only ever bind once
  if (btn.__importBoundOnce) return;
  btn.__importBoundOnce = true;

  function toast(msg){
    var t=document.getElementById('be-toast');
    if (t){ t.textContent = msg; t.style.opacity='1'; setTimeout(function(){ t.style.opacity='0'; }, 1400); }
    else { try { console.log(msg); } catch(e){} }
  }

  btn.onclick = function(ev){
    ev.preventDefault(); ev.stopPropagation();
    // prevent accidental double trigger if inside a label or nested element
    setTimeout(function(){ inp.click(); }, 0);
  };

  inp.onchange = async function(){
    var f = inp.files && inp.files[0];
    if (!f){ return; } // silent cancel
    try{
      if (typeof handleFile !== 'function') throw new Error('Importer not initialized');
      await handleFile(f);
      toast('Imported: ' + (f.name || 'document'));
    }catch(err){
      console.error(err);
      toast('Import failed: ' + (err && err.message ? err.message : err));
    }finally{
      // Allow selecting the same file again
      inp.value = '';
    }
  };
})();
</script><script>
/* Fallback importer (safe no-op if main importer exists) */
(function(){
  if (typeof handleFile === 'function') return;
  async function docxToHtml(file){
    if (window.ensureMammoth) { try { await window.ensureMammoth(); } catch(e){} }
    if (window.mammoth){
      const buf = await file.arrayBuffer();
      const res = await mammoth.convertToHtml({arrayBuffer: buf});
      return '<div>' + (res && res.value ? res.value : '') + '</div>';
    } else {
      throw new Error('Mammoth not available; try HTML import');
    }
  }
  window.handleFile = async function(file){
    var name = (file && file.name || '').toLowerCase();
    var htmlRaw;
    if (name.endsWith('.html') || name.endsWith('.htm') || file.type === 'text/html'){
      htmlRaw = await file.text();
    } else if (name.endsWith('.txt') || file.type === 'text/plain'){
      htmlRaw = await file.text();
      htmlRaw = htmlRaw.replace(/^[ \t]*-{3,}[ \t]*$/gm, '<hr data-marker="end-primary">');
      htmlRaw = htmlRaw.replace(/\n{2,}/g, '</p><p>').replace(/\n/g, '<br>');
      htmlRaw = '<div><p>' + htmlRaw + '</p></div>';
    } else {
      htmlRaw = await docxToHtml(file);
    }
    // Minimal insertion: append a single primary card with the imported HTML (for debugging pipeline)
    var root = document.getElementById('nl-container') || document.getElementById('preview') || document.body;
    var wrapper = document.createElement('div');
    wrapper.className = 'be-block';
    wrapper.setAttribute('data-type','primary');
    wrapper.setAttribute('data-label','Imported (debug)');
    wrapper.innerHTML = ''
      + '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">'
      + '<tbody><tr><td>'
      + '<table cellpadding="0" cellspacing="0" class="container bg-white card" role="presentation" width="685">'
      + '<tbody><tr><td class="px-25 py-20 font-sans fs-16 text-dark"></td></tr></tbody></table>'
      + '</td></tr></tbody></table>';
    wrapper.querySelector('td.px-25').innerHTML = htmlRaw;
    root.appendChild(wrapper);
    var t=document.getElementById('be-toast'); if(t){ t.textContent='Imported (fallback)'; t.style.opacity='1'; setTimeout(function(){ t.style.opacity='0'; }, 1200); }
  };
})();
</script><script>
(function(){
  var btn = document.getElementById('import-docx');
  var inp = document.getElementById('docx-file');
  if (!btn || !inp) return;
  btn.onclick = function(ev){ ev.preventDefault(); ev.stopPropagation(); setTimeout(function(){ inp.click(); }, 0); };
  inp.onchange = async function(){
    var f = inp.files && inp.files[0];
    if(!f){ return; }
    try{
      if (typeof handleFile !== 'function') throw new Error('handleFile missing');
      await handleFile(f);
    }catch(e){
      var t=document.getElementById('be-toast'); if(t){ t.textContent='Import failed: '+(e.message||e); t.style.opacity='1'; setTimeout(function(){ t.style.opacity='0'; }, 1600); }
    }finally{
      inp.value='';
    }
  };
})();
</script><script>
(function(){
  // Debug panel
  function toast(msg){
    try{
      var t=document.getElementById('be-toast');
      if(t){ t.textContent=String(msg); t.style.opacity='1'; setTimeout(function(){ t.style.opacity='0'; }, 1600); }
      else { console.log(msg); }
    }catch(e){}
  }
  async function docxToHtml(file){
    await (window.ensureMammoth ? window.ensureMammoth() : Promise.resolve());
    if (!window.mammoth) throw new Error('Mammoth not available');
    const buf = await file.arrayBuffer();
    const res = await mammoth.convertToHtml({arrayBuffer: buf});
    return '<div>' + (res && res.value ? res.value : '') + '</div>';
  }
  window.handleFile = async function(file){
    // Basic, guaranteed pipeline: convert to HTML string
    var name = (file && file.name || '').toLowerCase();
    var htmlRaw;
    if (name.endsWith('.html') || name.endsWith('.htm') || file.type === 'text/html'){
      htmlRaw = await file.text();
    } else if (name.endsWith('.txt') || file.type === 'text/plain'){
      htmlRaw = await file.text();
      htmlRaw = htmlRaw.replace(/^[ \t]*-{3,}[ \t]*$/gm, '<hr data-marker="end-primary">');
      htmlRaw = htmlRaw.replace(/\n{2,}/g, '</p><p>').replace(/\n/g, '<br>');
      htmlRaw = '<div><p>' + htmlRaw + '</p></div>';
    } else {
      htmlRaw = await docxToHtml(file);
    }

    // Remove partner blocks before import
    try{
      var root = document.getElementById('nl-container') || document.getElementById('preview') || document.body;
      root.querySelectorAll('[data-type="partner-header"], [data-type="partner-card"]').forEach(function(n){ n.remove(); });
      root.querySelectorAll('[data-label]').forEach(function(n){
        var t=(n.getAttribute('data-label')||'').toLowerCase();
        if (t.indexOf('partner')!==-1) n.remove();
      });
    }catch(e){}

    // Split by HR or marker into chunks (very simple)
    var container = document.createElement('div');
    container.innerHTML = htmlRaw;
    var parts = [];
    var current = document.createElement('div');
    function pushCurrent(){
      if (current && current.innerHTML.trim()) parts.push(current);
      current = document.createElement('div');
    }
    Array.from(container.childNodes).forEach(function(node){
      if (node.nodeType===1 && node.tagName==='HR'){ pushCurrent(); }
      else current.appendChild(node.cloneNode(true));
    });
    pushCurrent();
    if (!parts.length){ parts = [container]; }

    // Where to insert: above Subscribe CTA if present; else above Disclaimer; else above Dynamic block; else append
    var root = document.getElementById('nl-container') || document.getElementById('preview') || document.body;
    var anchors = Array.from(root.querySelectorAll('[data-label]'));
    function findByLabel(substr){
      return anchors.find(function(n){ return ((n.getAttribute('data-label')||'').toLowerCase().indexOf(substr)>=0); });
    }
    var beforeNode = findByLabel('subscribe cta line') || findByLabel('disclaimer') || findByLabel('dynamic content block');
    var mount = beforeNode ? beforeNode : null;

    // Build primary-styled cards and insert
    parts.forEach(function(part, idx){
      var wrap = document.createElement('div');
      wrap.className = 'be-block';
      wrap.setAttribute('data-type','primary');
      wrap.setAttribute('data-label', 'Imported card');
      wrap.innerHTML = ''
        + '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>'
        +   '<table cellpadding="0" cellspacing="0" class="container bg-white card" role="presentation" width="685">'
        +     '<tbody><tr><td class="px-25 py-20 font-sans fs-16 text-dark"></td></tr></tbody>'
        +   '</table>'
        + '</td></tr></tbody></table>';
      wrap.querySelector('td.px-25').innerHTML = part.innerHTML;
      if (mount && mount.parentNode){
        mount.parentNode.insertBefore(wrap, mount);
      } else {
        root.appendChild(wrap);
      }
    });

    toast('Imported ' + parts.length + ' card(s)');
  };

  // Single binding for button/input
  var btn = document.getElementById('import-docx');
  var inp = document.getElementById('docx-file');
  if (btn && inp){
    btn.onclick = function(ev){ ev.preventDefault(); ev.stopPropagation(); setTimeout(function(){ inp.click(); },0); };
    inp.onchange = function(){
      var f = inp.files && inp.files[0];
      if (!f) return;
      handleFile(f).catch(function(e){ toast('Import failed: ' + (e.message||e)); });
      inp.value='';
    };
  }
})();</script><script>
window.ensureMammoth = function(){
  if (window.mammoth) return Promise.resolve();
  return new Promise(function(resolve, reject){
    var s=document.createElement('script');
    s.src='https://unpkg.com/mammoth/mammoth.browser.min.js';
    s.async=true;
    s.onload=function(){ resolve(); };
    s.onerror=function(){ reject(new Error('Failed to load Mammoth.js')); };
    document.head.appendChild(s);
  });
};
</script><script>
(function(){
  // Run after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupFix, { once: true });
  } else {
    setupFix();
  }

  function setupFix(){
    const preview = document.getElementById('preview');
    if (!preview) return;

    // Replace buttons with clean clones to drop any older listeners
    function resetButton(id){
      const btn = document.getElementById(id);
      if (!btn) return null;
      const clone = btn.cloneNode(true);
      btn.replaceWith(clone);
      return clone;
    }

    const addPrimary   = resetButton('add-primary');
    const addSecondary = resetButton('add-secondary');
    const addPartner   = resetButton('add-partner');

    const badge = document.getElementById('be-count');
    function updateBadge(){
      if (badge) badge.textContent = (preview.querySelectorAll('.be-block').length) + ' blocks';
    }
    updateBadge();

    const isLocked = b => (b?.dataset?.type === 'locked');

    function area(el){
      const r = el.getBoundingClientRect();
      return (r.width || 1) * (r.height || 1);
    }

    function tableCount(el){
      // prefer a direct table (common for unit blocks)
      const direct = el.querySelectorAll(':scope > table').length;
      return direct || el.querySelectorAll('table').length;
    }

    function pickTemplate(type){
      const all = Array.from(preview.querySelectorAll('.be-block')).filter(Boolean);
      const candidates = all.filter(b => b.dataset && b.dataset.type === type && !isLocked(b));
      if (!candidates.length) return null;

      const scored = candidates.map(el => ({
        el, tables: tableCount(el), area: area(el)
      }));

      const singles = scored.filter(s => s.tables === 1);
      const pool = singles.length ? singles : scored;
      const chosen = pool.sort((a,b) => a.area - b.area)[0].el;

      // Deep clone + sanitize duplicate IDs
      const clone = chosen.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));

      // Optional: relabel copy for clarity
      const labelSpan = clone.querySelector('.be-label span');
      const nice = (chosen.dataset && chosen.dataset.label) ? chosen.dataset.label
                 : (type.charAt(0).toUpperCase() + type.slice(1));
      if (labelSpan) labelSpan.textContent = nice + ' (copy)';

      return clone;
    }

    function appendClone(type){
      const node = pickTemplate(type);
      if (!node) {
        // Fallback: take the smallest non-locked block if type not found
        const pool = Array.from(preview.querySelectorAll('.be-block')).filter(b => !isLocked(b));
        if (!pool.length) return;
        const chosen = pool.sort((a,b) => area(a) - area(b))[0];
        const fallback = chosen.cloneNode(true);
        fallback.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));
        preview.appendChild(fallback);
      } else {
        preview.appendChild(node);
      }
      updateBadge();
    }

    if (addPrimary)   addPrimary.addEventListener('click', function(e){ e.preventDefault(); appendClone('primary'); }, { passive:false });
    if (addSecondary) addSecondary.addEventListener('click', function(e){ e.preventDefault(); appendClone('secondary'); }, { passive:false });
    if (addPartner)   addPartner.addEventListener('click', function(e){
      e.preventDefault();
      const header = pickTemplate('partner-header');
      const card   = pickTemplate('partner-card');
      if (header) preview.appendChild(header);
      if (card)   preview.appendChild(card);
      updateBadge();
    }, { passive:false });
  }
})();
</script><script>
(function(){
  // Enhance the safe-clone behavior: Primary must insert a white card like "Story 1 card"
  function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once: true }); else fn(); }
  ready(function(){
    const preview = document.getElementById('preview');
    const addPrimary = document.getElementById('add-primary');
    if (!preview || !addPrimary) return;

    // Overwrite any existing listener by replacing the node
    const btn = addPrimary.cloneNode(true);
    addPrimary.replaceWith(btn);

    function isLocked(b){ return b?.dataset?.type === 'locked'; }

    function area(el){
      const r = el.getBoundingClientRect();
      return (r.width || 1) * (r.height || 1);
    }

    function tableCount(el){
      const direct = el.querySelectorAll(':scope > table').length;
      return direct || el.querySelectorAll('table').length;
    }

    function hasWhiteBg(el){
      // Look for inline styles or attributes indicating white background
      const w = /(#fff(fff)?\\b|\\bwhite\\b)/i;
      if (el.getAttribute('bgcolor') && w.test(el.getAttribute('bgcolor'))) return true;
      if (el.hasAttribute('style') && w.test(el.getAttribute('style'))) return true;
      // Check tables within
      const t = el.querySelector('table');
      if (t){
        if (t.getAttribute('bgcolor') && w.test(t.getAttribute('bgcolor'))) return true;
        if (t.hasAttribute('style') && w.test(t.getAttribute('style'))) return true;
      }
      return false;
    }

    function textIncludes(el, s){
      return (el.textContent || '').toLowerCase().includes(s.toLowerCase());
    }

    function findStory1Primary(){
      const primaries = Array.from(preview.querySelectorAll('.be-block')).filter(b => b.dataset?.type === 'primary' && !isLocked(b));
      if (!primaries.length) return null;

      // 1) Exact label match in data-label or visible label
      let exact = primaries.find(b => /story\\s*1/i.test(b.dataset?.label || ''));
      if (!exact){
        exact = primaries.find(b => /story\\s*1/i.test((b.querySelector('.be-label')?.textContent)||''));
      }
      if (exact) return exact;

      // 2) Prefer white background + single table
      const scored = primaries.map(el => ({
        el,
        white: hasWhiteBg(el) ? 1 : 0,
        tables: tableCount(el),
        area: area(el),
        storyHint: (/(story|card)/i.test(el.dataset?.label || '') || /(story|card)/i.test((el.querySelector('.be-label')?.textContent)||'')) ? 1 : 0,
      }));

      scored.sort((a,b)=>{
        // Prefer white, then story hint, then single-table, then smallest area
        return (b.white - a.white) || (b.storyHint - a.storyHint) || ((a.tables===1)-(b.tables===1)) || (a.area - b.area);
      });

      return scored[0]?.el || null;
    }

    function cloneSanitized(node){
      const clone = node.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));
      const labelSpan = clone.querySelector('.be-label span');
      const nice = (node.dataset && node.dataset.label) ? node.dataset.label : 'Primary';
      if (labelSpan) labelSpan.textContent = nice + ' (copy)';
      return clone;
    }

    btn.addEventListener('click', function(e){
      e.preventDefault();
      let chosen = findStory1Primary();
      if (!chosen){
        // Fallback: smallest non-locked primary; then any smallest non-locked block
        const primaries = Array.from(preview.querySelectorAll('.be-block')).filter(b => b.dataset?.type === 'primary' && !isLocked(b));
        if (primaries.length){
          primaries.sort((a,b)=> area(a) - area(b));
          chosen = primaries[0];
        } else {
          const pool = Array.from(preview.querySelectorAll('.be-block')).filter(b => !isLocked(b));
          if (!pool.length) return;
          pool.sort((a,b)=> area(a) - area(b));
          chosen = pool[0];
        }
      }
      const copy = cloneSanitized(chosen);
      preview.appendChild(copy);
      const badge = document.getElementById('be-count');
      if (badge) badge.textContent = (preview.querySelectorAll('.be-block').length) + ' blocks';
    }, { passive:false });
  });
})();
</script><script>
(function(){
  function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once:true }); else fn(); }
  ready(function(){
    const preview = document.getElementById('preview');
    if (!preview) return;

    // Replace buttons to drop previous listeners
    function reset(id){
      const el = document.getElementById(id);
      if (!el) return null;
      const clone = el.cloneNode(true);
      el.replaceWith(clone);
      return clone;
    }
    const addPrimary   = reset('add-primary');
    const addSecondary = reset('add-secondary');
    const addPartner   = reset('add-partner');
    const badge        = document.getElementById('be-count');

    function updateBadge(){
      if (badge) badge.textContent = (preview.querySelectorAll('.be-block').length) + ' blocks';
    }

    function blocks(){ return Array.from(preview.querySelectorAll('.be-block')); }
    function isLocked(b){ return b?.dataset?.type === 'locked'; }
    function area(el){ const r=el.getBoundingClientRect(); return (r.width||1)*(r.height||1); }
    function tableCount(el){ const direct = el.querySelectorAll(':scope > table').length; return direct || el.querySelectorAll('table').length; }
    function hasWhiteBg(el){
      const w=/(#fff(fff)?\b|\bwhite\b)/i;
      if (el.getAttribute('bgcolor') && w.test(el.getAttribute('bgcolor'))) return true;
      if (el.hasAttribute('style') && w.test(el.getAttribute('style'))) return true;
      const t=el.querySelector('table');
      if (t){
        if (t.getAttribute('bgcolor') && w.test(t.getAttribute('bgcolor'))) return true;
        if (t.hasAttribute('style') && w.test(t.getAttribute('style'))) return true;
      }
      return false;
    }

    function pickPrimary(){
      const primaries = blocks().filter(b => b.dataset?.type === 'primary' && !isLocked(b));
      if (!primaries.length) return null;
      let exact = primaries.find(b => /story\s*1/i.test(b.dataset?.label||''))
             ||  primaries.find(b => /story\s*1/i.test((b.querySelector('.be-label')?.textContent)||''));
      if (exact) return exact;
      const scored = primaries.map(el => ({
        el, white: hasWhiteBg(el) ? 1 : 0, tables: tableCount(el), area: area(el),
        hint: (/(story|card)/i.test(el.dataset?.label||'') || /(story|card)/i.test((el.querySelector('.be-label')?.textContent)||'')) ? 1 : 0
      }));
      scored.sort((a,b) => (b.white-a.white) || (b.hint-a.hint) || ((a.tables===1)-(b.tables===1)) || (a.area-b.area));
      return scored[0]?.el || null;
    }

    function pickByType(type){
      // Generic picker for non-primary
      const list = blocks().filter(b => b.dataset?.type === type && !isLocked(b));
      if (!list.length) return null;
      // Prefer single table, then smallest
      const scored = list.map(el => ({ el, tables: tableCount(el), area: area(el) }));
      scored.sort((a,b) => ((a.tables===1)-(b.tables===1)) || (a.area - b.area));
      return scored[0].el;
    }

    function cloneSanitized(node, labelFallback){
      const clone = node.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));
      const labelSpan = clone.querySelector('.be-label span');
      const nice = (node.dataset && node.dataset.label) ? node.dataset.label : labelFallback;
      if (labelSpan && nice) labelSpan.textContent = nice + ' (copy)';
      return clone;
    }

    function insertSecondToLast(node){
      const list = blocks();
      if (!list.length){
        preview.appendChild(node);
        return;
      }
      // second-to-last means index length-1
      const idx = Math.max(0, list.length - 1);
      const ref = list[idx];
      ref.before(node);
    }

    // Wire buttons
    if (addPrimary) addPrimary.addEventListener('click', function(e){
      e.preventDefault();
      let chosen = pickPrimary();
      if (!chosen){
        // fallback: smallest non-locked block
        const pool = blocks().filter(b => !isLocked(b));
        if (!pool.length) return;
        pool.sort((a,b)=> area(a) - area(b));
        chosen = pool[0];
      }
      const copy = cloneSanitized(chosen, 'Primary');
      insertSecondToLast(copy);
      updateBadge();
    }, { passive:false });

    if (addSecondary) addSecondary.addEventListener('click', function(e){
      e.preventDefault();
      let chosen = pickByType('secondary');
      if (!chosen){
        const pool = blocks().filter(b => !isLocked(b));
        if (!pool.length) return;
        pool.sort((a,b)=> area(a) - area(b));
        chosen = pool[0];
      }
      const copy = cloneSanitized(chosen, 'Secondary');
      insertSecondToLast(copy);
      updateBadge();
    }, { passive:false });

    if (addPartner) addPartner.addEventListener('click', function(e){
      e.preventDefault();
      const header = pickByType('partner-header');
      const card   = pickByType('partner-card');
      if (header){ insertSecondToLast(cloneSanitized(header, 'Partner header')); }
      if (card){   insertSecondToLast(cloneSanitized(card, 'Partner card')); }
      updateBadge();
    }, { passive:false });

    updateBadge();
  });
})();
</script><script>
(function(){
  function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once:true }); else fn(); }
  ready(function(){
    const preview = document.getElementById('preview');
    if (!preview) return;

    function blocks(){ return Array.from(preview.querySelectorAll('.be-block')); }

    function insertThirdToLast(node){
      const list = blocks();
      if (!list.length){
        preview.appendChild(node);
        return;
      }
      const idx = Math.max(0, list.length - 2);
      const ref = list[idx];
      ref.before(node);
    }

    // Helpers
    function isLocked(b){ return b?.dataset?.type === 'locked'; }
    function area(el){ const r=el.getBoundingClientRect(); return (r.width||1)*(r.height||1); }
    function tableCount(el){ const direct=el.querySelectorAll(':scope > table').length; return direct || el.querySelectorAll('table').length; }
    function hasWhiteBg(el){ const w=/(#fff(fff)?\b|\bwhite\b)/i;
      if(el.getAttribute('bgcolor')&&w.test(el.getAttribute('bgcolor'))) return true;
      if(el.hasAttribute('style')&&w.test(el.getAttribute('style'))) return true;
      const t=el.querySelector('table');
      if(t){ if(t.getAttribute('bgcolor')&&w.test(t.getAttribute('bgcolor'))) return true;
        if(t.hasAttribute('style')&&w.test(t.getAttribute('style'))) return true; }
      return false; }

    function pickPrimary(){
      const primaries=blocks().filter(b=>b.dataset?.type==='primary' && !isLocked(b));
      if(!primaries.length) return null;
      let exact=primaries.find(b=>/story\s*1/i.test(b.dataset?.label||''))
              ||primaries.find(b=>/story\s*1/i.test((b.querySelector('.be-label')?.textContent)||''));
      if(exact) return exact;
      const scored=primaries.map(el=>({
        el,white:hasWhiteBg(el)?1:0,tables:tableCount(el),area:area(el),
        hint:(/(story|card)/i.test(el.dataset?.label||'')||/(story|card)/i.test((el.querySelector('.be-label')?.textContent)||''))?1:0
      }));
      scored.sort((a,b)=>(b.white-a.white)||(b.hint-a.hint)||((a.tables===1)-(b.tables===1))||(a.area-b.area));
      return scored[0]?.el||null;
    }

    function pickByType(type){
      const list=blocks().filter(b=>b.dataset?.type===type && !isLocked(b));
      if(!list.length) return null;
      const scored=list.map(el=>({el,tables:tableCount(el),area:area(el)}));
      scored.sort((a,b)=>((a.tables===1)-(b.tables===1))||(a.area-b.area));
      return scored[0].el;
    }

    function cloneSanitized(node,labelFallback){
      const clone=node.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(n=>n.removeAttribute('id'));
      const labelSpan=clone.querySelector('.be-label span');
      const nice=(node.dataset&&node.dataset.label)?node.dataset.label:labelFallback;
      if(labelSpan&&nice) labelSpan.textContent=nice+' (copy)';
      return clone;
    }

    function reset(id){
      const el=document.getElementById(id);
      if(!el) return null;
      const clone=el.cloneNode(true);
      el.replaceWith(clone);
      return clone;
    }

    const addPrimary=reset('add-primary');
    const addSecondary=reset('add-secondary');
    const addPartner=reset('add-partner');
    const badge=document.getElementById('be-count');
    function updateBadge(){ if(badge) badge.textContent=blocks().length+' blocks'; }

    if(addPrimary) addPrimary.addEventListener('click', function(e){
      e.preventDefault();
      let chosen=pickPrimary();
      if(!chosen){
        const pool=blocks().filter(b=>!isLocked(b));
        if(!pool.length) return;
        pool.sort((a,b)=>area(a)-area(b));
        chosen=pool[0];
      }
      const copy=cloneSanitized(chosen,'Primary');
      insertThirdToLast(copy);
      updateBadge();
    });

    if(addSecondary) addSecondary.addEventListener('click', function(e){
      e.preventDefault();
      let chosen=pickByType('secondary');
      if(!chosen){
        const pool=blocks().filter(b=>!isLocked(b));
        if(!pool.length) return;
        pool.sort((a,b)=>area(a)-area(b));
        chosen=pool[0];
      }
      const copy=cloneSanitized(chosen,'Secondary');
      insertThirdToLast(copy);
      updateBadge();
    });

    if(addPartner) addPartner.addEventListener('click', function(e){
      e.preventDefault();
      const header=pickByType('partner-header');
      const card=pickByType('partner-card');
      if(header) insertThirdToLast(cloneSanitized(header,'Partner header'));
      if(card) insertThirdToLast(cloneSanitized(card,'Partner card'));
      updateBadge();
    });

    updateBadge();
  });
})();
</script><script>
(function(){
  function onReady(fn){
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once:true });
    else fn();
  }
  function afterLoad(fn){
    if (document.readyState === 'complete') fn();
    else window.addEventListener('load', fn, { once:true });
  }

  function mergePartnerBlocks(){
    const preview = document.getElementById('preview') || document.body;
    const header = preview.querySelector('.be-block[data-type="partner-header"]');
    if (!header) return;
    let card = header.nextElementSibling;
    if (!card || !(card.classList && card.classList.contains('be-block')) || card.dataset.type !== 'partner-card'){
      // try to find the nearest following partner-card
      card = preview.querySelector('.be-block[data-type="partner-card"]');
      if (!card) return;
    }

    // Move ALL children of card into header, preserve order (content first)
    const marker = document.createComment('moved-partner-card-start');
    header.appendChild(marker);
    while (card.firstChild){
      header.appendChild(card.firstChild);
    }
    card.remove();

    // Remove any nested labels/toolbars created inside the moved content (but keep header's own direct ones)
    header.querySelectorAll(':scope .be-label, :scope .be-block-toolbar').forEach(function(el){
      if (el.parentElement !== header){
        el.remove();
      }
    });

    // Zero the gap between header piece and moved card content
    header.style.margin = '0';
    header.style.borderRadius = '22px';
    header.style.overflow = 'hidden'; /* let editor clip inner blue bar correctly */
    const tds = header.querySelectorAll('td');
    tds.forEach(function(td){
      const s = td.getAttribute('style') || '';
      let ns = s.replace(/padding-top\s*:\s*[^;]+;?/gi,'').replace(/padding-bottom\s*:\s*[^;]+;?/gi,'');
      td.setAttribute('style', (ns ? ns + ';' : '') + '');
    });
  }

  // Optional: lightweight de-duper only for partner-header copies
  function installCopyDeduper(){
    const preview = document.getElementById('preview') || document.body;
    preview.addEventListener('click', function(ev){
      const copyBtn = ev.target.closest && ev.target.closest('.be-ico.be-copy');
      if (!copyBtn) return;
      const blk = copyBtn.closest('.be-block');
      if (!blk) return;
      if (blk.dataset.type !== 'partner-header') return; // only dedupe our merged header

      const before = Array.from(preview.querySelectorAll('.be-block[data-type="partner-header"]'));
      setTimeout(function(){
        const after = Array.from(preview.querySelectorAll('.be-block[data-type="partner-header"]'));
        if (after.length <= before.length) return;
        const idx = after.indexOf(blk);
        const tail = after.slice(idx + 1);
        if (tail.length > 1){
          tail.slice(1).forEach(n => n.remove());
        }
      }, 160);
    }, true); // capture but do not stop propagation
  }

  function main(){
    afterLoad(function(){
      mergePartnerBlocks();
      installCopyDeduper();
    });
  }
  main();
})();
</script><script>
(function(){
  function onReady(fn){
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once:true });
    else fn();
  }
  function afterLoad(fn){
    if (document.readyState === 'complete') fn();
    else window.addEventListener('load', fn, { once:true });
  }

  function text(el){
    return (el?.innerText || '').trim().toLowerCase();
  }

  function findBlockByLabelContains(blocks, needle){
    needle = needle.toLowerCase();
    for (const b of blocks){
      const lab = b.querySelector(':scope > .be-label');
      if (lab && text(lab).includes(needle)) return b;
    }
    return null;
  }

  function mergeIntroGroup(){
    const preview = document.getElementById('preview') || document.body;
    const blocks = Array.from(preview.querySelectorAll('.be-block'));

    const hero   = findBlockByLabelContains(blocks, 'hero banner');
    const date   = findBlockByLabelContains(blocks, 'date bar');
    const author = findBlockByLabelContains(blocks, 'author banner');

    if (!hero || !date || !author) return;

    // Ensure they are in order; if not, sort by document position
    const trio = [hero, date, author].sort((a,b)=> a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING ? -1 : 1);

    // Move DATE + AUTHOR content *into* HERO (keep hero instrumented)
    for (let i=1;i<trio.length;i++){
      const src = trio[i];
      // Remove nested top-level labels/toolbars from src
      src.querySelectorAll(':scope > .be-label, :scope > .be-block-toolbar').forEach(n => n.remove());
      // Move all children into hero (content only)
      while (src.firstChild){
        hero.appendChild(src.firstChild);
      }
      src.remove();
    }

    // Clean labels/toolbars nested inside hero content (keep only hero's direct label)
    hero.querySelectorAll('.be-label, .be-block-toolbar').forEach(n => {
      if (n.parentElement !== hero) n.remove();
    });

    // Rename the remaining label to "Header section"
    let label = hero.querySelector(':scope > .be-label');
    if (label){
      const span = label.querySelector('span');
      if (span){
        span.innerHTML = '<span class="dot"></span> Header section';
      } else {
        label.innerHTML = '<span><span class="dot"></span> Header section</span>';
      }
    } else {
      // If no label, create one
      label = document.createElement('div');
      label.className = 'be-label';
      label.innerHTML = '<span><span class="dot"></span> Header section</span>';
      hero.insertBefore(label, hero.firstChild);
    }

    // Mark as intro-locked for styling/observation
    hero.dataset.type = 'intro-locked';
    hero.dataset.label = 'Header section';

    // Remove the top toolbar entirely for this block
    hero.querySelectorAll(':scope > .be-block-toolbar').forEach(n => n.remove());

    // Tighten internal spacing a bit
    hero.style.margin = '0';
    // Rounded wrapper: we won't force overflow hidden to avoid clipping any editor controls
    hero.style.borderRadius = '22px';

    // Also remove any toolbar/labels that appear later (editor mutations)
    const mo = new MutationObserver(function(muts){
      muts.forEach(m => {
        (m.addedNodes || []).forEach(node => {
          if (!(node instanceof HTMLElement)) return;
          const host = node.closest && node.closest('.be-block');
          if (host === hero){
            // strip any toolbars/labels added within the hero
            hero.querySelectorAll(':scope > .be-block-toolbar').forEach(n => n.remove());
            hero.querySelectorAll('.be-label, .be-block-toolbar').forEach(n => {
              if (n.parentElement !== hero) n.remove();
            });
          }
        });
      });
    });
    mo.observe(hero, { childList:true, subtree:true });
  }

  function installGlobalCSS(){
    const css = document.createElement('style');
    css.textContent = `
      .be-block[data-type="intro-locked"] > .be-block-toolbar{ display:none !important; }
      .be-block[data-type="intro-locked"] .be-block .be-block-toolbar{ display:none !important; }
      .be-block[data-type="intro-locked"] .be-block .be-label{ display:none !important; }
      /* keep the block editable – we're not disabling content editing, only the move/copy/delete UI */
    `;
    document.head.appendChild(css);
  }

  function main(){
    onReady(installGlobalCSS);
    afterLoad(mergeIntroGroup);
  }
  main();
})();
</script><script>
(function(){
  var root = document.getElementById('preview') || document.body;

  function findBlock(el){
    return el && el.closest ? el.closest('.be-block') : null;
  }
  function clearActive(except){
    root.querySelectorAll('.be-block.is-active').forEach(function(n){
      if (n !== except) n.classList.remove('is-active');
    });
  }

  // Mark block active on focus/click inside
  root.addEventListener('focusin', function(e){
    var blk = findBlock(e.target);
    if (!blk) return;
    blk.classList.add('is-active');
    clearActive(blk);
  });
  root.addEventListener('mousedown', function(e){
    var blk = findBlock(e.target);
    if (!blk) return;
    blk.classList.add('is-active');
    clearActive(blk);
  });

  // Remove active when focus leaves the block (with a small delay to allow focus to move within)
  root.addEventListener('focusout', function(e){
    var blk = findBlock(e.target);
    if (!blk) return;
    setTimeout(function(){
      if (!blk.contains(document.activeElement)){
        blk.classList.remove('is-active');
      }
    }, 50);
  });

  // If user clicks outside any block, clear active
  document.addEventListener('click', function(e){
    if (!findBlock(e.target)){
      clearActive(null);
    }
  });
})();
</script><script>
(function(){
  const toolbar = document.getElementById('be-toolbar');
  if (!toolbar) return;

  const root = document.getElementById('preview') || document.body;
  let activeBlock = null, rafId = 0;
  const MARGIN = 8;

  function setVisible(v){ toolbar.classList.toggle('is-visible', v); }
  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function updatePos(){
    rafId = 0;
    if (!activeBlock){
      setVisible(false);
      return;
    }
    const rect = activeBlock.getBoundingClientRect();
    if (!rect || rect.width === 0 || rect.height === 0){
      setVisible(false);
      return;
    }
    const vw = Math.max(document.documentElement.clientWidth,  window.innerWidth  || 0);
    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

    let x = rect.left + rect.width / 2;
    x = clamp(x, MARGIN, vw - MARGIN);

    let top = rect.top - MARGIN;
    if (top < MARGIN){
      top = rect.bottom + MARGIN;
      toolbar.style.transform = 'translate(-50%, 0)';
    } else {
      toolbar.style.transform = 'translate(-50%, -100%)';
    }

    toolbar.style.left = x + 'px';
    toolbar.style.top  = top + 'px';
    setVisible(true);
  }
  function reqUpdate(){ if (!rafId) rafId = requestAnimationFrame(updatePos); }

  function findBlock(el){ return el && el.closest ? el.closest('.be-block') : null; }
  function clearActive(except){
    root.querySelectorAll('.be-block.is-active').forEach(n => { if (n !== except) n.classList.remove('is-active'); });
  }

  // Keep track of the active block
  root.addEventListener('focusin', (e) => { const b = findBlock(e.target); if (b){ activeBlock = b; b.classList.add('is-active'); clearActive(b); reqUpdate(); }});
  root.addEventListener('click',   (e) => { const b = findBlock(e.target); if (b){ activeBlock = b; b.classList.add('is-active'); clearActive(b); reqUpdate(); } else { activeBlock = null; clearActive(null); setVisible(false); }});

  document.addEventListener('selectionchange', reqUpdate);
  window.addEventListener('scroll',  reqUpdate, true);
  window.addEventListener('resize',  reqUpdate);

  // Expose for programmatic repositioning
  window.repositionBeToolbar = reqUpdate;
})();
</script><script>
(function(){
  // Ensure toolbar exists with default content if editor didn't inject it
  var tb = document.getElementById('be-toolbar');
  if (!tb){
    tb = document.createElement('div');
    tb.id = 'be-toolbar';
    tb.className = 'be-toolbar';
    tb.setAttribute('role', 'toolbar');
    tb.setAttribute('aria-label', 'Formatting');
    tb.innerHTML = ''
      + '<button data-cmd="bold"><strong>B</strong></button>'
      + '<button data-cmd="italic"><em>I</em></button>'
      + '<button data-cmd="underline"><u>U</u></button>'
      + '<span class="be-sep"></span>'
      + '<button data-cmd="insertUnorderedList">• List</button>'
      + '<button data-cmd="insertOrderedList">1. List</button>'
      + '<span class="be-sep"></span>'
      + '<button data-cmd="formatBlock" data-value="H2">H2</button>'
      + '<button data-cmd="formatBlock" data-value="H3">H3</button>'
      + '<span class="be-sep"></span>'
      + '<button id="be-link">Link</button>'
      + '<button id="be-clear">Clear</button>';
    (document.body || document.documentElement).appendChild(tb);
  }

  // Make it float over current .be-block (above by default, below if near viewport top)
  var root = document.getElementById('preview') || document.body;
  var activeBlock = null, raf = 0, MARGIN = 8;

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
  function findBlock(el){ return el && el.closest ? el.closest('.be-block') : null; }

  function positionToolbar(){
    raf = 0;
    var rect = activeBlock && activeBlock.getBoundingClientRect();
    if (!rect || !rect.width || !rect.height) return;
    var vw = Math.max(document.documentElement.clientWidth,  window.innerWidth  || 0);
    var vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

    var x = clamp(rect.left + rect.width/2, MARGIN, vw - MARGIN);
    var aboveTop = rect.top - MARGIN;
    var belowTop = rect.bottom + MARGIN;

    if (aboveTop < MARGIN){
      tb.style.transform = 'translate(-50%, 0)';
      tb.style.top = belowTop + 'px';
    } else {
      tb.style.transform = 'translate(-50%, -100%)';
      tb.style.top = aboveTop + 'px';
    }
    tb.style.left = x + 'px';
  }
  function req(){ if (!raf) raf = requestAnimationFrame(positionToolbar); }

  function activate(b){
    if (!b) return;
    if (activeBlock === b) { req(); return; }
    activeBlock = b;
    // highlight active for per-block toolbar CSS if present
    try {
      root.querySelectorAll('.be-block.is-active').forEach(function(n){ if(n!==b) n.classList.remove('is-active'); });
      b.classList.add('is-active');
    } catch(e){}
    req();
  }

  root.addEventListener('focusin', function(e){ var b=findBlock(e.target); if (b) activate(b); });
  root.addEventListener('click',   function(e){ var b=findBlock(e.target); if (b) activate(b); });

  document.addEventListener('selectionchange', req);
  window.addEventListener('scroll', req, true);
  window.addEventListener('resize', req);

  // If nothing is active on load, use the first editable block
  window.addEventListener('load', function(){
    var first = root.querySelector('.be-block:not([data-type="intro-locked"])');
    if (first) activate(first);
  });
})();
</script><script>
(function(){
  function addMissingToolbars(){
    var root = document.getElementById('preview') || document.body;
    var blocks = root.querySelectorAll('.be-block');
    for (var i=0; i<blocks.length; i++){
      var b = blocks[i];
      if (b.dataset && b.dataset.type === 'intro-locked') continue;
      // check for a direct child toolbar
      var hasBar = false;
      for (var c = b.firstElementChild; c; c = c.nextElementSibling){
        if (c.classList && c.classList.contains('be-block-toolbar')){ hasBar = true; break; }
      }
      if (!hasBar){
        var bar = document.createElement('div');
        bar.className = 'be-block-toolbar';
        // create standard buttons
        var h = document.createElement('button'); h.className='be-ico be-handle'; h.textContent='⋮⋮';
        var cp= document.createElement('button'); cp.className='be-ico be-copy';   cp.textContent='Copy';
        var dl= document.createElement('button'); dl.className='be-ico be-delete'; dl.textContent='Delete';
        bar.appendChild(h); bar.appendChild(cp); bar.appendChild(dl);
        b.insertBefore(bar, b.firstElementChild);
      }
    }
    if (window.repositionBeToolbar) window.repositionBeToolbar();
  }
  if (document.readyState === 'complete') addMissingToolbars();
  else window.addEventListener('load', addMissingToolbars, { once:true });
})();
</script><script>
(function(){
  function ensureDisclaimerStructure(){
    try{
      var blocks = document.querySelectorAll('.be-block[data-type="disclaimer"]');
      for (var i=0;i<blocks.length;i++){
        var block = blocks[i];
        // Ensure label exists
        var hasLabel = false;
        for (var c = block.firstElementChild; c; c = c.nextElementSibling){
          if (c.classList && c.classList.contains('be-label')){ hasLabel = true; break; }
        }
        if (!hasLabel){
          var label = document.createElement('div');
          label.className = 'be-label';
          label.innerHTML = '<span><span class="dot"></span> Disclaimer</span>';
          block.insertBefore(label, block.firstElementChild);
        }
        // Ensure a single direct toolbar right after label
        var labelNode = block.querySelector(':scope > .be-label');
        var directBars = block.querySelectorAll(':scope > .be-block-toolbar');
        var bar = directBars[0];
        for (var j=1;j<directBars.length;j++){ directBars[j].remove(); }
        if (!bar){
          // promote nested if any
          var nested = block.querySelector('.be-block-toolbar');
          if (nested){ bar = nested; } else { bar = document.createElement('div'); bar.className = 'be-block-toolbar'; }
          if (labelNode && labelNode.nextSibling){
            block.insertBefore(bar, labelNode.nextSibling);
          } else {
            block.insertBefore(bar, block.firstElementChild);
          }
        }else{
          if (labelNode && bar.previousElementSibling !== labelNode){
            block.insertBefore(bar, labelNode.nextSibling);
          }
        }
        // Ensure one of each button
        function need(sel, mk){
          var btn = bar.querySelector(sel);
          if (!btn){ btn = mk(); bar.appendChild(btn); }
          return btn;
        }
        var handle = need('.be-ico.be-handle', function(){ var b=document.createElement('button'); b.className='be-ico be-handle'; b.textContent='⋮⋮'; return b; });
        var copy   = need('.be-ico.be-copy',   function(){ var b=document.createElement('button'); b.className='be-ico be-copy';   b.textContent='Copy'; return b; });
        var del    = need('.be-ico.be-delete', function(){ var b=document.createElement('button'); b.className='be-ico be-delete'; b.textContent='Delete'; return b; });
        // Order by moving nodes
        bar.appendChild(handle); bar.appendChild(copy); bar.appendChild(del);
      }
    }catch(e){ try{ console.warn('ensureDisclaimerStructure error', e); }catch(_){ } }
  }

  // Delegated click handler so it works for future clones too
  function onClick(e){
    var copyBtn = e.target.closest && e.target.closest('.be-block[data-type="disclaimer"] .be-block-toolbar .be-copy');
    var delBtn  = e.target.closest && e.target.closest('.be-block[data-type="disclaimer"] .be-block-toolbar .be-delete');
    if (!copyBtn && !delBtn) return;

    e.preventDefault();
    e.stopPropagation();
    if (e.stopImmediatePropagation) e.stopImmediatePropagation();

    var block = (copyBtn || delBtn).closest('.be-block[data-type="disclaimer"]');
    if (!block) return;

    if (delBtn){
      // Remove the entire block
      if (block.parentNode) block.parentNode.removeChild(block);
      return;
    }

    if (copyBtn){
      // Clone the block and clean IDs
      var clone = block.cloneNode(true);
      var withId = clone.querySelectorAll('[id]');
      for (var i=0;i<withId.length;i++){ withId[i].removeAttribute('id'); }
      // Insert after and ensure its structure (toolbar/label placement)
      block.parentNode.insertBefore(clone, block.nextSibling);
      // No need to wire events—delegation handles future clicks
      // Ensure toolbar/label positioning on the clone
      requestAnimationFrame(ensureDisclaimerStructure);
    }
  }

  // Run once on load to ensure structure, then install delegated handler
  if (document.readyState === 'complete'){ ensureDisclaimerStructure(); }
  else window.addEventListener('load', ensureDisclaimerStructure, { once:true });

  document.addEventListener('click', onClick, true); // capture to beat editor handlers
})();
</script><script>(function(){
  // Run after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupFix, { once: true });
  } else {
    setupFix();
  }

  function setupFix(){
    const preview = document.getElementById('preview');
    if (!preview) return;

    // Replace buttons with clean clones to drop any older listeners
    function resetButton(id){
      const btn = document.getElementById(id);
      if (!btn) return null;
      const clone = btn.cloneNode(true);
      btn.replaceWith(clone);
      return clone;
    }

    const addPrimary   = resetButton('add-primary');
    const addSecondary = resetButton('add-secondary');
    const addPartner   = resetButton('add-partner');

    const badge = document.getElementById('be-count');
    function updateBadge(){
      if (badge) badge.textContent = (preview.querySelectorAll('.be-block').length) + ' blocks';
    }
    updateBadge();

    const isLocked = b => (b?.dataset?.type === 'locked');

    function area(el){
      const r = el.getBoundingClientRect();
      return (r.width || 1) * (r.height || 1);
    }

    function tableCount(el){
      // prefer a direct table (common for unit blocks)
      const direct = el.querySelectorAll(':scope > table').length;
      return direct || el.querySelectorAll('table').length;
    }

    function pickTemplate(type){
      const all = Array.from(preview.querySelectorAll('.be-block')).filter(Boolean);
      const candidates = all.filter(b => b.dataset && b.dataset.type === type && !isLocked(b));
      if (!candidates.length) return null;

      const scored = candidates.map(el => ({
        el, tables: tableCount(el), area: area(el)
      }));

      const singles = scored.filter(s => s.tables === 1);
      const pool = singles.length ? singles : scored;
      const chosen = pool.sort((a,b) => a.area - b.area)[0].el;

      // Deep clone + sanitize duplicate IDs
      const clone = chosen.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));

      // Optional: relabel copy for clarity
      const labelSpan = clone.querySelector('.be-label span');
      const nice = (chosen.dataset && chosen.dataset.label) ? chosen.dataset.label
                 : (type.charAt(0).toUpperCase() + type.slice(1));
      if (labelSpan) labelSpan.textContent = nice + ' (copy)';

      return clone;
    }

    function appendClone(type){
      const node = pickTemplate(type);
      if (!node) {
        // Fallback: take the smallest non-locked block if type not found
        const pool = Array.from(preview.querySelectorAll('.be-block')).filter(b => !isLocked(b));
        if (!pool.length) return;
        const chosen = pool.sort((a,b) => area(a) - area(b))[0];
        const fallback = chosen.cloneNode(true);
        fallback.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));
        preview.appendChild(fallback);
      } else {
        preview.appendChild(node);
      }
      updateBadge();
    }

    if (addPrimary)   addPrimary.addEventListener('click', function(e){ e.preventDefault(); appendClone('primary'); }, { passive:false });
    if (addSecondary) addSecondary.addEventListener('click', function(e){ e.preventDefault(); appendClone('secondary'); }, { passive:false });
    if (addPartner)   addPartner.addEventListener('click', function(e){
      e.preventDefault();
      const header = pickTemplate('partner-header');
      const card   = pickTemplate('partner-card');
      if (header) preview.appendChild(header);
      if (card)   preview.appendChild(card);
      updateBadge();
    }, { passive:false });
  }
})();
</script><script>
(function(){
  // Enhance the safe-clone behavior: Primary must insert a white card like "Story 1 card"
  function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once: true }); else fn(); }
  ready(function(){
    const preview = document.getElementById('preview');
    const addPrimary = document.getElementById('add-primary');
    if (!preview || !addPrimary) return;

    // Overwrite any existing listener by replacing the node
    const btn = addPrimary.cloneNode(true);
    addPrimary.replaceWith(btn);

    function isLocked(b){ return b?.dataset?.type === 'locked'; }

    function area(el){
      const r = el.getBoundingClientRect();
      return (r.width || 1) * (r.height || 1);
    }

    function tableCount(el){
      const direct = el.querySelectorAll(':scope > table').length;
      return direct || el.querySelectorAll('table').length;
    }

    function hasWhiteBg(el){
      // Look for inline styles or attributes indicating white background
      const w = /(#fff(fff)?\\b|\\bwhite\\b)/i;
      if (el.getAttribute('bgcolor') && w.test(el.getAttribute('bgcolor'))) return true;
      if (el.hasAttribute('style') && w.test(el.getAttribute('style'))) return true;
      // Check tables within
      const t = el.querySelector('table');
      if (t){
        if (t.getAttribute('bgcolor') && w.test(t.getAttribute('bgcolor'))) return true;
        if (t.hasAttribute('style') && w.test(t.getAttribute('style'))) return true;
      }
      return false;
    }

    function textIncludes(el, s){
      return (el.textContent || '').toLowerCase().includes(s.toLowerCase());
    }

    function findStory1Primary(){
      const primaries = Array.from(preview.querySelectorAll('.be-block')).filter(b => b.dataset?.type === 'primary' && !isLocked(b));
      if (!primaries.length) return null;

      // 1) Exact label match in data-label or visible label
      let exact = primaries.find(b => /story\\s*1/i.test(b.dataset?.label || ''));
      if (!exact){
        exact = primaries.find(b => /story\\s*1/i.test((b.querySelector('.be-label')?.textContent)||''));
      }
      if (exact) return exact;

      // 2) Prefer white background + single table
      const scored = primaries.map(el => ({
        el,
        white: hasWhiteBg(el) ? 1 : 0,
        tables: tableCount(el),
        area: area(el),
        storyHint: (/(story|card)/i.test(el.dataset?.label || '') || /(story|card)/i.test((el.querySelector('.be-label')?.textContent)||'')) ? 1 : 0,
      }));

      scored.sort((a,b)=>{
        // Prefer white, then story hint, then single-table, then smallest area
        return (b.white - a.white) || (b.storyHint - a.storyHint) || ((a.tables===1)-(b.tables===1)) || (a.area - b.area);
      });

      return scored[0]?.el || null;
    }

    function cloneSanitized(node){
      const clone = node.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(n => n.removeAttribute('id'));
      const labelSpan = clone.querySelector('.be-label span');
      const nice = (node.dataset && node.dataset.label) ? node.dataset.label : 'Primary';
      if (labelSpan) labelSpan.textContent = nice + ' (copy)';
      return clone;
    }

    btn.addEventListener('click', function(e){
      e.preventDefault();
      let chosen = findStory1Primary();
      if (!chosen){
        // Fallback: smallest non-locked primary; then any smallest non-locked block
        const primaries = Array.from(preview.querySelectorAll('.be-block')).filter(b => b.dataset?.type === 'primary' && !isLocked(b));
        if (primaries.length){
          primaries.sort((a,b)=> area(a) - area(b));
          chosen = primaries[0];
        } else {
          const pool = Array.from(preview.querySelectorAll('.be-block')).filter(b => !isLocked(b));
          if (!pool.length) return;
          pool.sort((a,b)=> area(a) - area(b));
          chosen = pool[0];
        }
      }
      const copy = cloneSanitized(chosen);
      preview.appendChild(copy);
      const badge = document.getElementById('be-count');
      if (badge) badge.textContent = (preview.querySelectorAll('.be-block').length) + ' blocks';
    }, { passive:false });
  });
})();
</script><script>
(function(){
  function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once:true }); else fn(); }
  ready(function(){
    const preview = document.getElementById('preview');
    const addPrimary = document.getElementById('add-primary');
    if (!preview || !addPrimary) return;
    const btn = addPrimary.cloneNode(true);
    addPrimary.replaceWith(btn);

    function isLocked(b){ return b?.dataset?.type === 'locked'; }
    function area(el){ const r=el.getBoundingClientRect(); return (r.width||1)*(r.height||1); }
    function tableCount(el){ const direct = el.querySelectorAll(':scope > table').length; return direct || el.querySelectorAll('table').length; }
    function hasWhiteBg(el){ const w=/(#fff(fff)?\\b|\\bwhite\\b)/i;
      if (el.getAttribute('bgcolor') && w.test(el.getAttribute('bgcolor'))) return true;
      if (el.hasAttribute('style') && w.test(el.getAttribute('style'))) return true;
      const t=el.querySelector('table'); if(t){ if(t.getAttribute('bgcolor') && w.test(t.getAttribute('bgcolor'))) return true;
        if(t.hasAttribute('style') && w.test(t.getAttribute('style'))) return true; }
      return false; }
    function findStory1Primary(){
      const primaries=[...preview.querySelectorAll('.be-block')].filter(b=>b.dataset?.type==='primary' && !isLocked(b));
      if(!primaries.length) return null;
      let exact=primaries.find(b=>/story\\s*1/i.test(b.dataset?.label||'')); if(!exact){ exact=primaries.find(b=>/story\\s*1/i.test((b.querySelector('.be-label')?.textContent)||'')); }
      if(exact) return exact;
      const scored=primaries.map(el=>({el,white:hasWhiteBg(el)?1:0,tables:tableCount(el),area:area(el),
        storyHint:(/(story|card)/i.test(el.dataset?.label||'')||/(story|card)/i.test((el.querySelector('.be-label')?.textContent)||''))?1:0 }));
      scored.sort((a,b)=>(b.white-a.white)||(b.storyHint-a.storyHint)||((a.tables===1)-(b.tables===1))||(a.area-b.area));
      return scored[0]?.el||null;
    }
    function cloneSanitized(node){ const clone=node.cloneNode(true); clone.querySelectorAll('[id]').forEach(n=>n.removeAttribute('id'));
      const labelSpan=clone.querySelector('.be-label span'); const nice=(node.dataset&&node.dataset.label)?node.dataset.label:'Primary';
      if(labelSpan) labelSpan.textContent=nice+' (copy)'; return clone; }

    btn.addEventListener('click', function(e){
      e.preventDefault();
      let chosen=findStory1Primary(); if(!chosen){ const primaries=[...preview.querySelectorAll('.be-block')].filter(b=>b.dataset?.type==='primary'&&!isLocked(b));
        if(primaries.length){ primaries.sort((a,b)=>area(a)-area(b)); chosen=primaries[0]; }
        else { const pool=[...preview.querySelectorAll('.be-block')].filter(b=>!isLocked(b)); if(!pool.length) return; pool.sort((a,b)=>area(a)-area(b)); chosen=pool[0]; } }
      const copy=cloneSanitized(chosen);

      // Insert before the Subscribe CTA line
      let target=[...preview.querySelectorAll('.be-block')].find(b=>/subscribe cta/i.test(b.dataset?.label||'')||/subscribe cta/i.test((b.textContent||'')));
      if(target) target.before(copy); else preview.appendChild(copy);

      const badge=document.getElementById('be-count');
      if(badge) badge.textContent=preview.querySelectorAll('.be-block').length+' blocks';
    }, {passive:false});
  });
})();</script><script>
// --- Hard lock placement for Primary, Secondary & Partner by intercepting preview.appendChild ---
(function(){
  var preview = document.getElementById('preview') || document.body;
  if (!preview) return;

  var origAppend = preview.appendChild.bind(preview);

  
  function findClosestBlockByText(regex){
    var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT, null);
    var matches = [];
    while (walker.nextNode()){
      var el = walker.currentNode;
      if (!el) continue;
      var txt = (el.textContent || '').trim();
      if (!txt) continue;
      if (regex.test(txt)){
        var block = el.closest && el.closest('.be-block');
        if (block) matches.push(block);
      }
    }
    return matches.length ? matches[matches.length-1] : null;
  }

  
  function findClosestBlockByText(regex){
    try{
      var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT, null);
      var matches = [];
      while (walker.nextNode()){
        var el = walker.currentNode;
        if (!el) continue;
        var txt = (el.textContent || '').trim();
        if (!txt) continue;
        if (regex.test(txt)){
          var block = el.closest && el.closest('.be-block');
          if (block) matches.push(block);
        }
      }
      return matches.length ? matches[matches.length-1] : null;
    }catch(_){ return null; }
  }

  function anchor(){
    var preview = document.getElementById('preview') || document.body;
    var a = document.querySelector('.be-block[data-type="primary"][data-label="Row 23: Subscribe CTA line"]');
    if (a) return a;
    a = document.querySelector('.be-block[data-type="disclaimer"]');
    if (!a){ a = findClosestBlockByText(/(SoFi Disclaimers|Disclaimer: Finder|INVESTMENTS ARE NOT FDIC INSURED)/i); }
    if (a) return a;
    a = Array.from(preview.querySelectorAll('.be-block')).find(function(b){
      var lbl = (b.dataset && b.dataset.label) ? b.dataset.label : '';
      return /dynamic content block/i.test(lbl) || /row\s*26:\s*dynamic/i.test(lbl);
    });
    if (!a){ a = findClosestBlockByText(/Dynamic content block/i); }
    if (a) return a;
    return null;
  }

  preview.appendChild = function(node){
    try{
      if (node && node.nodeType === 1 && node.classList && node.classList.contains('be-block')){
        var t = (node.dataset && node.dataset.type) || '';
        if (t === 'primary' || t === 'secondary' || t === 'partner-header' || t === 'partner-card'){
          var a = anchor();
          if (a && a.parentNode){
            var p = a.parentNode;
            if (node.parentNode !== p) p.appendChild(node);
            p.insertBefore(node, a); // <— force BEFORE Row 23
            return node;
          }
        }
      }
    }catch(_){}
    return origAppend(node); // default for everything else (including Primary)
  };
})();
</script><script>
// Final override: intercept ONLY when parent is inside #preview (avoids fragment/build-phase issues)
(function(){
  var preview = document.getElementById('preview') || document.body;

  function findClosestBlockByText(regex){
    try{
      var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT, null);
      var matches = [];
      while (walker.nextNode()){
        var el = walker.currentNode;
        if (!el) continue;
        var txt = (el.textContent || '').trim();
        if (!txt) continue;
        if (regex.test(txt)){
          var block = el.closest && el.closest('.be-block');
          if (block) matches.push(block);
        }
      }
      return matches.length ? matches[matches.length-1] : null;
    }catch(_){ return null; }
  }

  function anchor(){
    var a = document.querySelector('.be-block[data-type="primary"][data-label="Row 23: Subscribe CTA line"]');
    if (a) return a;

    a = document.querySelector('.be-block[data-type="disclaimer"]');
    if (!a){
      a = findClosestBlockByText(/(SoFi Disclaimers|Disclaimer: Finder|INVESTMENTS ARE NOT FDIC INSURED)/i);
    }
    if (a) return a;

    a = Array.from(preview.querySelectorAll('.be-block')).find(function(b){
      var lbl = (b.dataset && b.dataset.label) ? b.dataset.label : '';
      return /dynamic content block/i.test(lbl) || /row\s*26:\s*dynamic/i.test(lbl);
    });
    if (!a){
      a = findClosestBlockByText(/Dynamic content block/i);
    }
    if (a) return a;

    return null; // no anchors -> append to bottom
  }

  var prevAppend = Element.prototype.appendChild;
  Element.prototype.appendChild = function(node){
    var parent = this;
    var inPreview = false;
    try { inPreview = preview && preview.contains && preview.contains(parent); } catch(_) {}

    // Only take over for real .be-blocks appended into the live preview tree
    if (inPreview && node && node.nodeType === 1 && node.classList && node.classList.contains('be-block')){
      var t = (node.dataset && node.dataset.type) || '';
      if (t === 'primary' || t === 'secondary' || t === 'partner-header' || t === 'partner-card'){
        var a = anchor();
        if (a && a.parentNode){
          var p = a.parentNode;
          // ensure node is under the same parent once
          if (node.parentNode !== p) prevAppend.call(p, node);
          if (node !== a) p.insertBefore(node, a);
          return node;
        }
        // no anchor -> let it append at bottom naturally
        return prevAppend.call(parent, node);
      }
    }
    return prevAppend.call(parent, node);
  };
})();</script><script>
// Partner Add Guardian: only overrides when header/card is missing; otherwise lets native handler run.
(function(){
  var root = document.getElementById('preview') || document.body;
  var btn = document.getElementById('add-partner');
  if (!root || !btn) return;

  function exists(sel){ return !!root.querySelector(sel); }
  function build(id){
    var tpl = document.getElementById(id);
    return (tpl && tpl.content && tpl.content.firstElementChild) ? tpl.content.firstElementChild.cloneNode(true) : null;
  }

  btn.addEventListener('click', function(ev){
    var needHeader = !exists('.be-block[data-type="partner-header"]');
    var needCard   = !exists('.be-block[data-type="partner-card"]');
    if (needHeader || needCard){
      // Stop native listener (which appears to no-op after deleting the default card)
      ev.preventDefault();
      ev.stopImmediatePropagation();
      ev.stopPropagation();

      // Synthesize only the missing pieces
      if (needHeader){
        var h = build('tpl-partner-header');
        if (h) root.appendChild(h);
      }
      if (needCard){
        var c = build('tpl-partner-card');
        if (c) root.appendChild(c);
      }
      return false;
    }
    // Otherwise, do nothing here and allow native handler to proceed normally
  }, true); // capture phase
})();
</script><script>
/* Override Partner Add: always inserts fresh Partner header + card (works even after deletes) */
(function(){
  var preview = document.getElementById('preview') || document.body;
  var btn = document.getElementById('add-partner');
  if (!preview || !btn) return;

  // Ensure templates exist (idempotent)
  function ensureTemplate(id, html){
    if (!document.getElementById(id)){
      var t = document.createElement('template');
      t.id = id;
      t.innerHTML = html.trim();
      document.body.appendChild(t);
    }
  }

  ensureTemplate('tpl-partner-header', '\
    <div class="be-block" data-type="partner-header" data-label="Partner header">\
      <div class="be-label"><i class="dot"></i><span>Partner header</span></div>\
      <div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button></div>\
      <table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>\
        <table class="container" role="presentation" width="685"><tbody><tr><td>\
          <h3 class="font-sans">Partner</h3>\
        </td></tr></tbody></table>\
      </td></tr></tbody></table>\
    </div>\
  ');

  ensureTemplate('tpl-partner-card', '\
    <div class="be-block" data-type="partner-card" data-label="Partner card">\
      <div class="be-label"><i class="dot"></i><span>Partner card</span></div>\
      <div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button></div>\
      <table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>\
        <table class="container bg-white" role="presentation" width="685"><tbody><tr><td class="px-25">\
          <p class="font-sans">Partner content…</p>\
        </td></tr></tbody></table>\
      </td></tr></tbody></table>\
    </div>\
  ');

  function fromTemplate(id){
    var t = document.getElementById(id);
    return (t && t.content && t.content.firstElementChild) ? t.content.firstElementChild.cloneNode(true) : null;
  }
  function cloneExisting(sel){
    var n = preview.querySelector(sel);
    return n ? n.cloneNode(true) : null;
  }
  function minimal(type, label, inner){
    var wrap = document.createElement('div');
    wrap.innerHTML = (
      '<div class="be-block" data-type="'+type+'" data-label="'+label+'">'+
        '<div class="be-label"><i class="dot"></i><span>'+label+'</span></div>'+
        '<div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button></div>'+
        inner+
      '</div>'
    );
    return wrap.firstElementChild;
  }
  function buildHeader(){
    return fromTemplate('tpl-partner-header')
        || cloneExisting('.be-block[data-type="partner-header"]')
        || minimal('partner-header','Partner header',
           '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>'+
           '<table class="container" role="presentation" width="685"><tbody><tr><td><h3 class="font-sans">Partner</h3></td></tr></tbody></table>'+
           '</td></tr></tbody></table>');
  }
  function buildCard(){
    return fromTemplate('tpl-partner-card')
        || cloneExisting('.be-block[data-type="partner-card"]')
        || minimal('partner-card','Partner card',
           '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>'+
           '<table class="container bg-white" role="presentation" width="685"><tbody><tr><td class="px-25">'+
           '<p class="font-sans">Partner content…</p></td></tr></tbody></table>'+
           '</td></tr></tbody></table>');
  }

  // Replace the Partner button node to drop ALL existing listeners, then attach our own
  var freshBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(freshBtn, btn);

  freshBtn.addEventListener('click', function(e){
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    var header = buildHeader();
    var card   = buildCard();
    if (header) preview.appendChild(header);
    if (card)   preview.appendChild(card);

    try { if (typeof updateBadge === 'function') updateBadge(); } catch(_){}
  }, false);
})();
</script><script>
/* Global spacer helper (idempotent) */
window.addSpacersToContent = window.addSpacersToContent || function(html){
  try{
    var doc = document.implementation.createHTMLDocument('spacers');
    var c = doc.createElement('div'); c.innerHTML = html;
    var blockSelectors = ['p','ul','ol','h1','h2','h3','h4','h5','h6','table','blockquote','pre','img','figure'];
    blockSelectors.forEach(function(tag){
      Array.prototype.slice.call(c.querySelectorAll(tag)).forEach(function(el){
        // skip empty paragraphs
        if (tag==='p' && !el.textContent.trim() && !el.querySelector('img,table,ul,ol')) return;
        var next = el.nextSibling;
        var isSpacer = next && next.nodeType===1 && next.classList && next.classList.contains('spacer-20');
        if (!isSpacer){
          var d = doc.createElement('div');
          d.className = 'spacer-20';
          d.innerHTML = '&hairsp;';
          el.parentNode.insertBefore(d, next);
        }
      });
    });
    return c.innerHTML;
  }catch(e){
    return html;
  }
};

/* Import DOCX (marker-based)
  function addSpacersToContent(html){
    try{
      var doc = document.implementation.createHTMLDocument('spacers');
      var c = doc.createElement('div'); c.innerHTML = html;
      var blockSelectors = ['p','ul','ol','h1','h2','h3','h4','h5','h6','table','blockquote','pre','img','figure'];
      // Add spacer after each matching element (if not already directly followed by a spacer)
      blockSelectors.forEach(function(tag){
        Array.from(c.querySelectorAll(tag)).forEach(function(el){
          // skip empty paragraphs
          if (tag==='p' && !el.textContent.trim() && !el.querySelector('img,table,ul,ol')) return;
          var next = el.nextSibling;
          var isSpacer = next && next.nodeType===1 && next.classList && next.classList.contains('spacer-20');
          if (!isSpacer){
            var d = doc.createElement('div');
            d.className = 'spacer-20';
            d.innerHTML = '&hairsp;';
            el.parentNode.insertBefore(d, next);
          }
        });
      });
      return c.innerHTML;
    }catch(e){
      return html;
    }
  }
 → Primary/Secondary/Partner cards with Primary outline */
(function(){
  if (window.__docxImportBoundMarkers) return; window.__docxImportBoundMarkers = true;

  var preview = document.getElementById('preview') || document.body;
  var btn = document.getElementById('import-docx');
  var input = document.getElementById('docx-file');

  /* Keep anchors: header/hero/date/author, Subscribe CTA, Disclaimer, Dynamic */
  function keepBlock(block){
    var lbl  = (block && block.getAttribute && block.getAttribute('data-label')) || '';
    var type = (block && block.getAttribute && block.getAttribute('data-type')) || '';
    if (/header|hero banner|author banner|date bar/i.test(lbl)) return true;
    if (/subscribe cta line/i.test(lbl)) return true;
    if (/disclaimer/i.test(type) || /disclaimer/i.test(lbl)) return true;
    if (/dynamic content block/i.test(lbl)) return true;
    return false; // remove others (incl. partner) before import
  }
  function removeExistingCards(){
    Array.from(preview.querySelectorAll('.be-block')).forEach(function(b){
      if (!keepBlock(b)) b.remove();
    });
  }

  /* Primary-style scaffolds (outline + rounded corners + spacing) */
  function insertAtAnchor(wrap){
    var anchor = preview.querySelector('.be-block[data-label*="Subscribe CTA line"]')
        || preview.querySelector('.be-block[data-type="disclaimer"]')
        || Array.from(preview.querySelectorAll('.be-block')).find(function(b){
             var l = (b.dataset && b.dataset.label)||''; return /dynamic content block/i.test(l);
           });
    if (anchor && anchor.parentNode) anchor.parentNode.insertBefore(wrap, anchor);
    else preview.appendChild(wrap);
  }

  function primaryScaffold(innerHtml, idx){
  innerHtml = window.addSpacersToContent(innerHtml);

  innerHtml = addSpacersToContent(innerHtml);

    var wrap = document.createElement('div');
    wrap.className = 'be-block font-roboto';
    wrap.setAttribute('data-type','primary');
    wrap.setAttribute('data-label','Imported card ' + (idx+1));
    wrap.innerHTML =
      '<div class="be-label"><i class="dot"></i><span>Imported card ' + (idx+1) + '</span></div>' +
      '<div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button></div>' +
      '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>' +
      '  <table cellpadding="0" cellspacing="0" class="container bg-white" role="presentation" width="685" style="border:2px solid #232021;border-radius:22px;">' +
      '    <tbody><tr><td class="px-25" style="padding:20px 25px 20px 25px;"><div class="font-sans fs-16" contenteditable="true">' + innerHtml + '</div></td></tr></tbody>' +
      '  </table>' +
      '</td></tr></tbody></table>' +
      '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>' +
      '  <table class="container" role="presentation" width="685"><tbody><tr><td><div class="spacer-20">&hairsp;</div></td></tr></tbody></table>' +
      '</td></tr></tbody></table>';
    insertAtAnchor(wrap);
  }

  

function secondaryScaffold(innerHtml, idx){
  // Ensure internal content elements have spacers
  innerHtml = window.addSpacersToContent ? window.addSpacersToContent(innerHtml) : innerHtml;

  var wrap = document.createElement('div');
  wrap.className = 'be-block font-roboto';
  wrap.setAttribute('data-type','secondary');
  wrap.setAttribute('data-label','Imported card ' + (idx+1));
  wrap.innerHTML =
    '<div class="be-label"><i class="dot"></i><span>Imported card ' + (idx+1) + '</span></div>'+
    '<div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button></div>'+
    '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>'+
      '<table cellpadding="0" cellspacing="0" class="container bg-cream card" role="presentation" width="685">'+
        '<tbody>'+
          '<tr><td class="px-25 pt-20">'+ innerHtml +'</td></tr>'+
          '<tr><td class="px-25"><div class="spacer-20">&hairsp;</div></td></tr>'+
        '</tbody>'+
      '</table>'+
    '</td></tr></tbody></table>';

  // Insert the card at the correct anchor
  insertAtAnchor(wrap);

  // Add an external spacer row after the card, to mirror template spacing
  try {
    var spacerTable = document.createElement('table');
    spacerTable.setAttribute('cellpadding','0');
    spacerTable.setAttribute('cellspacing','0');
    spacerTable.setAttribute('role','presentation');
    spacerTable.setAttribute('width','100%');
    spacerTable.className = 'row';
    spacerTable.innerHTML =
      '<tbody><tr><td>'+
        '<table class="container" role="presentation" width="685">'+
          '<tbody><tr><td><div class="spacer-20">&hairsp;</div></td></tr></tbody>'+
        '</table>'+
      '</td></tr></tbody>';
    wrap.insertAdjacentElement('afterend', spacerTable);
  } catch(e){ /* no-op */ }
}

  function partnerScaffold(headerText, innerHtml, idx){
    var headerTable =
      '<table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace:0;mso-table-rspace:0;margin-left:auto;margin-right:auto;" width="100%">' +
      '<tbody><tr><td align="center">' +
      '<table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="width:685px;max-width:100%;background-color:#1d53ff;border:2px solid #232021;border-radius:22px 22px 0 0;margin-left:auto;margin-right:auto;" width="685">' +
      '<tbody><tr><td style="padding:20px 25px 10px 25px;">' +
      '<p style="margin:0;font-family:Helvetica,Arial,sans-serif;font-size:20px;line-height:1.2;color:#ffffff;"><strong>' + (headerText || 'From Our Partners') + '</strong></p>' +
      '</td></tr></tbody></table>' +
      '</td></tr></tbody></table>';

    var cardTable =
      '<table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace:0;mso-table-rspace:0;margin-left:auto;margin-right:auto;" width="100%">' +
      '<tbody><tr><td align="center">' +
      '<table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="width:685px;max-width:100%;background-color:#ffffff;border:2px solid #232021;border-top:0;border-radius:0 0 22px 22px;margin-left:auto;margin-right:auto;" width="685">' +
      '<tbody><tr><td align="left" style="padding:20px 25px 20px 25px;">' +
      '<div class="font-sans fs-16" contenteditable="true">' + innerHtml + '</div>' +
      '</td></tr></tbody></table>' +
      '</td></tr></tbody></table>';

    var wrap = document.createElement('div');
    wrap.className = 'be-block font-roboto';
    wrap.setAttribute('data-type','partner-card');
    wrap.setAttribute('data-label','Imported partner ' + (idx+1));
    wrap.innerHTML =
      '<div class="be-label"><i class="dot"></i><span>Imported partner ' + (idx+1) + '</span></div>' +
      '<div class="be-block-toolbar"><button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button></div>' +
      headerTable + cardTable +
      '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>' +
      '  <table class="container" role="presentation" width="685"><tbody><tr><td><div class="spacer-20">&hairsp;</div></td></tr></tbody></table>' +
      '</td></tr></tbody></table>';
    insertAtAnchor(wrap);
  }

  /* Sanitize Mammoth HTML to an email-safe subset */
  var ALLOWED = new Set(['A','STRONG','EM','U','BR','P','UL','OL','LI','H2','H3','SPAN','B','I']);
  var INLINE_OK = new Set(['font-weight','font-style','text-decoration']);

  function normalizeInline(el){
    var fw=(el.style&&(el.style.fontWeight||'')+'').toLowerCase();
    var fs=(el.style&&(el.style.fontStyle||'')+'').toLowerCase();
    var td=(el.style&&(el.style.textDecoration||'')+'').toLowerCase();
    var wrap=el; function wrapWith(tag){var w=el.ownerDocument.createElement(tag);while(wrap.firstChild) w.appendChild(wrap.firstChild); if (wrap.parentNode) wrap.parentNode.replaceChild(w, wrap); wrap=w;}
    if (fw==='bold'||fw==='700'||fw==='600'||fw==='800'||fw==='900'){ wrapWith('strong'); }
    if (fs==='italic'){ wrapWith('em'); }
    if (td.indexOf('underline')!==-1){ wrapWith('u'); }
    if (wrap.removeAttribute) wrap.removeAttribute('style');
    return wrap;
  }
  function sanitizeNode(node, doc){
    if (node.nodeType===3) return doc.createTextNode(node.nodeValue);
    if (node.nodeType!==1) return doc.createDocumentFragment();
    var tag=node.tagName.toUpperCase();
    if (!ALLOWED.has(tag)){
      var frag=doc.createDocumentFragment(); node.childNodes.forEach(function(ch){ frag.appendChild(sanitizeNode(ch,doc)); }); return frag;
    }
    var out=doc.createElement(tag);
    if (tag==='A'){
      var href=node.getAttribute('href')||''; if (/^(https?:|mailto:)/i.test(href)){ out.setAttribute('href',href); out.setAttribute('target','_blank'); out.setAttribute('rel','noopener'); }
    } else if (tag==='SPAN' || tag==='B' || tag==='I'){
      var kept=[], style=node.getAttribute('style')||''; style.split(';').forEach(function(r){ var kv=r.split(':'); if (kv.length===2){ var k=kv[0].trim().toLowerCase(), v=kv[1].trim(); if (INLINE_OK.has(k)) kept.push(k+':'+v); } });
      if (kept.length) out.setAttribute('style', kept.join(';'));
    }
    node.childNodes.forEach(function(ch){ out.appendChild(sanitizeNode(ch,doc)); });
    if (out.tagName==='SPAN' && out.hasAttribute('style')) out=normalizeInline(out);
    if (out.tagName==='B'){ var s=doc.createElement('strong'); while(out.firstChild) s.appendChild(out.firstChild); out=s; }
    if (out.tagName==='I'){ var e=doc.createElement('em'); while(out.firstChild) e.appendChild(out.firstChild); out=e; }
    if (out.removeAttribute){ out.removeAttribute('id'); out.removeAttribute('class'); }
    return out;
  }
  function sanitizeHtml(html){
    var doc=document.implementation.createHTMLDocument('docx');
    var c=doc.createElement('div'); c.innerHTML=html;
    // Unwrap <p><hr></p> into standalone <hr>
    c.querySelectorAll('p').forEach(function(p){ var hr=p.querySelector('hr'); if (hr){ p.parentNode.insertBefore(hr,p); if(!p.textContent.trim()) p.remove(); } });
    // Convert paragraphs of only ---/***/___/—— into <hr>
    c.querySelectorAll('p').forEach(function(p){ var t=(p.textContent||'').trim(); if (/^(?:-{3,}|\*{3,}|_{3,}|\u2014{2,})$/.test(t)){ var hr=doc.createElement('hr'); p.parentNode.insertBefore(hr,p); p.remove(); } });

    // Sanitize into array (single chunk, we split later with markers)
    var out=[], fdoc=document.implementation.createHTMLDocument('frag'), frag=fdoc.createDocumentFragment();
    Array.from(c.childNodes).forEach(function(n){ frag.appendChild(sanitizeNode(n,fdoc)); });
    var tmp=fdoc.createElement('div'); tmp.appendChild(frag);
    out.push(tmp.innerHTML);
    return out;
  }

  /* Marker-based segmentation */
  function parseSegmentsWithMarkers(html){
    var doc=document.implementation.createHTMLDocument('docx-markers');
    var container=doc.createElement('div'); container.innerHTML=html;

    var partnerHeaderText='';
    container.querySelectorAll('*').forEach(function(el){
      if (el.innerHTML && el.innerHTML.indexOf('{{ partner-header }}')!==-1){
        partnerHeaderText = el.textContent.replace('{{ partner-header }}','').trim();
        el.innerHTML = el.innerHTML.replace('{{ partner-header }}','');
      }
    });

    ['primary','secondary','partner'].forEach(function(kind){
      var re=new RegExp('\\{\\{\\s*end-'+kind+'\\s*\\}\\}','gi');
      container.innerHTML = container.innerHTML.replace(re, '<hr data-marker="end-'+kind+'">');
    });

    var segments=[], buf=doc.createElement('div');
    function push(kind){
      var html=buf.innerHTML.trim();
      if (html.replace(/<[^>]+>/g,'').trim().length===0){ buf.innerHTML=''; return; }
      segments.push({kind:kind, html:html}); buf.innerHTML='';
    }
    Array.from(container.childNodes).forEach(function(n){
      if (n.nodeType===1 && n.tagName.toUpperCase()==='HR' && n.hasAttribute('data-marker')){
        var mk=n.getAttribute('data-marker');
        if (mk==='end-primary') push('primary');
        else if (mk==='end-secondary') push('secondary');
        else if (mk==='end-partner') push('partner');
      } else {
        buf.appendChild(n.cloneNode(true));
      }
    });
    if (buf.innerHTML.trim().length){ push('primary'); } // default trailing chunk
    return {segments:segments, partnerHeaderText:partnerHeaderText};
  }

  async function docxToHtml(file){
    if (!window.mammoth) throw new Error('Mammoth.js not loaded');
    var array = await file.arrayBuffer();
    var res = await window.mammoth.convertToHtml({arrayBuffer: array}, {
      styleMap:[ "b => strong", "i => em", "u => u", "p[style-name='Heading 2'] => h2", "p[style-name='Heading 3'] => h3" ]
    });
    return res.value || "";
  }

  async function handleFile(file){
    /* Safe partner purge (minimal) */
    (function(){
      try{
        var root = document.getElementById('preview') || document.getElementById('nl-container') || document.body;
        if (!root) return;
        root.querySelectorAll('[data-type="partner-header"], [data-type="partner-card"]').forEach(function(n){ n.remove(); });
        Array.prototype.forEach.call(root.querySelectorAll('.be-block[data-label]'), function(n){
          var lbl = (n.getAttribute('data-label')||'').toLowerCase();
          if (lbl.indexOf('partner') !== -1) n.remove();
        });
      }catch(e){ /* no-op */ }
    })();

    try{
      var raw = await docxToHtml(file);
      var parts = sanitizeHtml(raw);
      var parsed = parseSegmentsWithMarkers(parts.join("\n"));
      removeExistingCards();
      var count=0;
      parsed.segments.forEach(function(seg){
        if (seg.kind==='primary')   primaryScaffold(seg.html, count++);
        else if (seg.kind==='secondary') secondaryScaffold(seg.html, count++);
        else if (seg.kind==='partner')   partnerScaffold(parsed.partnerHeaderText, seg.html, count++);
      });
      if (typeof window.__updateBeCount==='function') window.__updateBeCount();
      if (typeof showToast==='function') showToast('Imported ' + count + ' card(s) from DOCX');
    }catch(e){
      alert('DOCX import failed: ' + (e && e.message?e.message:e));
    }
  }

  if (btn && input){
    btn.addEventListener('click', function(e){ e.preventDefault(); input.click(); });
    input.addEventListener('change', function(){
      var f = input.files && input.files[0];
      if (f) handleFile(f);
      input.value='';
    });
  }
})();
</script><script>
(function(){
  if (window.__exportBoundStable) return; window.__exportBoundStable = true;

  function showToast(msg){
    var t=document.getElementById('be-toast'); if(!t) return;
    t.textContent = msg||'Copied to clipboard';
    t.style.opacity = '1';
    setTimeout(function(){ t.style.opacity = '0'; }, 1200);
  }

  function buildHead(){
    return '' +
      '<title></title>' +
      '<meta http-equiv="Content-Type" content="text/html; charset=utf-8">' +
      '<meta name="viewport" content="width=device-width,initial-scale=1">' +
      '<!--[if mso]><xml><w:WordDocument xmlns:w=\"urn:schemas-microsoft-com:office:word\"><w:DontUseAdvancedTypographyReadingMail/></w:WordDocument><o:OfficeDocumentSettings><o:PixelsPerInch>96</o:PixelsPerInch><o:AllowPNG/></o:OfficeDocumentSettings></xml><![endif]-->' +
      '<!--[if !mso]><link href=\"https://fonts.googleapis.com/css?family=Roboto\" rel=\"stylesheet\" type=\"text/css\"><![endif]-->';
  }

  function cloneForExport(){
    var root = document.querySelector('#nl-container') || document.querySelector('#preview') || document.body;
    var clone = root.cloneNode(true);

    // Remove editor chrome
    clone.querySelectorAll('.main-header, .be-header, .be-info, #editor-actions, .be-label, .be-block-toolbar').forEach(function(el){ el.remove(); });
    // Remove export modal and any scripts
    var modal = clone.querySelector('#export-modal'); if (modal) modal.remove();
    clone.querySelectorAll('script').forEach(function(el){ el.remove(); });
    // Remove preview-only artifacts
    clone.querySelectorAll('.be-clip, #be-toast').forEach(function(el){ el.remove(); });
    // Strip contenteditable and be-* classes
    clone.querySelectorAll('[contenteditable]').forEach(function(el){ el.removeAttribute('contenteditable'); });
    clone.querySelectorAll('[class]').forEach(function(el){
      el.className = el.className.replace(/\bbe-\w+\b/g,'').trim();
      if (!el.className) el.removeAttribute('class');
    });
    // Center presentation tables
    clone.querySelectorAll('table[role="presentation"], table.container').forEach(function(tb){
      tb.setAttribute('align','center');
      var st = tb.getAttribute('style')||'';
      if (st.indexOf('margin-left:auto')===-1) st += (st?';':'') + 'margin-left:auto;margin-right:auto;';
      tb.setAttribute('style', st);
    });

    return clone.innerHTML.trim();
  }

  ){
    var modal = document.getElementById('export-modal');
    var code  = document.getElementById('export-code');
    if (!modal || !code) return;
    code.textContent = buildExportHtml(cloneForExport());
    modal.style.display = 'block';
  }

  function closeExport(){
    var modal = document.getElementById('export-modal');
    if (modal) modal.style.display = 'none';
  }

  // Bindings (non-capturing, direct)
  var openBtn = document.getElementById('be-export');
  if (openBtn) openBtn.addEventListener('click', function(e){ e.preventDefault(); openExport(); });
  var closeBtn = document.getElementById('export-close');
  if (closeBtn) closeBtn.addEventListener('click', function(){ closeExport(); });
  var copyBtn = document.getElementById('export-copy');
  if (copyBtn) copyBtn.addEventListener('click', function(){
    var html = buildExportHtml(cloneForExport());
    navigator.clipboard.writeText(html).then(function(){ showToast('Export HTML copied'); });
  });

  // Mirror behavior for #be-copy if present (copy without opening modal)
  var copyHdr = document.getElementById('be-copy');
  if (copyHdr) copyHdr.addEventListener('click', function(){
    var html = buildExportHtml(cloneForExport());
    navigator.clipboard.writeText(html).then(function(){ showToast('Export HTML copied'); });
  });
})();
</script><script>
(function(){
  var r = document.getElementById('be-reset');
  if (!r) return;
  r.addEventListener('click', function(ev){
    ev.preventDefault();
    ev.stopPropagation();
    try { location.reload(); } catch(e){ console && console.warn('Reload failed', e); }
  }, false);
})();
</script><script>
(function(){
  // Hard reset bindings by replacing the button as well (drops legacy listeners)
  var btn = document.getElementById('import-docx');
  if (!btn) return;
  var parent = btn.parentNode;
  var cloneBtn = btn.cloneNode(true);
  // Preserve id/class/style/text
  parent.replaceChild(cloneBtn, btn);
  btn = cloneBtn;

  var inp = document.getElementById('docx-file');
  if (!inp) return;

  // Guard to ensure we only ever bind once
  if (btn.__importBoundOnce) return;
  btn.__importBoundOnce = true;

  function toast(msg){
    var t=document.getElementById('be-toast');
    if (t){ t.textContent = msg; t.style.opacity='1'; setTimeout(function(){ t.style.opacity='0'; }, 1400); }
    else { try { console.log(msg); } catch(e){} }
  }

  btn.onclick = function(ev){
    ev.preventDefault(); ev.stopPropagation();
    // prevent accidental double trigger if inside a label or nested element
    setTimeout(function(){ inp.click(); }, 0);
  };

  inp.onchange = async function(){
    var f = inp.files && inp.files[0];
    if (!f){ return; } // silent cancel
    try{
      if (typeof handleFile !== 'function') throw new Error('Importer not initialized');
      await handleFile(f);
      toast('Imported: ' + (f.name || 'document'));
    }catch(err){
      console.error(err);
      toast('Import failed: ' + (err && err.message ? err.message : err));
    }finally{
      // Allow selecting the same file again
      inp.value = '';
    }
  };
})();
</script><script>
/* Fallback importer (safe no-op if main importer exists) */
(function(){
  if (typeof handleFile === 'function') return;
  async function docxToHtml(file){
    if (window.ensureMammoth) { try { await window.ensureMammoth(); } catch(e){} }
    if (window.mammoth){
      const buf = await file.arrayBuffer();
      const res = await mammoth.convertToHtml({arrayBuffer: buf});
      return '<div>' + (res && res.value ? res.value : '') + '</div>';
    } else {
      throw new Error('Mammoth not available; try HTML import');
    }
  }
  window.handleFile = async function(file){
    var name = (file && file.name || '').toLowerCase();
    var htmlRaw;
    if (name.endsWith('.html') || name.endsWith('.htm') || file.type === 'text/html'){
      htmlRaw = await file.text();
    } else if (name.endsWith('.txt') || file.type === 'text/plain'){
      htmlRaw = await file.text();
      htmlRaw = htmlRaw.replace(/^[ \t]*-{3,}[ \t]*$/gm, '<hr data-marker="end-primary">');
      htmlRaw = htmlRaw.replace(/\n{2,}/g, '</p><p>').replace(/\n/g, '<br>');
      htmlRaw = '<div><p>' + htmlRaw + '</p></div>';
    } else {
      htmlRaw = await docxToHtml(file);
    }
    // Minimal insertion: append a single primary card with the imported HTML (for debugging pipeline)
    var root = document.getElementById('nl-container') || document.getElementById('preview') || document.body;
    var wrapper = document.createElement('div');
    wrapper.className = 'be-block';
    wrapper.setAttribute('data-type','primary');
    wrapper.setAttribute('data-label','Imported (debug)');
    wrapper.innerHTML = ''
      + '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%">'
      + '<tbody><tr><td>'
      + '<table cellpadding="0" cellspacing="0" class="container bg-white card" role="presentation" width="685">'
      + '<tbody><tr><td class="px-25 py-20 font-sans fs-16 text-dark"></td></tr></tbody></table>'
      + '</td></tr></tbody></table>';
    wrapper.querySelector('td.px-25').innerHTML = htmlRaw;
    root.appendChild(wrapper);
    var t=document.getElementById('be-toast'); if(t){ t.textContent='Imported (fallback)'; t.style.opacity='1'; setTimeout(function(){ t.style.opacity='0'; }, 1200); }
  };
})();
</script><script>
(function(){
  var btn = document.getElementById('import-docx');
  var inp = document.getElementById('docx-file');
  if (!btn || !inp) return;
  btn.onclick = function(ev){ ev.preventDefault(); ev.stopPropagation(); setTimeout(function(){ inp.click(); }, 0); };
  inp.onchange = async function(){
    var f = inp.files && inp.files[0];
    if(!f){ return; }
    try{
      if (typeof handleFile !== 'function') throw new Error('handleFile missing');
      await handleFile(f);
    }catch(e){
      var t=document.getElementById('be-toast'); if(t){ t.textContent='Import failed: '+(e.message||e); t.style.opacity='1'; setTimeout(function(){ t.style.opacity='0'; }, 1600); }
    }finally{
      inp.value='';
    }
  };
})();
</script><script>
(function(){
  // Debug panel
  function toast(msg){
    try{
      var t=document.getElementById('be-toast');
      if(t){ t.textContent=String(msg); t.style.opacity='1'; setTimeout(function(){ t.style.opacity='0'; }, 1600); }
      else { console.log(msg); }
    }catch(e){}
  }
  async function docxToHtml(file){
    await (window.ensureMammoth ? window.ensureMammoth() : Promise.resolve());
    if (!window.mammoth) throw new Error('Mammoth not available');
    const buf = await file.arrayBuffer();
    const res = await mammoth.convertToHtml({arrayBuffer: buf});
    return '<div>' + (res && res.value ? res.value : '') + '</div>';
  }
  window.handleFile = async function(file){
    // Basic, guaranteed pipeline: convert to HTML string
    var name = (file && file.name || '').toLowerCase();
    var htmlRaw;
    if (name.endsWith('.html') || name.endsWith('.htm') || file.type === 'text/html'){
      htmlRaw = await file.text();
    } else if (name.endsWith('.txt') || file.type === 'text/plain'){
      htmlRaw = await file.text();
      htmlRaw = htmlRaw.replace(/^[ \t]*-{3,}[ \t]*$/gm, '<hr data-marker="end-primary">');
      htmlRaw = htmlRaw.replace(/\n{2,}/g, '</p><p>').replace(/\n/g, '<br>');
      htmlRaw = '<div><p>' + htmlRaw + '</p></div>';
    } else {
      htmlRaw = await docxToHtml(file);
    }

    // Remove partner blocks before import
    try{
      var root = document.getElementById('nl-container') || document.getElementById('preview') || document.body;
      root.querySelectorAll('[data-type="partner-header"], [data-type="partner-card"]').forEach(function(n){ n.remove(); });
      root.querySelectorAll('[data-label]').forEach(function(n){
        var t=(n.getAttribute('data-label')||'').toLowerCase();
        if (t.indexOf('partner')!==-1) n.remove();
      });
    }catch(e){}

    // Split by HR or marker into chunks (very simple)
    var container = document.createElement('div');
    container.innerHTML = htmlRaw;
    var parts = [];
    var current = document.createElement('div');
    function pushCurrent(){
      if (current && current.innerHTML.trim()) parts.push(current);
      current = document.createElement('div');
    }
    Array.from(container.childNodes).forEach(function(node){
      if (node.nodeType===1 && node.tagName==='HR'){ pushCurrent(); }
      else current.appendChild(node.cloneNode(true));
    });
    pushCurrent();
    if (!parts.length){ parts = [container]; }

    // Where to insert: above Subscribe CTA if present; else above Disclaimer; else above Dynamic block; else append
    var root = document.getElementById('nl-container') || document.getElementById('preview') || document.body;
    var anchors = Array.from(root.querySelectorAll('[data-label]'));
    function findByLabel(substr){
      return anchors.find(function(n){ return ((n.getAttribute('data-label')||'').toLowerCase().indexOf(substr)>=0); });
    }
    var beforeNode = findByLabel('subscribe cta line') || findByLabel('disclaimer') || findByLabel('dynamic content block');
    var mount = beforeNode ? beforeNode : null;

    // Build primary-styled cards and insert
    parts.forEach(function(part, idx){
      var wrap = document.createElement('div');
      wrap.className = 'be-block';
      wrap.setAttribute('data-type','primary');
      wrap.setAttribute('data-label', 'Imported card');
      wrap.innerHTML = ''
        + '<table cellpadding="0" cellspacing="0" class="row" role="presentation" width="100%"><tbody><tr><td>'
        +   '<table cellpadding="0" cellspacing="0" class="container bg-white card" role="presentation" width="685">'
        +     '<tbody><tr><td class="px-25 py-20 font-sans fs-16 text-dark"></td></tr></tbody>'
        +   '</table>'
        + '</td></tr></tbody></table>';
      wrap.querySelector('td.px-25').innerHTML = part.innerHTML;
      if (mount && mount.parentNode){
        mount.parentNode.insertBefore(wrap, mount);
      } else {
        root.appendChild(wrap);
      }
    });

    toast('Imported ' + parts.length + ' card(s)');
  };

  // Single binding for button/input
  var btn = document.getElementById('import-docx');
  var inp = document.getElementById('docx-file');
  if (btn && inp){
    btn.onclick = function(ev){ ev.preventDefault(); ev.stopPropagation(); setTimeout(function(){ inp.click(); },0); };
    inp.onchange = function(){
      var f = inp.files && inp.files[0];
      if (!f) return;
      handleFile(f).catch(function(e){ toast('Import failed: ' + (e.message||e)); });
      inp.value='';
    };
  }
})();</script><script>
const RAW_STYLES = ``;
const TRAIL_HTML = ``;

// Inject template styles into <head>
(function(){ if (RAW_STYLES && !document.getElementById('braze-email-styles')){ const d=document.createElement('div'); d.id='braze-email-styles'; d.innerHTML=RAW_STYLES; [...d.childNodes].forEach(n=>document.head.appendChild(n)); } })();

const preview = document.getElementById('preview');
preview.setAttribute('contenteditable','true');

function nextTableAfter(node) {
  let probe = node.nextSibling, hops=0;
  while (probe && hops < 80) {
    if (probe.nodeType === 1 && probe.tagName === 'TABLE') return probe;
    if (probe.nodeType === 1) { const t = probe.querySelector('table'); if (t) return t; }
    probe = probe.nextSibling; hops++;
  }
  return null;
}

// Group Rows 1–4 into one locked header block
(function groupHeader(){
  const walker = document.createTreeWalker(preview, NodeFilter.SHOW_COMMENT, null);
  const labels = []; let n; while(n = walker.nextNode()) labels.push(n);
  const row1 = labels.find(c => /^\\s*Row\\s*1\\b/i.test(c.data||''));
  const row4 = labels.find(c => /^\\s*Row\\s*4\\b/i.test(c.data||''));
  if (!row1 || !row4) return;
  const firstTable = nextTableAfter(row1);
  const lastTable = nextTableAfter(row4);
  if (!firstTable || !lastTable) return;
  const wrap = document.createElement('div');
  wrap.className='be-block'; wrap.dataset.type='locked'; wrap.dataset.label='Header (Rows 1–4)';
  const lbl = document.createElement('div'); lbl.className='be-label'; lbl.innerHTML='<i class="dot"></i><span>Header (Rows 1–4)</span>';
  const tools = document.createElement('div'); tools.className='be-block-toolbar'; tools.innerHTML='<button class="be-ico be-handle" disabled>⋮⋮</button><button class="be-ico" disabled>Copy</button><button class="be-ico" disabled>Delete</button>';
  wrap.appendChild(lbl); wrap.appendChild(tools);
  firstTable.parentNode.insertBefore(wrap, firstTable);
  let cur = firstTable;
  while (cur) { const nx = cur.nextSibling; wrap.appendChild(cur); if (cur === lastTable) break; cur = nx; }
})();

// Wrap remaining blocks, skipping spacers (append to previous block); infer type
(function wrapBlocks(){
  const walker = document.createTreeWalker(preview, NodeFilter.SHOW_COMMENT, null);
  const comments = []; let n; while(n = walker.nextNode()) comments.push(n);
  const blocks = [];
  function isSpacer(label){ return /spacer/i.test(label) && !/story|card/i.test(label); }
  comments.forEach(c => {
    const label = (c.data||'').trim();
    if (!label || /^\\s*Row\\s*(1|2|3|4)\\b/i.test(label)) return;
    if (/Were you forwarded this email/i.test(label)) return;
    const table = nextTableAfter(c);
    if (!table) return;

    if (isSpacer(label)) { const prev = blocks[blocks.length-1]; if (prev) prev.appendChild(table); return; }

    let type='primary';
    if (/from our partners/i.test(label) && /header/i.test(label)) type='partner-header';
    else if (/from our partners/i.test(label)) type='partner-card';
    else if (/today's stories|secondary|beige/i.test(label)) type='secondary';

    const wrap = document.createElement('div'); wrap.className='be-block'; wrap.dataset.type=type; wrap.dataset.label=label;
    const lbl = document.createElement('div'); lbl.className='be-label'; lbl.innerHTML='<i class="dot"></i><span>'+label+'</span>';
    const tools = document.createElement('div'); tools.className='be-block-toolbar'; tools.innerHTML='<button class="be-ico be-handle">⋮⋮</button><button class="be-ico" data-act="dup">Copy</button><button class="be-ico" data-act="del">Delete</button>';
    wrap.appendChild(lbl); wrap.appendChild(tools);
    table.parentNode.insertBefore(wrap, table);
    wrap.appendChild(table);
    blocks.push(wrap);
  });
  document.getElementById('be-count').textContent = preview.querySelectorAll('.be-block').length + ' blocks';
})();

// ===== Mouse-based sortable (works in Chrome with contenteditable) =====
(function enableMouseSort(){
  let dragging = null;
  let startY = 0;
  let ghost = null;
  const placeholder = document.createElement('div'); placeholder.className = 'be-placeholder';

  function blocks(){ return [...preview.querySelectorAll('.be-block')]; }

  function onMouseMove(e){
    if(!dragging || !ghost) return;
    ghost.style.top = (e.clientY + 8) + 'px';
    ghost.style.left = (e.clientX + 8) + 'px';

    // Decide placeholder position
    const candidates = blocks().filter(b => b !== dragging);
    let best = null, bestDist = Infinity;
    const y = e.clientY;
    for(const c of candidates){
      const r = c.getBoundingClientRect();
      const mid = r.top + r.height/2;
      const dist = Math.abs(y - mid);
      if (dist < bestDist){ bestDist = dist; best = {el:c, before: y < mid}; }
    }
    if (best){
      const ref = best.el;
      if (best.before){
        if (placeholder !== ref.previousSibling) ref.parentNode.insertBefore(placeholder, ref);
      } else {
        if (placeholder !== ref.nextSibling) ref.parentNode.insertBefore(placeholder, ref.nextSibling);
      }
    } else {
      preview.appendChild(placeholder);
    }
  }

  function endDrag(){
    if(!dragging) return;
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', endDrag);
    if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
    ghost = null;
    dragging.classList.remove('dragging');
    if (placeholder.parentNode) placeholder.parentNode.insertBefore(dragging, placeholder);
    if (placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
    dragging = null;
    const badge = document.getElementById('be-count'); if (badge) badge.textContent = blocks().length + ' blocks';
  }

  preview.addEventListener('mousedown', (e)=>{
    const h = e.target.closest('.be-handle'); if (!h) return;
    const b = h.closest('.be-block'); if (!b || b.dataset.type==='locked') return;
    e.preventDefault(); // don't select text
    dragging = b;
    startY = e.clientY;
    dragging.classList.add('dragging');

    // Create ghost
    const r = b.getBoundingClientRect();
    ghost = document.createElement('div');
    ghost.className = 'be-ghost';
    ghost.style.width = r.width + 'px';
    ghost.style.height = r.height + 'px';
    ghost.style.top = (e.clientY + 8) + 'px';
    ghost.style.left = (e.clientX + 8) + 'px';
    const inner = document.createElement('div');
    inner.className = 'be-ghost-inner';
    inner.innerHTML = b.innerHTML;
    ghost.appendChild(inner);
    document.body.appendChild(ghost);

    // Insert placeholder after the block initially
    b.parentNode.insertBefore(placeholder, b.nextSibling);

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', endDrag);
  });

  // Buttons
  preview.addEventListener('click', e=>{
    const btn = e.target.closest('.be-ico'); if(!btn) return;
    const block = btn.closest('.be-block'); if(!block) return;
    if (block.dataset.type==='locked') return;
    if (btn.dataset.act==='del') block.remove();
    if (btn.dataset.act==='dup') block.parentNode.insertBefore(block.cloneNode(true), block.nextSibling);
    const badge = document.getElementById('be-count'); if (badge) badge.textContent = blocks().length + ' blocks';
  });

  // Rebind not needed; handlers are delegation-based
})();

// Add buttons clone first seen templates
(function addButtons(){
  function template(sel){ const n = preview.querySelector(sel); return n ? n.cloneNode(true) : null; }
  document.getElementById('add-primary').addEventListener('click', ()=>{ const t=template('.be-block[data-type="primary"]'); if(t) preview.appendChild(t); });
  document.getElementById('add-secondary').addEventListener('click', ()=>{ const t=template('.be-block[data-type="secondary"]'); if(t) preview.appendChild(t); });
  document.getElementById('add-partner').addEventListener('click', ()=>{ const h=template('.be-block[data-type="partner-header"]'); const c=template('.be-block[data-type="partner-card"]'); if(h) preview.appendChild(h); if(c) preview.appendChild(c); });
})();

// Inline formatting toolbar + clean paste
const toolbar = document.getElementById('be-toolbar');
function showToolbarAtSelection(){
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) return;
  const r = sel.getRangeAt(0).getBoundingClientRect();
  if (!r) return;
  toolbar.style.display = 'block';
  toolbar.style.left = (r.left + r.width/2 + window.scrollX) + 'px';
  toolbar.style.top  = (r.top + window.scrollY - 8) + 'px';
}
preview.addEventListener('mouseup', showToolbarAtSelection);
preview.addEventListener('keyup', showToolbarAtSelection);
window.addEventListener('scroll', () => { if (toolbar.style.display==='block') showToolbarAtSelection(); }, { passive: true });

toolbar.addEventListener('click', (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const cmd = btn.dataset.cmd;
  if (cmd === 'formatBlock') document.execCommand('formatBlock', false, btn.dataset.value);
  else if (cmd) document.execCommand(cmd, false, null);
});
document.getElementById('be-link').addEventListener('click', ()=>{ const url = prompt('Link URL:'); if(!url) return; document.execCommand('createLink', false, url); });
document.getElementById('be-clear').addEventListener('click', ()=>{ document.execCommand('removeFormat', false, null); const sel=window.getSelection(); if(sel && sel.anchorNode){ const a= sel.anchorNode.parentElement && sel.anchorNode.parentElement.closest('a'); if(a){ const t=document.createTextNode(a.textContent); a.parentNode.replaceChild(t,a); } } });

// Clean paste
const cleanToggle = document.getElementById('be-clean-paste');
preview.addEventListener('paste', (e)=>{
  if (!cleanToggle.checked) return;
  const html = (e.clipboardData && e.clipboardData.getData('text/html')) || '';
  if (!html) return;
  e.preventDefault();
  const cleaned = (function stripFonts(html){
    const doc=new DOMParser().parseFromString('<div id=rt>'+html+'</div>','text/html');
    const root=doc.getElementById('rt');
    (function walk(n){
      if(n.nodeType===1){
        if(n.getAttribute('style')){
          let s=n.getAttribute('style').replace(/font-family\\s*:\\s*[^;]+;?/gi,'').replace(/font\\s*:\\s*[^;]+;?/gi,''); 
          s=s.replace(/;;+/g,';').replace(/\\s{2,}/g,' ').trim(); 
          if(s==='') n.removeAttribute('style'); else n.setAttribute('style',s);
        }
        if(n.tagName==='FONT'){ const span=doc.createElement('span'); const color=n.getAttribute('color'); if(color) span.style.color=color; while(n.firstChild) span.appendChild(n.firstChild); n.parentNode.replaceChild(span,n); }
        else if(n.hasAttribute('face')) n.removeAttribute('face');
      }
      let c=n.firstChild; while(c){ const nx=c.nextSibling; walk(c); c=nx; }
    })(root);
    return root.innerHTML;
  })(html);
  document.execCommand('insertHTML', false, cleaned);
});

// Copy/export full email HTML (styles + edited preview + trail)
document.getElementById('be-copy').addEventListener('click', async ()=>{
  const out = `` + "\\n" + preview.innerHTML + "\\n" + ``;
  try { await navigator.clipboard.writeText(out); alert('✅ Email HTML copied. Paste into Braze.'); }
  catch(e) { const blob=new Blob([out],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='email-for-braze.html'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove(); alert('Clipboard blocked — downloaded the HTML instead.'); }
});

document.getElementById('be-reset').addEventListener('click', ()=>location.reload());
</script><script>
  window.onload = function() {
    parent.postMessage(document.body.scrollHeight, "*");
  };
</script>

<script>
(function(){
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initSelectionGuards, { once:true });
  } else { initSelectionGuards(); }

  function initSelectionGuards(){
    var preview = document.getElementById('preview');
    if (!preview) return;

    // Ensure only editable bodies are focusable
    preview.querySelectorAll('.be-block').forEach(function(host){
      host.setAttribute('tabindex','-1'); // shell unfocusable
      var body = host.querySelector('.be-target-body');
      if (body){
        if (!body.hasAttribute('tabindex')) body.setAttribute('tabindex','0'); // focus target
        body.setAttribute('contenteditable','true');
      }
    });

    // Route accidental clicks on shell/label/toolbar into the inner editable body
    preview.addEventListener('mousedown', function(e){
      var isEditable = e.target.closest('.be-target-body');
      if (isEditable) return; // normal behavior
      var host = e.target.closest('.be-block');
      if (!host) return;
      var body = host.querySelector('.be-target-body');
      if (!body) return;
      // Prevent selecting the shell
      e.preventDefault();
      // Focus the editable area instead
      body.focus({ preventScroll: true });
    }, true); // capture: true to pre-empt other handlers

    // Also guard key focus (e.g., tabbing onto shell)
    preview.addEventListener('focusin', function(e){
      var host = e.target.closest && e.target.closest('.be-block');
      if (host && !e.target.closest('.be-target-body')){
        var body = host.querySelector('.be-target-body');
        if (body){
          body.focus({ preventScroll: true });
        }
      }
    });
  }
})();
</script>

<script>
(function(){
  if (window.__docxImporterInit_v8) return;
  window.__docxImporterInit_v8 = true;

  function isHeaderLikeTable(tbl){
    var sty = (tbl.getAttribute('style')||'').toLowerCase();
    var text = (tbl.textContent||'').toLowerCase();
    return (
      /border-radius:\s*22px\s*22px\s*0\s*0/.test(sty) ||
      /background(?:-color)?:\s*#1d53ff/.test(sty) ||
      text.indexOf('from our partners') !== -1
    );
  }
  function normalize(s){ return (s||'').toLowerCase().replace(/\s+/g,' ').trim(); }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init, { once:true });
  } else { init(); }

  function init(){
    var preview = document.getElementById('preview');
    if (!preview) return;

    var fileInput = document.querySelector('input[type="file"]#docx-file');
    if (!fileInput){
      fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.id = 'docx-file';
      fileInput.accept = '.docx';
      fileInput.style.display = 'none';
      document.body.appendChild(fileInput);
    } else {
      var fresh = fileInput.cloneNode(true);
      fileInput.parentNode.replaceChild(fresh, fileInput);
      fileInput = fresh;
    }

    var importBtn = document.getElementById('import-docx');
    if (!importBtn){
      importBtn = document.createElement('button');
      importBtn.id = 'import-docx';
      importBtn.type = 'button';
      importBtn.style.display = 'none';
      document.body.appendChild(importBtn);
    } else {
      try{ importBtn.onclick = null; }catch(e){}
      var f2 = importBtn.cloneNode(true);
      importBtn.parentNode.replaceChild(f2, importBtn);
      importBtn = f2;
    }

    var choosing=false, running=false;
    importBtn.addEventListener('click', function(ev){
      ev.preventDefault(); ev.stopImmediatePropagation(); ev.stopPropagation();
      if (choosing || running) return;
      choosing = true;
      fileInput.click();
    }, true);

    fileInput.addEventListener('change', function(ev){
      ev.stopImmediatePropagation(); ev.stopPropagation();
      if (running){ fileInput.value=''; choosing=false; return; }

      var file = fileInput.files && fileInput.files[0];
      if (!file){ choosing=false; return; }
      if (!window.mammoth){ alert('DOCX parser not available.'); fileInput.value=''; choosing=false; return; }

      running = true; importBtn.disabled = true; fileInput.disabled = true;

      file.arrayBuffer().then(function(buf){
        return window.mammoth.convertToHtml(
          { arrayBuffer: buf },
          {
            styleMap: [
              "p[style-name='Heading 1'] => h1:fresh",
              "p[style-name='Heading 2'] => h2:fresh",
              "p[style-name='Heading 3'] => h3:fresh",
              "p => p:fresh",
              "rStyle[style-name='Superscript'] => sup",
              "rStyle[style-name='Subscript']  => sub",
              "u => u",
              "strike => s"
            ].join('\\n'),
            includeEmbeddedStyleMap: true,
            ignoreEmptyParagraphs: true,
            convertImage: window.mammoth.images.imgElement(function(image){
              return image.read('base64').then(function(src){
                return { src: 'data:' + image.contentType + ';base64,' + src };
              });
            })
          }
        );
      }).then(function(result){
        var html = (result && result.value) || '';

        var parser = new DOMParser();
        var doc = parser.parseFromString('<div id="__stage__">'+ html +'</div>', 'text/html');
        var stage = doc.getElementById('__stage__');
        stage.querySelectorAll('script,style,noscript,link,meta,title,head').forEach(function(n){ n.remove(); });
        var walker = doc.createTreeWalker(stage, NodeFilter.SHOW_COMMENT, null);
        var cmts = []; while (walker.nextNode()) cmts.push(walker.currentNode); cmts.forEach(function(n){ n.remove(); });

        function trimTop(html){
          return html.replace(/^(?:\s|&nbsp;|<br\s*\/?>|<(?:p|div)>\s*<\/(?:p|div)>)+/i, '').trim();
        }

        var raw = stage.innerHTML;
        var types = ['primary','secondary','partner','partner-header'];
        var startRE = new RegExp("\\{\\{\\s*start-(" + types.join('|') + ")\\s*\\}\\}", "ig");
        var endRE   = new RegExp("\\{\\{\\s*end-("   + types.join('|') + ")\\s*\\}\\}", "ig");

        function extractByMarkers(sourceHtml){
          var segments = [];
          var m;
          startRE.lastIndex = 0;
          while ((m = startRE.exec(sourceHtml))){
            var t = (m[1]||'').toLowerCase();
            var contentStart = m.index + m[0].length;
            endRE.lastIndex = contentStart;
            var eMatch, endPos = -1;
            while ((eMatch = endRE.exec(sourceHtml))){
              if ((eMatch[1]||'').toLowerCase() === t){ endPos = eMatch.index; break; }
            }
            var content, nextIndex;
            if (endPos === -1){
              var nextStart = startRE.exec(sourceHtml);
              var end = nextStart ? nextStart.index : sourceHtml.length;
              content = sourceHtml.slice(contentStart, end);
              nextIndex = end;
            } else {
              content = sourceHtml.slice(contentStart, endPos);
              nextIndex = endRE.lastIndex;
            }
            content = content.replace(startRE, '').replace(endRE, '');
            content = trimTop(content);
            if (content.replace(/[\s\u00a0]+/g,'').length > 0){
              segments.push({ type: t, html: content });
            }
            startRE.lastIndex = nextIndex;
          }
          return segments;
        }

        var segments = extractByMarkers(raw);

        if (!segments.length){
          var tds = Array.from(stage.querySelectorAll('table')).map(function(t){
            var cells = Array.from(t.querySelectorAll('td'));
            var best = cells.sort(function(a,b){ return (b.textContent||'').length - (a.textContent||'').length; })[0] || t;
            return { type: null, html: trimTop(best.innerHTML.trim()) };
          }).filter(function(o){ return o.html && o.html.replace(/[\s\u00a0]+/g,'').length>0; });
          segments = tds;
        }

        if (!segments.length) throw new Error('No content found in the DOCX.');

        function typeToLabel(t){
          if (!t) return null;
          if (t === 'primary') return 'Primary';
          if (t === 'secondary') return 'Secondary';
          if (t === 'partner' || t === 'partner-header') return 'Partner card';
          return null;
        }

        function renderPartnerHeader(titleText){
          function esc(s){ return s.replace(/&/g,'&amp;'); }
          var inner = '<strong>' + esc(titleText || 'From Our Partners') + '</strong>';
          return '' +
          '<table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace:0;mso-table-rspace:0;" width="100%">' +
          '<tbody><tr><td align="center" style="">' +
          '<table border="0" cellpadding="0" cellspacing="0" role="presentation" style="width:685px;max-width:100%;background-color:#1d53ff;border:2px solid #232021;border-radius:22px 22px 0 0;" width="685">' +
          '<tbody><tr><td style="padding:20px 25px 10px 25px;">' +
          '<p style="margin:0;font-family:Helvetica,Arial,sans-serif;font-size:20px;line-height:1.2;color:#ffffff;">' + inner + '</p>' +
          '</td></tr></tbody></table>' +
          '</td></tr></tbody></table>';
        }
        function extractHeaderTitleText(fragmentHtml){
          var d = new DOMParser().parseFromString('<div>'+ fragmentHtml +'</div>','text/html');
          var txt = d.body.textContent || '';
          txt = txt.replace(/\{\{[^}]*\}\}/g,'').trim();
          return txt;
        }

        (function pairPartnerStrict(){
          var pendingHeader = null, pendingTitle = null;
          for (var i=0; i<segments.length; i++){
            var seg = segments[i];
            if (seg.type === 'partner-header'){
              pendingHeader = seg.html;
              pendingTitle  = extractHeaderTitleText(pendingHeader);
              segments.splice(i,1);
              i--;
              continue;
            }
            if (pendingHeader && seg.type === 'partner'){
              // Prepare partner body
              var d = new DOMParser().parseFromString('<div>'+ seg.html +'</div>','text/html');
              var root = d.body.firstElementChild || d.body;
              var changed = false;

              // Remove header-like tables at top
              var child = root.firstElementChild;
              while (child && child.tagName === 'TABLE' && isHeaderLikeTable(child)){
                var rm = child; child = child.nextElementSibling; rm.remove(); changed = true;
              }

              // Remove any nodes before first table (to kill "between header and card" text)
              var firstTable = root.querySelector('table');
              if (firstTable){
                var n = root.firstChild;
                while (n && n !== firstTable){
                  var next = n.nextSibling;
                  root.removeChild(n);
                  n = next;
                  changed = true;
                }
              }

              // Remove leading p/div matching title text
              child = root.firstElementChild;
              var titleNorm = normalize(pendingTitle);
              while (child && /^(P|DIV)$/i.test(child.tagName)){
                var childNorm = normalize(child.textContent);
                if (titleNorm && childNorm === titleNorm){
                  var rm2 = child; child = child.nextElementSibling; rm2.remove(); changed = true; continue;
                }
                break;
              }

              var cleaned = changed ? (root.innerHTML || '') : seg.html;

              // Prepend header
              var headerHTML = renderPartnerHeader(pendingTitle);
              var wrap = new DOMParser().parseFromString('<div>'+ headerHTML + cleaned +'</div>', 'text/html');
              var outRoot = wrap.body.firstElementChild || wrap.body;

              // HARD STOP: remove any non-table nodes directly after the header table until next table
              var first = outRoot.firstElementChild; // should be outer table wrapper of header
              if (first && first.tagName === 'TABLE'){
                var after = first.nextSibling;
                while (after && !(after.nodeType === 1 && after.tagName === 'TABLE')){
                  var nx = after.nextSibling;
                  outRoot.removeChild(after);
                  after = nx;
                }
              }

              seg.html = outRoot.innerHTML;
              pendingHeader = null; pendingTitle = null;
            }
          }
          if (pendingHeader){
            var headerHTML = renderPartnerHeader(extractHeaderTitleText(pendingHeader));
            // No body => only header
            segments.push({ type: 'partner', html: headerHTML });
          }
        })();

        // Fill blocks (create extra as needed)
        var bodies = Array.from(preview.querySelectorAll('.be-block .be-target-body'));
        var shells = bodies.map(function(b){ return b.closest('.be-block'); });

        function makeBlockShell(labelText, dataType){
          var shell = document.createElement('div');
          shell.className = 'be-block';
          if (dataType) shell.dataset.type = (dataType === 'partner') ? 'partner-card' : dataType;
          var label = '<div class="be-label"><span><span class="dot"></span> ' + (labelText || 'Imported') + '</span></div>';
          var toolbar = '<div class="be-block-toolbar"><button class="be-ico be-handle" title="Drag">⋮⋮</button><button class="be-ico be-copy" title="Copy">Copy</button><button class="be-ico be-delete" title="Delete</button></div>';
          var body = '<div class="be-target-body" contenteditable="true"></div>';
          shell.innerHTML = label + toolbar + body;
          return shell;
        }

        function typeToLabel(t){
          if (!t) return null;
          if (t === 'primary') return 'Primary';
          if (t === 'secondary') return 'Secondary';
          if (t === 'partner' || t === 'partner-header') return 'Partner card';
          return null;
        }

        if (segments.length > bodies.length){
          var toAdd = segments.length - bodies.length;
          for (var i=0;i<toAdd;i++){
            var seg = segments[bodies.length + i];
            var labelText = typeToLabel(seg.type) || 'Imported';
            var shell = makeBlockShell(labelText, seg.type);
            preview.appendChild(shell);
            bodies.push(shell.querySelector('.be-target-body'));
            shells.push(shell);
          }
        }

        var n = Math.min(bodies.length, segments.length);
        for (var i=0;i<n;i++){
          var seg = segments[i];
          var body = bodies[i];
          var shell = shells[i];
          body.innerHTML = seg.html;
          body.setAttribute('contenteditable','true');
          if (seg.type){
            shell.dataset.type = (seg.type === 'partner') ? 'partner-card' : seg.type;
            var lbl = shell.querySelector('.be-label');
            var ltxt = typeToLabel(seg.type);
            if (lbl && ltxt){ lbl.innerHTML = '<span><span class="dot"></span> ' + ltxt + '</span>'; }
        // Notify hooks that import fill completed
        try { document.dispatchEvent(new CustomEvent('nb:afterImportFill')); } catch(e) {}
          }
        }

      }).catch(function(err){
        console.error(err);
        alert('Import failed: ' + (err && err.message ? err.message : err));
      }).finally(function(){
        choosing=false; running=false; fileInput.value=''; importBtn.disabled=false; fileInput.disabled=false;
      });
    }, true);
  }
})();
</script>

<script>
(function(){
  function isEmptyNode(node){
    if (!node) return false;
    if (node.nodeType === 3) return !node.nodeValue || !node.nodeValue.trim();
    if (node.nodeType === 1){
      if (node.tagName === 'BR') return true;
      if ((/^(P|DIV|PRE)$/).test(node.tagName) && !node.textContent.trim()) return true;
    }
    return false;
  }
  function trimLeading(parent){
    while (isEmptyNode(parent.firstChild)){
      parent.removeChild(parent.firstChild);
    }
  }
  function compressBRs(parent){
    var n = parent.firstChild, prevBR = false;
    while (n){
      var next = n.nextSibling;
      if (n.nodeType === 1 && n.tagName === 'BR'){
        if (prevBR){ parent.removeChild(n); }
        else { prevBR = true; }
      } else if (n.nodeType === 3 && !n.nodeValue.trim()){
        parent.removeChild(n);
      } else {
        prevBR = false;
      }
      n = next;
    }
  }
  function makeSpacerPre(){
    var pre = document.createElement('pre');
    pre.textContent = ""; // empty pre as spacer
    // no styles: let email CSS handle spacing
    return pre;
  }
  function firstIsStrongInline(body){
    return body.firstElementChild && body.firstElementChild.tagName === 'STRONG';
    }
  function firstIsPWithStrong(body){
    var el = body.firstElementChild;
    return el && el.tagName === 'P' && el.firstElementChild && el.firstElementChild.tagName === 'STRONG';
  }
  function nextIsUL(node){
    var next = node.nextElementSibling;
    return next && next.tagName === 'UL';
  }
  function removeLeadingBRInside(el){
    while (el && el.firstChild && el.firstChild.nodeType === 1 && el.firstChild.tagName === 'BR'){
      el.removeChild(el.firstChild);
    }
  }

  // Deep trailing BR removal: walk to the deepest last content container then strip trailing <br> and whitespace text nodes
  function removeTrailingBRsDeep(root){
    if (!root) return false;
    // Find deepest container by following lastChild chain while element has children
    var node = root;
    var last = null;
    // descend into last element/child repeatedly
    while (node){
      last = node;
      if (node.lastElementChild){
        node = node.lastElementChild;
      } else if (node.lastChild && node.lastChild.nodeType === 3 && node.childNodes.length === 1){
        break; // single text child
      } else {
        break;
      }
    }
    // We want to operate on the container that actually holds the trailing nodes.
    // If 'last' is a text node or <br>, step to its parent.
    if (last && (last.nodeType === 3 || (last.nodeType === 1 && last.tagName === 'BR'))){
      last = last.parentNode || root;
    }
    var changed = false;
    var target = last || root;
    // Remove trailing whitespace text nodes and <br> in this target, and also bubble one level up if it becomes empty
    function stripTrailingIn(el){
      var did = false;
      var n = el.lastChild;
      while (n && ((n.nodeType === 3 && !n.nodeValue.trim()) || (n.nodeType === 1 && n.tagName === 'BR'))){
        var prev = n.previousSibling;
        el.removeChild(n);
        n = prev;
        did = true;
      }
      return did;
    }
    // Try stripping in the deepest and up to two parent levels
    var current = target;
    for (var i=0;i<3 && current && current !== root.parentNode;i++){
      if (stripTrailingIn(current)) changed = true;
      // if container ends up empty and is a trivial wrapper (P/DIV/TD), move up
      if (!current.lastChild && /^(P|DIV|TD|SPAN|SECTION|ARTICLE)$/i.test(current.tagName||"")){
        current = current.parentNode;
      } else {
        break;
      }
    }
    return changed;
  }

  function normalizeBody(body){
    if (!body) return;
    trimLeading(body);

    // Spacer: only when first is bold and next isn't UL
    if (firstIsStrongInline(body)){
      var strong = body.firstElementChild;
      removeLeadingBRInside(strong);
      if (!nextIsUL(strong)){
        var spacer = makeSpacerPre();
        body.insertBefore(spacer, strong.nextSibling);
      }
    } else if (firstIsPWithStrong(body)){
      var p = body.firstElementChild;
      removeLeadingBRInside(p);
      if (!nextIsUL(p)){
        var spacer2 = makeSpacerPre();
        body.insertBefore(spacer2, p.nextSibling);
      }
    }

    // Partner-card trailing BR cleanup (deep)
    var shell = body.closest && body.closest('.be-block');
    if (shell && (shell.dataset.type === 'partner-card' || shell.getAttribute('data-type') === 'partner-card')){
      // remove trailing BRs at body level
      removeTrailingBRsDeep(body);
      // also try inside any last TD within tables
      var lastTD = body.querySelector('table td:last-child');
      if (lastTD){
        removeTrailingBRsDeep(lastTD);
      }
    }

    // General: compress multiple <br> at root
    compressBRs(body);
  }

  function run(){
    var bodies = document.querySelectorAll('.be-block .be-target-body');
    bodies.forEach(normalizeBody);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      run();
      document.addEventListener('nb:afterImportFill', run);
    }, { once:true });
  } else {
    run();
    document.addEventListener('nb:afterImportFill', run);
  }
})();
</script>

<script>
(function(){
  if (window.__beExportFixed) return;
  window.__beExportFixed = true;

  function sel(q,root){ return (root||document).querySelector(q); }
  function selAll(q,root){ return Array.prototype.slice.call((root||document).querySelectorAll(q)); }

  // Replace export button to drop old listeners
  var btn = sel('#be-export');
  if (btn){
    var fresh = btn.cloneNode(true);
    try{ btn.onclick = null; }catch(e){}
    btn.parentNode.replaceChild(fresh, btn);
    btn = fresh;
  }

  // Ensure modal skeleton exists
  var modal = sel('#export-modal');
  if (!modal){
    modal = document.createElement('div');
    modal.id = 'export-modal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:99999;';
    modal.innerHTML = ''+
      '<div style="background:#fff;max-width:960px;width:90%;margin:5vh auto;padding:16px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
          '<h3 style="margin:0;font-family:system-ui,Segoe UI,Helvetica,Arial,sans-serif;">Export HTML</h3>' +
          '<button id="export-close" type="button" style="border:0;background:#eee;padding:6px 10px;border-radius:8px;cursor:pointer;">Close</button>' +
        '</div>' +
        '<textarea id="export-code" style="width:100%;height:60vh;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;white-space:pre;overflow:auto;"></textarea>' +
        '<div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">' +
          '<button id="export-copy" type="button" style="border:0;background:#1d53ff;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;">Copy to clipboard</button>' +
        '</div>' +
      '</div>';
    document.body.appendChild(modal);
  }

  var closeBtn = sel('#export-close', modal);
  var codeEl   = sel('#export-code', modal);
  var copyBtn  = sel('#export-copy', modal);

  function stripEditorArtifacts(root){
    // unwrap .be-target-body into its children
    selAll('.be-target-body', root).forEach(function(b){
      // remove spacer PREs that may be editor-only
      selAll('pre:empty', b).forEach(function(p){ p.remove(); });
      var frag = document.createDocumentFragment();
      while (b.firstChild) frag.appendChild(b.firstChild);
      b.replaceWith(frag);
    });
    // remove editor chrome
    selAll('.be-block-toolbar, .be-label, .be-ico', root).forEach(function(n){ n.remove(); });
    // remove empty wrappers
    selAll('.be-block', root).forEach(function(n){
      n.removeAttribute('contenteditable');
      n.removeAttribute('tabindex');
      n.removeAttribute('data-editable');
      n.removeAttribute('data-type');
      if (n.dataset) { try { delete n.dataset.type; } catch(e){} }
      // replace block with its content
      var body = sel('.be-target-body', n);
      if (!body){
        // already unwrapped above; flatten container if it only wraps content
        var frag = document.createDocumentFragment();
        while (n.firstChild) frag.appendChild(n.firstChild);
        n.replaceWith(frag);
      }
    });
    // strip editor classes starting with be-
    selAll('[class]', root).forEach(function(el){
      el.className = el.className.split(/\s+/).filter(function(c){ return !/^be-/.test(c); }).join(' ');
      if (!el.className) el.removeAttribute('class');
    });
    // remove contenteditable & tabindex from all
    selAll('[contenteditable]', root).forEach(function(el){ el.removeAttribute('contenteditable'); });
    selAll('[tabindex]', root).forEach(function(el){ el.removeAttribute('tabindex'); });
    // remove helper scripts/styles we injected
    selAll('script, style', root).forEach(function(el){
      // keep inline style attributes; remove style tags
      if (el.tagName === 'STYLE' || (el.tagName === 'SCRIPT')) el.remove();
    });
    // remove empty text nodes at top level of exported root
    return root;
  }

  function buildHeadMinimal(){
    var head = '' +
      '<meta charset="utf-8">' +
      '<meta name="viewport" content="width=device-width,initial-scale=1">' +
      '<meta http-equiv="x-ua-compatible" content="ie=edge">' +
      '<title>Export</title>';
    return head;
  }

  function buildExportHtml(bodyInner){
    return '<!doctype html><html><head>' + buildHeadMinimal() + '</head><body>' + bodyInner + '</body></html>';
  }

  function cloneForExport(){
    var preview = sel('#preview');
    if (!preview) return '';
    var clone = preview.cloneNode(true);
    clone.id = 'preview-export';
    stripEditorArtifacts(clone);
    // center presentation tables
    selAll('table[role="presentation"], table.container', clone).forEach(function(tb){
      tb.setAttribute('align','center');
      var st = tb.getAttribute('style')||'';
      if (!/margin-left:auto/.test(st)) st += (st?';':'') + 'margin-left:auto;margin-right:auto';
      tb.setAttribute('style', st);
    });
    // trim
    var html = clone.innerHTML.trim();
    // remove stray empty paragraphs/pre/line breaks at very end of export
    html = html.replace(/(?:<br\s*\/?>|\s|&nbsp;|<p>\s*<\/p>|<pre>\s*<\/pre>)+$/i, '');
    return html;
  }

  function openExport(){
    var bodyHtml = cloneForExport();
    if (!bodyHtml){ alert('Nothing to export'); return; }
    codeEl.value = buildExportHtml(bodyHtml);
    modal.style.display = 'block';
  }

  function closeExport(){ modal.style.display = 'none'; }

  if (btn){
    btn.addEventListener('click', function(e){ e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation(); openExport(); }, true);
  }
  if (closeBtn){
    closeBtn.addEventListener('click', function(){ closeExport(); });
  }
  if (copyBtn){
    copyBtn.addEventListener('click', function(){
      navigator.clipboard.writeText(codeEl.value).then(function(){});
    });
  }
})();
</script>

<script>
(function(){
  if (window.__beExportBound) return; window.__beExportBound = true;
  function byId(id){ return document.getElementById(id); }
  function selAll(q, root){ return Array.prototype.slice.call((root||document).querySelectorAll(q)); }
  (function ensureModal(){
    var modal = byId('export-modal');
    if (modal) return;
    var tpl = document.createElement('div');
    tpl.id = 'export-modal';
    tpl.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99998;';
    tpl.innerHTML =
      '<div style="position:absolute;left:50%;top:10%;transform:translate(-50%,0);background:#fff;width:min(900px,90vw);max-height:80vh;overflow:auto;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:16px;">'
    + '  <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;">'
    + '    <div style="font:600 16px/1.2 system-ui,Segoe UI,Arial,sans-serif;">Export HTML</div>'
    + '    <button id="export-close" style="padding:6px 10px;border:1px solid #ccc;border-radius:8px;background:#f7f7f7;cursor:pointer;">Close</button>'
    + '  </div>'
    + '  <pre id="export-code" style="background:#111;color:#fff;padding:12px;border-radius:8px;white-space:pre-wrap;word-break:break-word;max-height:56vh;overflow:auto;"></pre>'
    + '  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">'
    + '    <button id="export-copy" style="padding:8px 12px;border:1px solid #005bfb;border-radius:8px;background:#005bfb;color:#fff;cursor:pointer;">Copy email HTML</button>'
    + '  </div>'
    + '</div>';
    (document.body || document.documentElement).appendChild(tpl);
  })();
  function collectInlineStyles(){
    var css = []; selAll('style').forEach(function(st){ try { css.push(st.textContent || ''); } catch(e){} });
    return css.join('\n\n');
  }
  function stripEditorArtifacts(root){
    selAll('.main-header, .be-info, .be-header, #editor-actions, #be-toolbar, .be-clip', root).forEach(function(n){ if (n && n.parentNode) n.parentNode.removeChild(n); });
    selAll('.be-label, .be-block-toolbar', root).forEach(function(n){ if (n && n.parentNode) n.parentNode.removeChild(n); });
    selAll('[contenteditable]', root).forEach(function(n){ try { n.removeAttribute('contenteditable'); } catch(e){} });
    selAll('[data-editable]', root).forEach(function(n){ try { n.removeAttribute('data-editable'); } catch(e){} });
    selAll('script', root).forEach(function(s){ if (s && s.parentNode) s.parentNode.removeChild(s); });
  }
  function buildExportHtml(bodyInner){
    var styles = collectInlineStyles();
    var head = '<meta charset="utf-8">\n'
      + '<meta name="viewport" content="width=device-width,initial-scale=1">\n'
      + (styles ? '<style>\n' + styles.replace(/<\/style>/gi,'</st'+'yle>') + '\n</style>\n' : '');
    return '<!DOCTYPE html>\n<html lang="en">\n<head>\n' + head + '</head>\n<body>\n' + bodyInner + '\n</body>\n</html>';
  }
  function cloneForExport(){
    var preview = byId('preview'); if (!preview) return '';
    var clone = preview.cloneNode(true); clone.id = 'preview-export'; stripEditorArtifacts(clone);
    selAll('table[role="presentation"], table.container', clone).forEach(function(tb){
      tb.setAttribute('align','center');
      var st = tb.getAttribute('style') || '';
      if (st.indexOf('margin-left:auto') === -1) st = (st ? st + ';' : '') + 'margin-left:auto;margin-right:auto';
      tb.setAttribute('style', st);
    });
    var html = (clone.innerHTML || '').trim();
    var trimmed = html;
    for (var i=0;i<3;i++){
      var tail = /(\s|&hairsp;|&#8202;|&#xfeff;|<div[^>]*>\s*<\/div>|<p[^>]*>\s*<\/p>|<pre[^>]*>\s*<\/pre>|<br\s*\/?>)\s*$/i;
      if (tail.test(trimmed)){ trimmed = trimmed.replace(tail, ''); } else { break; }
    }
    return trimmed || html;
  }
  function openExport(){
    var codeEl = byId('export-code'); var modal  = byId('export-modal');
    if (!codeEl || !modal) return;
    var bodyHtml = cloneForExport();
    if (!bodyHtml){ alert('Nothing to export'); return; }
    codeEl.textContent = buildExportHtml(bodyHtml);
    modal.style.display = 'block';
  }
  function closeExport(){ var modal  = byId('export-modal'); if (modal) modal.style.display = 'none'; }
  function bind(){
    var btn = byId('be-export');
    if (btn){
      var clone = btn.cloneNode(true);
      btn.parentNode.replaceChild(clone, btn);
      btn = clone;
      btn.addEventListener('click', function(ev){
        ev.preventDefault(); ev.stopPropagation(); ev.stopImmediatePropagation && ev.stopImmediatePropagation();
        openExport();
      }, false);
    }
    var closeBtn = byId('export-close'); if (closeBtn){ closeBtn.addEventListener('click', function(){ closeExport(); }, false); }
    var copyBtn = byId('export-copy');
    if (copyBtn){
      copyBtn.addEventListener('click', function(){
        var codeEl = byId('export-code'); var txt = codeEl ? codeEl.textContent : '';
        if (!txt) return;
        if (navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(txt).catch(function(){});
        } else {
          try{
            var blob = new Blob([txt], {type: 'text/html'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a'); a.href = url; a.download = 'email-export.html';
            document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
          }catch(e){}
        }
      }, false);
    }
  }
  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', bind, { once:true }); } else { bind(); }
})();
</script>
</body>
</html>
</div>
<div class="be-clip">Preview stops here. Sections below remain in the copied HTML.</div>
</div>
<div aria-label="Formatting" class="be-toolbar" id="be-toolbar" role="toolbar">
<button data-cmd="bold"><strong>B</strong></button>
<button data-cmd="italic"><em>I</em></button>
<button data-cmd="underline"><u>U</u></button>
<span class="be-sep"></span>
<button data-cmd="insertUnorderedList">• List</button>
<button data-cmd="insertOrderedList">1. List</button>
<span class="be-sep"></span>
<button data-cmd="formatBlock" data-value="H2">H2</button>
<button data-cmd="formatBlock" data-value="H3">H3</button>
<span class="be-sep"></span>
<button id="be-link">Link</button>
<button id="be-clear">Clear</button>
</div>
<script></script>
<script>
  window.onload = function() {
    parent.postMessage(document.body.scrollHeight, "*");
  };
</script>